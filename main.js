var Co=Object.defineProperty;var Lo=(n,e,t)=>e in n?Co(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var o=(n,e,t)=>(Lo(n,typeof e!="symbol"?e+"":e,t),t);import{Direction as H}from"@minecraft/server";import"@minecraft/server";import{system as Ms}from"@minecraft/server";import{BlockPermutation as Mo,world as Ro}from"@minecraft/server";import{world as Bo}from"@minecraft/server";import{Player as xn}from"@minecraft/server";import{system as Os}from"@minecraft/server";import{EquipmentSlot as qs}from"@minecraft/server";import{system as En}from"@minecraft/server";import{MinecraftDimensionTypes as Us,world as js}from"@minecraft/server";import{Player as Vo,system as Sn,world as Er}from"@minecraft/server";var _,P=(_=class{constructor(e,t){o(this,"r");o(this,"g");o(this,"b");this.code=e,this.color=t,t&&(this.r=t>>16&255,this.g=t>>8&255,this.b=t&255)}toString(){return _.PREFIX+this.code}toRGB(){return this.color}toHex(){return this.color?.toString(16)}getRed(){return this.r}getGreen(){return this.g}getBlue(){return this.b}getCode(){return this.code}static stripColor(e){return e.replace(/ยง[0-9a-u]/g,"")}static findClosestColor(e,t,r){let i=Number.MAX_VALUE,a=_.WHITE;for(let c of _.ALL_COLORS)if(c.r&&c.g&&c.b){let d=Math.sqrt(Math.pow(c.r-e,2)+Math.pow(c.g-t,2)+Math.pow(c.b-r,2));d<i&&(i=d,a=c)}return a}},o(_,"BLACK",new _("0",0)),o(_,"DARK_BLUE",new _("1",170)),o(_,"DARK_GREEN",new _("2",43520)),o(_,"DARK_AQUA",new _("3",43690)),o(_,"DARK_RED",new _("4",11141120)),o(_,"DARK_PURPLE",new _("5",11141290)),o(_,"GOLD",new _("6",16755200)),o(_,"GRAY",new _("7",11184810)),o(_,"DARK_GRAY",new _("8",5592405)),o(_,"BLUE",new _("9",5592575)),o(_,"GREEN",new _("a",5635925)),o(_,"AQUA",new _("b",5636095)),o(_,"RED",new _("c",16733525)),o(_,"LIGHT_PURPLE",new _("d",16733695)),o(_,"YELLOW",new _("e",16777045)),o(_,"WHITE",new _("f",16777215)),o(_,"MINECOIN_GOLD",new _("g",14603781)),o(_,"MATERIAL_QUARTZ",new _("h",14931153)),o(_,"MATERIAL_IRON",new _("i",13552330)),o(_,"MATERIAL_NETHERITE",new _("j",4471355)),o(_,"MATERIAL_REDSTONE",new _("m",9901575)),o(_,"MATERIAL_COPPER",new _("n",11823181)),o(_,"MATERIAL_GOLD",new _("p",14594349)),o(_,"MATERIAL_EMERALD",new _("q",1155126)),o(_,"MATERIAL_DIAMOND",new _("s",2931368)),o(_,"MATERIAL_LAPIS",new _("t",2181499)),o(_,"MATERIAL_AMETHYST",new _("u",10116294)),o(_,"OBFUSCATED",new _("k")),o(_,"BOLD",new _("l")),o(_,"ITALIC",new _("o")),o(_,"RESET",new _("r")),o(_,"VALUES",[_.BLACK,_.DARK_BLUE,_.DARK_GREEN,_.DARK_AQUA,_.DARK_RED,_.DARK_PURPLE,_.GOLD,_.GRAY,_.DARK_GRAY,_.BLUE,_.GREEN,_.AQUA,_.RED,_.LIGHT_PURPLE,_.YELLOW,_.WHITE,_.MINECOIN_GOLD,_.MATERIAL_QUARTZ,_.MATERIAL_IRON,_.MATERIAL_NETHERITE,_.MATERIAL_REDSTONE,_.MATERIAL_COPPER,_.MATERIAL_GOLD,_.MATERIAL_EMERALD,_.MATERIAL_DIAMOND,_.MATERIAL_LAPIS,_.MATERIAL_AMETHYST,_.OBFUSCATED,_.BOLD,_.ITALIC,_.RESET]),o(_,"ALL_COLORS",[_.BLACK,_.DARK_BLUE,_.DARK_GREEN,_.DARK_AQUA,_.DARK_RED,_.DARK_PURPLE,_.GOLD,_.GRAY,_.DARK_GRAY,_.BLUE,_.GREEN,_.AQUA,_.RED,_.LIGHT_PURPLE,_.YELLOW,_.WHITE,_.MINECOIN_GOLD,_.MATERIAL_QUARTZ,_.MATERIAL_IRON,_.MATERIAL_NETHERITE,_.MATERIAL_REDSTONE,_.MATERIAL_COPPER,_.MATERIAL_GOLD,_.MATERIAL_EMERALD,_.MATERIAL_DIAMOND,_.MATERIAL_LAPIS,_.MATERIAL_AMETHYST]),o(_,"PREFIX","\xA7"),_),Et,Ao=(Et=class{constructor(){o(this,"OpenObject","{");o(this,"CloseObject","}");o(this,"OpenArray","[");o(this,"CloseArray","]");o(this,"Comma",",");o(this,"KeyValueSeparator",":");o(this,"StringDelimiter",'"');o(this,"KeyDelimiter","");o(this,"Indent","  ");o(this,"NewLine",`
`);o(this,"Space"," ");o(this,"InlineThreshold",60);o(this,"MaxDepth",1);o(this,"IncludeClassNames",!0);o(this,"FunctionValue","\u0192");o(this,"NullValue","null");o(this,"UndefinedValue","undefined");o(this,"TrueValue","true");o(this,"FalseValue","false");o(this,"CycleValue","[...cycle...]");o(this,"TruncatedObjectValue","{...}");o(this,"OpenCloseObjectColor",P.YELLOW);o(this,"OpenCloseArrayColor",P.AQUA);o(this,"NumberColor",P.DARK_AQUA);o(this,"StringColor",P.DARK_GREEN);o(this,"BooleanColor",P.GOLD);o(this,"NullColor",P.GOLD);o(this,"KeyColor",P.GRAY);o(this,"EscapeColor",P.GOLD);o(this,"FunctionColor",P.GRAY);o(this,"ClassColor",P.GRAY);o(this,"ClassStyle",P.BOLD);o(this,"CycleColor",P.DARK_RED)}stringify(e){return this.stringifyValue(e)}stringifyString(e){return this.StringColor+this.StringDelimiter+this.escapeString(e)+this.StringDelimiter+P.RESET}stringifyNumber(e){return this.NumberColor+e.toString()+P.RESET}stringifyBoolean(e){return this.BooleanColor+(e?this.TrueValue:this.FalseValue)+P.RESET}stringifyFunction(e){return this.FunctionColor+this.FunctionValue+P.RESET}stringifyNull(){return this.NullColor+this.NullValue+P.RESET}stringifyUndefined(){return this.NullColor+this.UndefinedValue+P.RESET}stringifyCycle(){return this.CycleColor+this.CycleValue+P.RESET}stringifyArray(e,t=0){let r=this.Indent.repeat(t);if(e.length===0)return this.OpenCloseArrayColor+this.OpenArray+this.CloseArray+P.RESET;let i=this.OpenCloseArrayColor+this.OpenArray+P.RESET+this.NewLine,a=this.OpenCloseArrayColor+this.OpenArray+P.RESET;return e.forEach((c,d)=>{i+=r+this.Indent+this.stringifyValue(c,t+1),i+=d<e.length-1?this.Comma+this.NewLine:this.NewLine,a+=this.stringifyValue(c,t+1),a+=d<e.length-1?this.Comma+this.Space:""}),i+=r+this.OpenCloseArrayColor+this.CloseArray+P.RESET,a+=this.OpenCloseArrayColor+this.CloseArray+P.RESET,a.length<this.InlineThreshold?a:i}stringifyTruncatedObject(e,t,r=0){return(this.IncludeClassNames?this.ClassColor+""+this.ClassStyle+t+P.RESET+this.Space:"")+this.TruncatedObjectValue}stringifyObject(e,t,r,i=0){let a=this.Indent.repeat(i),c=this.IncludeClassNames&&t!=="Object"?this.ClassColor+""+this.ClassStyle+t+P.RESET+this.Space:"";if(r.length===0)return c+this.OpenCloseObjectColor+this.OpenObject+this.CloseObject+P.RESET;let d=c+this.OpenCloseObjectColor+this.OpenObject+P.RESET+this.NewLine,m=c+this.OpenCloseObjectColor+this.OpenObject+P.RESET;return r.forEach(([k,D],C)=>{let A=this.stringifyValue(D,i+1);d+=a+this.Indent+this.KeyColor+this.KeyDelimiter+k+this.KeyDelimiter+P.RESET+this.KeyValueSeparator+this.Space+A,d+=C<r.length-1?this.Comma+this.NewLine:this.NewLine,m+=this.KeyColor+k+P.RESET+this.KeyValueSeparator+this.Space+A,m+=C<r.length-1?this.Comma+this.Space:""}),d+=a+this.OpenCloseObjectColor+this.CloseObject+P.RESET,m+=this.OpenCloseObjectColor+this.CloseObject+P.RESET,m.length<this.InlineThreshold?m:d}shouldTruncateObject(e,t,r=0){return!(t==="Object"||r<=this.MaxDepth||this.MaxDepth<=0)}stringifyValue(e,t=0){if(e===null)return this.stringifyNull();if(e===void 0)return this.stringifyUndefined();if(typeof e=="number")return this.stringifyNumber(e);if(typeof e=="string")return this.stringifyString(e);if(typeof e=="boolean")return this.stringifyBoolean(e);if(typeof e=="function")return this.stringifyFunction(e);if(this.isCycle(e))return this.stringifyCycle();if(this.markCycle(e),Array.isArray(e)){let r=this.stringifyArray(e,t?t+1:0);return this.clearCycle(e),r}if(typeof e=="object"){let r=e.constructor.name;if(this.shouldTruncateObject(e,r,t)){let i=this.stringifyTruncatedObject(e,r,t);return this.clearCycle(e),i}else{let i=new Set,a=Object.getPrototypeOf(e),c=Object.keys(a);for(;c.length>0;)c.forEach(D=>i.add(D)),a=Object.getPrototypeOf(a),c=Object.keys(a);Object.keys(e).forEach(D=>i.add(D)),i.delete("__cycleDetection__");let m=[...i].sort().map(D=>{try{return[D,e[D]??void 0]}catch{return[D,void 0]}}).filter(([,D])=>typeof D!="function"&&D!==void 0),k=this.stringifyObject(e,r,m,t);return this.clearCycle(e),k}}return this.clearCycle(e),P.RESET+e.toString()}escapeString(e){return e.replace(/\\/g,this.EscapeColor+"\\\\"+this.StringColor).replace(/"/g,this.EscapeColor+'\\"'+this.StringColor).replace(/\n/g,this.EscapeColor+"\\n"+this.StringColor).replace(/\r/g,this.EscapeColor+"\\r"+this.StringColor).replace(/\t/g,this.EscapeColor+"\\t"+this.StringColor)}markCycle(e){e.__cycleDetection__=!0}isCycle(e){return!!e.__cycleDetection__}clearCycle(e){delete e.__cycleDetection__}},o(Et,"DEFAULT",new Et),Et),V,Ce=(V=class{constructor(e,t,r=P.RESET){this.level=e,this.name=t,this.color=r}toString(){return this.color+this.name.toUpperCase()+P.RESET}static parse(e){e=e.toLowerCase();for(let r of V.values)if(r.name===e)return r;let t=parseInt(e);if(!isNaN(t)){for(let r of V.values)if(r.level===t)return r}}},o(V,"All",new V(-2,"all")),o(V,"Trace",new V(-2,"trace",P.DARK_AQUA)),o(V,"Debug",new V(-1,"debug",P.AQUA)),o(V,"Info",new V(0,"info",P.GREEN)),o(V,"Warn",new V(1,"warn",P.GOLD)),o(V,"Error",new V(2,"error",P.RED)),o(V,"Fatal",new V(3,"fatal",P.DARK_RED)),o(V,"Off",new V(100,"off")),o(V,"values",[V.All,V.Trace,V.Debug,V.Info,V.Warn,V.Error,V.Fatal,V.Off]),V);var xt={level:Ce.Info,filter:["*"],formatFunction:(n,e,t)=>`[${n}][${P.MATERIAL_EMERALD}${e.name}${P.RESET}] ${t}`,messagesJoinFunction:n=>n.join(" "),jsonFormatter:Ao.DEFAULT,outputConfig:{[Ce.Trace.level]:[0,1],[Ce.Debug.level]:[0,1],[Ce.Info.level]:[0,1],[Ce.Warn.level]:[0,1,2],[Ce.Error.level]:[0,1,3],[Ce.Fatal.level]:[0,1,3]}},St,x=(St=class{constructor(e,t=[]){this.name=e,this.tags=t}static init(){}static setLevel(e){xt.level=e}static setFilter(e){xt.filter=e}static setFormatFunction(e){xt.formatFunction=e}static setMessagesJoinFunction(e){xt.messagesJoinFunction=e}static setJsonFormatter(e){xt.jsonFormatter=e}static getOutputConfig(){return xt.outputConfig}static getLogger(e,...t){return new St(e,t)}log(e,...t){}logRaw(e,...t){}trace(...e){}debug(...e){}info(...e){}warn(...e){}error(...e){}fatal(...e){}},o(St,"initialized",!1),St),g,l=(g=class{constructor(e,t,r){o(this,"x");o(this,"y");o(this,"z");if(e===H.Down)this.x=0,this.y=-1,this.z=0;else if(e===H.Up)this.x=0,this.y=1,this.z=0;else if(e===H.North)this.x=0,this.y=0,this.z=1;else if(e===H.South)this.x=0,this.y=0,this.z=-1;else if(e===H.East)this.x=1,this.y=0,this.z=0;else if(e===H.West)this.x=-1,this.y=0,this.z=0;else if(typeof e=="number")this.x=e,this.y=t,this.z=r;else if(Array.isArray(e))this.x=e[0],this.y=e[1],this.z=e[2];else if(e instanceof g)this.x=e.x,this.y=e.y,this.z=e.z;else{if(!e||!e.x&&e.x!==0||!e.y&&e.y!==0||!e.z&&e.z!==0)throw g.log.error(new Error("Invalid vector"),e),new Error("Invalid vector");this.x=e.x,this.y=e.y,this.z=e.z}}static from(e,t,r){if(e instanceof g)return e;if(typeof e=="number"&&t!==void 0&&r!==void 0)return new g(e,t,r);if(Array.isArray(e))return new g(e);if(e===H.Down)return g.Down;if(e===H.Up)return g.Up;if(e===H.North)return g.North;if(e===H.South)return g.South;if(e===H.East)return g.East;if(e===H.West)return g.West;if(!e||!e.x&&e.x!==0||!e.y&&e.y!==0||!e.z&&e.z!==0)throw g.log.error(new Error("Invalid arguments"),e,t,r),new Error("Invalid arguments");return new g(e.x,e.y,e.z)}static _from(e,t,r){if(e instanceof g)return e;if(typeof e=="number"&&t!==void 0&&r!==void 0)return new g(e,t,r);if(Array.isArray(e))return new g(e);if(e===H.Down)return g.Down;if(e===H.Up)return g.Up;if(e===H.North)return g.North;if(e===H.South)return g.South;if(e===H.East)return g.East;if(e===H.West)return g.West;if(!e||!e.x&&e.x!==0||!e.y&&e.y!==0||!e.z&&e.z!==0)throw g.log.error(new Error("Invalid arguments"),e,t,r),new Error("Invalid arguments");return new g(e.x,e.y,e.z)}copy(){return g.from(this)}static fromYawPitch(e,t){let r;typeof e=="number"?(r=e,t=t):(r=e.y,t=e.x);let i=r*(Math.PI/180),a=t*(Math.PI/180),c=Math.cos(a)*Math.sin(i),d=Math.sin(a),m=Math.cos(a)*Math.cos(i);return new g(c,d,m)}add(e,t,r){let i=g._from(e,t,r);return g.from(i.x+this.x,i.y+this.y,i.z+this.z)}subtract(e,t,r){let i=g._from(e,t,r);return g.from(this.x-i.x,this.y-i.y,this.z-i.z)}multiply(e,t,r){if(typeof e=="number"&&t===void 0&&r===void 0)return g.from(this.x*e,this.y*e,this.z*e);let i=g._from(e,t,r);return g.from(i.x*this.x,i.y*this.y,i.z*this.z)}scale(e){return g.from(this.x*e,this.y*e,this.z*e)}divide(e,t,r){if(typeof e=="number"&&t===void 0&&r===void 0){if(e===0)throw new Error("Cannot divide by zero");return g.from(this.x/e,this.y/e,this.z/e)}let i=g._from(e,t,r);if(i.x===0||i.y===0||i.z===0)throw new Error("Cannot divide by zero");return g.from(this.x/i.x,this.y/i.y,this.z/i.z)}normalize(){if(this.isZero())throw g.log.error(new Error("Cannot normalize zero-length vector")),new Error("Cannot normalize zero-length vector");let e=this.length();return g.from(this.x/e,this.y/e,this.z/e)}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}cross(e,t,r){let i=g._from(e,t,r);return g.from(this.y*i.z-this.z*i.y,this.z*i.x-this.x*i.z,this.x*i.y-this.y*i.x)}distance(e,t,r){let i=g._from(e,t,r);return Math.sqrt(this.distanceSquared(i))}distanceSquared(e,t,r){let i=g._from(e,t,r);return this.subtract(i).lengthSquared()}lerp(e,t){return!e||!t?g.from(this):t===1?g.from(e):t===0?g.from(this):g.from(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t,this.z+(e.z-this.z)*t)}slerp(e,t){if(!e||!t)return g.from(this);if(t===1)return g.from(e);if(t===0)return g.from(this);let r=this.dot(e),i=Math.acos(r)*t,a=g.from(e).subtract(this.multiply(r)).normalize();return this.multiply(Math.cos(i)).add(a.multiply(Math.sin(i)))}dot(e,t,r){let i=g._from(e,t,r);return this.x*i.x+this.y*i.y+this.z*i.z}angleBetween(e,t,r){let i=g._from(e,t,r),a=this.dot(i),c=this.length()*i.length();return c===0?0:Math.acos(a/c)}projectOnto(e,t,r){let i=g._from(e,t,r);if(i.isZero())return g.Zero;let a=this.dot(i)/i.dot(i);return g.from(i.x*a,i.y*a,i.z*a)}reflect(e,t,r){let i=g._from(e,t,r),a=this.projectOnto(i);return this.subtract(a.multiply(2))}rotate(e,t){let r=t*Math.PI/180/2,i=Math.cos(r),a=e.x*Math.sin(r),c=e.y*Math.sin(r),d=e.z*Math.sin(r),m=this,k=i*i*m.x+2*c*i*m.z-2*d*i*m.y+a*a*m.x+2*c*a*m.y+2*d*a*m.z-d*d*m.x-c*c*m.x,D=2*a*c*m.x+c*c*m.y+2*d*c*m.z+2*i*d*m.x-d*d*m.y+i*i*m.y-2*a*i*m.z-a*a*m.y,C=2*a*d*m.x+2*c*d*m.y+d*d*m.z-2*i*c*m.x-c*c*m.z+2*i*a*m.y-a*a*m.z+i*i*m.z;return new g(k,D,C)}setX(e){return new g(e,this.y,this.z)}setY(e){return new g(this.x,e,this.z)}setZ(e){return new g(this.x,this.y,e)}distanceToLineSegment(e,t){let r=g.from(t).subtract(e);if(r.lengthSquared()===0)return this.subtract(e).length();let i=Math.max(0,Math.min(1,this.subtract(e).dot(r)/r.dot(r))),a=g.from(e).add(r.multiply(i));return this.subtract(a).length()}floor(){return new g(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}floorX(){return new g(Math.floor(this.x),this.y,this.z)}floorY(){return new g(this.x,Math.floor(this.y),this.z)}floorZ(){return new g(this.x,this.y,Math.floor(this.z))}ceil(){return new g(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}ceilX(){return new g(Math.ceil(this.x),this.y,this.z)}ceilY(){return new g(this.x,Math.ceil(this.y),this.z)}ceilZ(){return new g(this.x,this.y,Math.ceil(this.z))}round(){return new g(Math.round(this.x),Math.round(this.y),Math.round(this.z))}roundX(){return new g(Math.round(this.x),this.y,this.z)}roundY(){return new g(this.x,Math.round(this.y),this.z)}roundZ(){return new g(this.x,this.y,Math.round(this.z))}up(){return this.add(g.Up)}down(){return this.add(g.Down)}north(){return this.add(g.North)}south(){return this.add(g.South)}east(){return this.add(g.East)}west(){return this.add(g.West)}isZero(){return this.x===0&&this.y===0&&this.z===0}toArray(){return[this.x,this.y,this.z]}toDirection(){if(this.isZero())throw g.log.error(new Error("Cannot convert zero-length vector to direction")),new Error("Cannot convert zero-length vector to direction");let e=this.normalize(),t=Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z));if(t===e.x)return H.East;if(t===-e.x)return H.West;if(t===e.y)return H.Up;if(t===-e.y)return H.Down;if(t===e.z)return H.North;if(t===-e.z)return H.South;throw g.log.error(new Error("Cannot convert vector to direction"),this),new Error("Cannot convert vector to direction")}toBlockLocation(){return g.from((this.x<<0)-(this.x<0&&this.x!==this.x<<0?1:0),(this.y<<0)-(this.y<0&&this.y!==this.y<<0?1:0),(this.z<<0)-(this.z<0&&this.z!==this.z<<0?1:0))}almostEqual(e,t,r,i){try{let a;return typeof e!="number"&&r===void 0?(a=g._from(e,void 0,void 0),i=t):a=g._from(e,t,r),Math.abs(this.x-a.x)<=i&&Math.abs(this.y-a.y)<=i&&Math.abs(this.z-a.z)<=i}catch{return!1}}equals(e,t,r){try{let i=g._from(e,t,r);return this.x===i.x&&this.y===i.y&&this.z===i.z}catch{return!1}}toString(e="long",t=", "){let r=`${this.x+t+this.y+t+this.z}`;return e==="long"?`Vec3(${r})`:r}},o(g,"log",x.getLogger("vec3","vec3","bedrock-boost")),o(g,"Zero",new g(0,0,0)),o(g,"Down",new g(H.Down)),o(g,"Up",new g(H.Up)),o(g,"North",new g(H.North)),o(g,"South",new g(H.South)),o(g,"East",new g(H.East)),o(g,"West",new g(H.West)),g),je,Ls=(je=class{static begin(e){this.end(),this.lastTime=new Date().getTime(),this.lastOperation=e}static end(){let e=new Date().getTime();this.lastTime>0&&je.log.debug(`Operation ${this.lastOperation} took ${e-this.lastTime}ms`),this.lastTime=-1}},o(je,"log",x.getLogger("Timings","timings")),o(je,"lastTime",-1),o(je,"lastOperation",""),je);var ai={};var si={};function Tt(n){return ai[n]?ai[n]:ai[n]=Ro.getDimension(n)}function R(n,e){let t=`${n}:${JSON.stringify(e)}`;return si[t]?si[t]:si[t]=Mo.resolve(n,e)}function zo(n,e){let{x:t,y:r,z:i}=e,a=n.getVelocity(),c=Math.sqrt(t*t+i*i),d=0,m=0;c!==0&&(d=t/c,m=i/c);let k=c*2.5,D=r+a.y*.9;n.applyKnockback(d,m,k,D)}function No(n){let{x:e,z:t}=n.getVelocity(),r=Math.sqrt(e*e+t*t),i=0,a=0;r!==0&&(i=-e/r,a=-t/r),n.applyKnockback(i,a,r,0)}function Oo(){xn.prototype.applyImpulse=function(n){zo(this,n)},xn.prototype.clearVelocity=function(){No(this)}}var li,Tn=(li=class{static installConsole(){this._installed.get("console")||(this._installed.set("console",!0),console.originalLog=console.log,console.log=(...n)=>{console.originalLog(...n);let e=n.join(" ");Bo.sendMessage(e)})}static installPlayer(){this._installed.get("player")||(this._installed.set("player",!0),Oo())}},o(li,"_installed",new Map),li),Gs=x.getLogger("jobUtils","bedrock-boost","jobUtils");var Hs=x.getLogger("itemUtils","bedrock-boost","itemUtils");var Ye,Go=(Ye=class{constructor(e,t){o(this,"items",[]);o(this,"period");o(this,"currentTick",0);o(this,"runId");o(this,"nextIndex",0);o(this,"executionSchedule",[]);o(this,"processor");if(t<=0)throw new Error("Period must be a positive integer.");if(!e||typeof e!="function")throw new Error("Processor function must be defined.");this.period=t,this.processor=e}add(e){this.push(e)}addAll(e){this.push(...e)}remove(e){e>=0&&e<this.items.length&&(this.items.splice(e,1),e<this.nextIndex&&this.nextIndex--,this.recalculateExecutionSchedule())}removeIf(e){for(let t=this.items.length-1;t>=0;t--)e(this.items[t])&&this.remove(t)}getItems(){return this.items}start(){this.stop(),this.currentTick=0,this.nextIndex=0,this.runId=En.runInterval(()=>this.tick(),1)}stop(){this.runId!==void 0&&(En.clearRun(this.runId),this.runId=void 0)}recalculateExecutionSchedule(){let e=this.items.length;if(this.executionSchedule=new Array(this.period).fill(0),e===0)return;let t=this.period/e;for(let r=0;r<e;r++)this.executionSchedule[Math.round(t*r)%this.period]++}tick(){if(this.items.length===0){Ye.log.trace("No items to process.");return}let e=this.executionSchedule[this.currentTick];if(e===0){Ye.log.trace("No items to process this tick."),this.currentTick=(this.currentTick+1)%this.period,this.currentTick===0&&(this.nextIndex=0);return}let t=0;for(;this.nextIndex<this.items.length&&t<e;this.nextIndex++){try{this.processor(this.items[this.nextIndex])}catch(r){Ye.log.error("Error processing item",r)}t++}this.currentTick=(this.currentTick+1)%this.period,this.currentTick===0&&(this.nextIndex=0)}push(...e){return this.items.push(...e),this.recalculateExecutionSchedule(),this.items.length}pop(){let e=this.items.pop();return this.recalculateExecutionSchedule(),e}shift(){let e=this.items.shift();return this.recalculateExecutionSchedule(),e}unshift(...e){return this.items.unshift(...e),this.recalculateExecutionSchedule(),this.items.length}splice(e,t=0,...r){let i=this.items.splice(e,t,...r);return this.recalculateExecutionSchedule(),i}},o(Ye,"log",x.getLogger("PulseScheduler","bedrock-boost","pulse-scheduler")),Ye);var at,qe=(at=class extends Go{constructor(e,t){super(r=>{r.isValid()?e(r):this.removeIf(i=>!i.isValid())},t),this.push(...Er.getAllPlayers())}compareEntities(e,t){return e.id===t.id}start(){Er.afterEvents.playerJoin.subscribe(e=>{let t=0,r=()=>{if(t++,t>10){at.logger.warn("Failed to push player to scheduler after 10 attempts.");return}try{let i=Er.getEntity(e.playerId);i===void 0&&Sn.runTimeout(r,1),i instanceof Vo&&this.push(i)}catch(i){at.logger.debug("Failed to push player to scheduler.",i),Sn.runTimeout(r,1)}};r()}),Er.afterEvents.playerLeave.subscribe(e=>{this.removeIf(t=>!t.isValid()||t.id===e.playerId)}),super.start()}push(...e){let t=e.filter(r=>r.isValid()&&!this.items.some(i=>this.compareEntities(i,r)));return super.push(...t)}unshift(...e){let t=e.filter(r=>r.isValid()&&!this.items.some(i=>this.compareEntities(i,r)));return super.unshift(...t)}splice(e,t,...r){if(t===void 0)return super.splice(e);let i=r.filter(a=>!this.items.some(c=>this.compareEntities(c,a)));return super.splice(e,t,...i)}},o(at,"logger",x.getLogger("PlayerPulseScheduler","bedrock-boost","player-pulse-scheduler")),at),Sr=(n=>(n.Movement="movement",n.Camera="camera",n))(Sr||{});var ci=class{static setInputPermission(n,e,t){n.runCommand(`inputpermission set @s ${e} ${t?"enabled":"disabled"}`)}static addCameraShake(n,e,t,r){n.runCommand(`camerashake add @s ${t} ${r} ${e}`)}static stopCameraShake(n){n.runCommand("camerashake stop @s")}};import{Block as be,Direction as ie,EntityDamageCause as Wa,GameMode as fo,system as yo,world as Xa}from"@minecraft/server";import{Direction as Fa,Entity as _o,EntityComponentTypes as $a,EntityDamageCause as Ua,EntityEquippableComponent as ja,EquipmentSlot as mr,GameMode as rt,MinecraftDimensionTypes as go,Player as Ya,TicksPerSecond as ei,system as ee,world as J}from"@minecraft/server";import{system as In}from"@minecraft/server";var fe=class{};o(fe,"IgnoreAttackRange","xp_cd:ignore_attack_range"),o(fe,"IgnoreStateChanges","xp_cd:ignore_state_changes"),o(fe,"IgnoreSpeedChanges","xp_cd:ignore_speed_changes");var ve=class{constructor(e){o(this,"listeners",[]);o(this,"intervals",[]);o(this,"intervalIds",[]);o(this,"_context",{});this._context=e}get context(){return this._context}onActivate(){}onDeactivate(){}registerListener(e,t,r=void 0){let i={subscribe:e.subscribe.bind(e),unsubscribe:e.unsubscribe.bind(e),eventHandler:t,data:r};this.listeners.push(i)}registerInterval(e,t){this.intervals.push({fn:e,interval:t})}activate(){this.onActivate(),this.listeners.forEach(e=>{try{e.unsubscribe(e.eventHandler)}catch{}e.data!==void 0?e.subscribe(e.eventHandler,e.data):e.subscribe(e.eventHandler)}),this.intervals.forEach(e=>{this.intervalIds.push(In.runInterval(e.fn,e.interval))})}deactivate(){this.onDeactivate(),this.listeners.forEach(e=>{try{e.unsubscribe(e.eventHandler)}catch{}}),this.intervalIds.forEach(e=>{In.clearRun(e)})}},Tr=new Map;function Yt(n,e){Tr.has(n)||Tr.set(n,[]),Tr.get(n).push(e)}function di(n){return Tr.get(n)||[]}function Pn(n,e){let t=qo(n,e);return n=n.filter(r=>!t.includes(r.stateId)),e=e.filter(r=>!t.includes(r.stateId)),{deactivateStates:n,activationStates:e}}function qo(n,e){let t=new Set(n.map(i=>i.stateId)),r=new Set(e.map(i=>i.stateId));return[...t].filter(i=>r.has(i))}import{EntityDamageCause as It,GameMode as An,Player as Mn,system as Le,TicksPerSecond as Fo,world as st}from"@minecraft/server";import"@minecraft/server";var al=x.getLogger("CliffDetect");function Ln(n){return Cn(n,3)||Cn(n,5,22.5)}function Ho(n,e,t=8,r){let i=[];for(let a=0;a<t;a++){let c=a/t*Math.PI*2+(r||0)*(Math.PI/180),d=n.x+Math.cos(c)*e,m=n.z+Math.sin(c)*e;i.push(l.from(d,n.y,m))}return i}function Cn(n,e,t=0){let r=l.from(n.location),i=Ho(r,e,8,t),a=n.dimension,c=0;for(let d of i){let m=a.getBlockFromRay(d,l.Down,{maxDistance:10,includePassableBlocks:!0,includeLiquidBlocks:!0});if(m===void 0){if(c++,c>=2)return!0}else if(m.block.typeId==="minecraft:lava")return!0}return!1}var Xt=class Xt{constructor(){o(this,"callbacks",[])}subscribe(e){return this.callbacks.push(e),e}unsubscribe(e){let t=this.callbacks.indexOf(e);t!==-1&&this.callbacks.splice(t,1)}trigger(e){Xt.log.trace(`Triggering event ${this.constructor.name}`),this.callbacks.forEach(t=>{try{t(e)}catch(r){Xt.log.error(`Error while triggering event ${this.constructor.name}`,r)}})}};o(Xt,"log",x.getLogger("EventSignal","event_signal"));var le=Xt,ce=class{constructor(e){o(this,"dweller");this.dweller=e}},ui=class extends ce{constructor(){super(...arguments);o(this,"cancel",!1)}},pi=class extends ce{constructor(t,r){super(t);o(this,"player");o(this,"distanceSquared");o(this,"isInAttackRange");this.player=r,this.distanceSquared=s.getDistanceSquared(r),this.isInAttackRange=s.isInAttackRange(r)}},mi=class extends le{},Pr=class Pr extends mi{constructor(){super();o(this,"runId")}subscribe(t,r){let i=super.subscribe(t);return this.callbacks.length===1&&(this.runId=Le.runInterval(this.run.bind(this,r),s.StareCheckRate)),i}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.runId!==void 0&&(Le.clearRun(this.runId),this.runId=void 0)}run(t){s.getStaringPlayers(void 0,t&&t.angleRange?t.angleRange:void 0).forEach(r=>{let i=s.getDweller();i&&this.trigger(new pi(i,r))})}};o(Pr,"instance",new Pr);var _i=Pr,hi=class extends ce{constructor(t,r){super(t);o(this,"players");this.players=r}},gi=class extends le{},Cr=class Cr extends gi{constructor(){super();o(this,"runId")}subscribe(t,r){let i=super.subscribe(t);return this.callbacks.length===1&&(this.runId=Le.runInterval(this.run.bind(this,r),s.StareCheckRate)),i}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.runId!==void 0&&(Le.clearRun(this.runId),this.runId=void 0)}run(t){let r;if(t&&t.angleRange!==void 0?r=s.getStaringPlayers(void 0,t.angleRange):r=s.getStaringPlayers(),r.length===0)return;let i=s.getDweller();i&&this.trigger(new hi(i,r))}};o(Cr,"instance",new Cr);var fi=Cr,yi=class extends ui{constructor(t,r){super(t);o(this,"entity");o(this,"damage");this.entity=r,this.damage=s.getDamageValue(r)}},bi=class extends le{},Lr=class Lr extends bi{constructor(){super(),st.afterEvents.entityHurt.subscribe(this.onHurt.bind(this))}onHurt(e){if(e.damageSource.damagingEntity&&e.damageSource.damagingEntity.typeId===s.DwellerTypeId&&e.damage===0){let t=e.hurtEntity,r=e.damageSource.damagingEntity,i=new yi(r,t);if(this.trigger(i),i.cancel)return;i.damage>0&&(t.applyDamage(i.damage,{cause:It.magic,damagingEntity:r}),t instanceof Mn&&t.setDynamicProperty("xp_cd:dweller_last_hit",Le.currentTick))}}};o(Lr,"instance",new Lr);var wi=Lr,vi=class extends ce{constructor(t,r,i){super(t);o(this,"previousState");o(this,"newState");this.previousState=r,this.newState=i}},ki=class extends le{},Ar=class Ar extends ki{constructor(){super()}onStateChange(e,t,r){this.trigger(new vi(e,t,r))}};o(Ar,"instance",new Ar);var Di=Ar,xi=class extends ce{constructor(t,r){super(t);o(this,"isNaturalDeath",!1);this.isNaturalDeath=r}},Ei=class extends le{},Mr=class Mr extends Ei{constructor(){super();o(this,"entityDieCallback")}subscribe(t){let r=super.subscribe(t);return this.callbacks.length===1&&(this.entityDieCallback=st.afterEvents.entityDie.subscribe(this.onEntityDeath.bind(this))),r}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.entityDieCallback!==void 0&&(st.afterEvents.entityDie.unsubscribe(this.entityDieCallback),this.entityDieCallback=void 0)}onEntityDeath(t){if(t.deadEntity.typeId!==s.DwellerTypeId)return;let r=t.damageSource.cause===It.void||t.damageSource.cause===It.override||t.damageSource.cause===It.none||t.damageSource.cause===It.selfDestruct||t.damageSource.cause===It.suicide;this.trigger(new xi(t.deadEntity,r))}};o(Mr,"instance",new Mr);var Si=Mr,Ti=class extends ce{constructor(t,r){super(t);o(this,"foodItems");this.foodItems=r}},Ii=class extends le{},Rr=class Rr extends Ii{constructor(){super()}consumeFood(e,t){this.trigger(new Ti(e,t))}};o(Rr,"instance",new Rr);var Pi=Rr,Ci=class extends ce{constructor(e){super(e)}},Li=class extends le{},Br=class Br extends Li{constructor(){super()}aggroMeterFilled(e){this.trigger(new Ci(e))}};o(Br,"instance",new Br);var Ai=Br,Mi=class extends ce{constructor(t,r){super(t);o(this,"damage");o(this,"cause");o(this,"damager");this.damage=r.damage,this.cause=r.damageSource.cause,this.damager=r.damageSource.damagingEntity&&r.damageSource.damagingEntity instanceof Mn?r.damageSource.damagingEntity:void 0}},Ri=class extends le{},zr=class zr extends Ri{constructor(){super();o(this,"entityHurtCallback")}subscribe(t){let r=super.subscribe(t);return this.callbacks.length===1&&(this.entityHurtCallback=st.afterEvents.entityHurt.subscribe(this.onEntityHurt.bind(this))),r}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.entityHurtCallback!==void 0&&(st.afterEvents.entityHurt.unsubscribe(this.entityHurtCallback),this.entityHurtCallback=void 0)}onEntityHurt(t){t.hurtEntity.typeId===s.DwellerTypeId&&this.trigger(new Mi(t.hurtEntity,t))}};o(zr,"instance",new zr);var Bi=zr,zi=class extends ce{constructor(t,r=!1){super(t);o(this,"spawnedOnCeiling");this.spawnedOnCeiling=r}},Ni=class extends le{},Nr=class Nr extends Ni{constructor(){super()}spawn(e,t=!1){this.trigger(new zi(e,t))}};o(Nr,"instance",new Nr);var Oi=Nr,Gi=class extends ce{constructor(t,r){super(t);o(this,"target");this.target=r}},Vi=class extends le{},Or=class Or extends Vi{constructor(){super()}spawnAttempt(e){this.trigger(new Gi(e,e))}};o(Or,"instance",new Or);var qi=Or,Wt=class extends ce{constructor(t,r,i){super(t);o(this,"player");o(this,"isDead");this.player=r,this.isDead=i}},Hi=class extends le{},Gr=class Gr extends Hi{constructor(){super();o(this,"damageCooldown",1.5*Fo);o(this,"entityDieCallback")}subscribe(t){let r=super.subscribe(t);return this.callbacks.length===1&&(this.entityDieCallback=st.afterEvents.entityDie.subscribe(this.onPlayerDeath.bind(this),{entityTypes:["minecraft:player"]})),r}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.entityDieCallback!==void 0&&(st.afterEvents.entityDie.unsubscribe(this.entityDieCallback),this.entityDieCallback=void 0)}onPlayerDeath(t){let r=t.damageSource.damagingEntity;if(r&&r.typeId===s.DwellerTypeId){this.trigger(new Wt(r,t.deadEntity,!0));return}else{let i=s.getDweller(!0);if(i===void 0)return;let a=t.deadEntity.getDynamicProperty("xp_cd:dweller_last_hit");a&&Le.currentTick-a<this.damageCooldown&&this.trigger(new Wt(i,t.deadEntity,!0))}}kill(t,r){this.trigger(new Wt(t,r,!1))}};o(Gr,"instance",new Gr);var Fi=Gr,$i=class extends ce{constructor(t,r){super(t);o(this,"players");this.players=r}},Ui=class extends le{},Vr=class Vr extends Ui{constructor(){super();o(this,"runId")}subscribe(t,r){let i=super.subscribe(t);return this.callbacks.length===1&&(this.runId=Le.runInterval(this.run.bind(this,r),5)),i}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.runId!==void 0&&(Le.clearRun(this.runId),this.runId=void 0)}run(t){let r=s.getDweller();if(!r)return;let i=r.dimension.getPlayers({location:r.location,maxDistance:t&&t.customRange?t.customRange:s.attackRange,excludeGameModes:[An.creative,An.spectator]});i.length!==0&&this.trigger(new $i(r,i.sort((a,c)=>l.from(a.location).distanceSquared(r.location)-l.from(c.location).distanceSquared(r.location))))}};o(Vr,"instance",new Vr);var ji=Vr,Yi=class extends ce{constructor(t,r){super(t);o(this,"players");this.players=r}},Wi=class extends le{},qr=class qr extends Wi{constructor(){super();o(this,"runId")}subscribe(t){let r=super.subscribe(t);return this.callbacks.length===1&&(this.runId=Le.runInterval(this.run.bind(this),5)),r}unsubscribe(t){super.unsubscribe(t),this.callbacks.length===0&&this.runId!==void 0&&(Le.clearRun(this.runId),this.runId=void 0)}run(){let t=s.getDweller();if(!t)return;let r=t.dimension.getPlayers({location:t.location,maxDistance:48}).filter(i=>i.isInWater||Ln(i));r.length!==0&&this.trigger(new Yi(t,r))}};o(qr,"instance",new qr);var Xi=qr,Hr=class Hr{constructor(){o(this,"staredAt",_i.instance);o(this,"staredAtGroup",fi.instance);o(this,"attack",wi.instance);o(this,"stateChange",Di.instance);o(this,"die",Si.instance);o(this,"consumeFood",Pi.instance);o(this,"aggroMeterFull",Ai.instance);o(this,"hurt",Bi.instance);o(this,"spawn",Oi.instance);o(this,"spawnAttempt",qi.instance);o(this,"killedPlayer",Fi.instance);o(this,"inRange",ji.instance);o(this,"areNearbyPlayersNearHazard",Xi.instance)}};o(Hr,"instance",new Hr);var Ir=Hr;import"@minecraft/server";import{system as Fr,TicksPerSecond as Rn,world as Kt}from"@minecraft/server";import{world as We}from"@minecraft/server";var ue=class ue{constructor(e){o(this,"id");o(this,"counters",[]);o(this,"listeners",[]);this.id=e}isLearned(){return!!We.getDynamicProperty(ue.SKILL_PREFIX+this.id)}setLearned(e){this.isLearned()!==e&&(ue.log.info(`Setting learned state for ${P.AQUA+this.id+P.GRAY} to ${e?P.GREEN+"learned":P.RED+"not learned"}`),We.setDynamicProperty(ue.SKILL_PREFIX+this.id,e),We.setDynamicProperty(ue.SKILL_NEXT_PREFIX+this.id,e),e||this.counters.forEach(t=>{this.resetCounter(t)}),this.updateListeners())}setLearnedOnNextSpawn(e){We.setDynamicProperty(ue.SKILL_NEXT_PREFIX+this.id,e)}init(){this.updateListeners()}setupEntity(e){}preSetupEntity(e){let t=We.getDynamicProperty(ue.SKILL_NEXT_PREFIX+this.id),r=We.getDynamicProperty(ue.SKILL_PREFIX+this.id);t!==void 0&&t!==r&&this.setLearned(t)}registerCounter(e){this.counters.push(e)}getCounter(e){return We.getDynamicProperty(e)||0}setCounter(e,t){We.setDynamicProperty(e,t)}incrementCounter(e){let t=this.getCounter(e)||0;return this.setCounter(e,t+1),t+1}resetCounter(e){this.setCounter(e,0)}registerListener(e,t,r){let i={subscribe:e.subscribe.bind(e),unsubscribe:e.unsubscribe.bind(e),eventHandler:t,condition:r,subscribed:!1};this.listeners.push(i)}updateListeners(){this.listeners.forEach(e=>{if(e.condition){let t=e.condition(this);!t&&e.subscribed?(e.unsubscribe(e.eventHandler),e.subscribed=!1):t&&!e.subscribed&&(e.subscribe(e.eventHandler),e.subscribed=!0)}else e.subscribed||(e.subscribe(e.eventHandler),e.subscribed=!0)})}};o(ue,"log",x.getLogger("Learnable")),o(ue,"SKILL_PREFIX","xp_cd:skill_"),o(ue,"SKILL_NEXT_PREFIX","xp_cd:next_skill_"),o(ue,"SkillLearnedCondition",e=>e.isLearned()),o(ue,"SkillNotLearnedCondition",e=>!e.isLearned());var U=ue;var $o="xp_cd:encounter_counter",Bn=x.getLogger("DoorBuster"),Uo=[{id:"minecraft:wooden_door",sound:"random.door_open"},{id:"minecraft:spruce_door",sound:"random.door_open"},{id:"minecraft:birch_door",sound:"random.door_open"},{id:"minecraft:jungle_door",sound:"random.door_open"},{id:"minecraft:acacia_door",sound:"random.door_open"},{id:"minecraft:dark_oak_door",sound:"random.door_open"},{id:"minecraft:mangrove_door",sound:"random.door_open"},{id:"minecraft:cherry_door",sound:"random.door_open"},{id:"minecraft:bamboo_door",sound:"random.door_open"},{id:"minecraft:crimson_door",sound:"random.door_open"},{id:"minecraft:warped_door",sound:"random.door_open"},{id:"minecraft:copper_door",sound:"open_door.copper"},{id:"minecraft:exposed_copper_door",sound:"open_door.copper"},{id:"minecraft:weathered_copper_door",sound:"open_door.copper"},{id:"minecraft:oxidized_copper_door",sound:"open_door.copper"},{id:"minecraft:waxed_copper_door",sound:"open_door.copper"},{id:"minecraft:waxed_exposed_copper_door",sound:"open_door.copper"},{id:"minecraft:waxed_weathered_copper_door",sound:"open_door.copper"},{id:"minecraft:waxed_oxidized_copper_door",sound:"open_door.copper"}],lt=class lt extends U{constructor(){super(lt.ID);o(this,"hasLearned",!1);o(this,"runId");o(this,"onRemoveCallback");o(this,"mDweller");o(this,"cooldown",2);o(this,"cooldownEnd",0);o(this,"interval",.5)}setLearned(t){super.setLearned(t),t||Kt.setDynamicProperty($o,0)}setupEntity(t){this.runId===void 0&&(this.runId=Fr.runInterval(this.intervalCheck.bind(this),this.interval*Rn)),this.onRemoveCallback===void 0&&(this.onRemoveCallback=Kt.afterEvents.entityRemove.subscribe(this.removeCallback.bind(this),{entityTypes:[s.DwellerTypeId]})),this.mDweller=t,this.hasLearned=!1}intervalCheck(){if(Fr.currentTick<this.cooldownEnd)return;let t=this.mDweller;if(t===void 0)return t=s.getDweller()??void 0,void 0;let r;try{r=l.from(t.location)}catch(c){Bn.warn("Failed to get dweller location",c);return}let i=[r.add(l.from(1,0,-1)),r.add(l.from(1,0,0)),r.add(l.from(1,0,1)),r.add(l.from(0,0,-1)),r,r.add(l.from(0,0,1)),r.add(l.from(-1,0,-1)),r.add(l.from(-1,0,0)),r.add(l.from(-1,0,1))],a=jo(i);if(a!==void 0){if(this.isLearned())Yo(a.door,a.sound),this.cooldownEnd=Fr.currentTick+this.cooldown*Rn;else if(this.hasLearned===!1){let c=Kt.getDynamicProperty(lt.DoorCounterProperty)||0;c++,Kt.setDynamicProperty(lt.DoorCounterProperty,c),c>=1&&this.setLearnedOnNextSpawn(!0)}}}removeCallback(){this.runId!==void 0&&(Fr.clearRun(this.runId),this.runId=void 0),this.onRemoveCallback!==void 0&&(Kt.afterEvents.entityRemove.unsubscribe(this.onRemoveCallback),this.onRemoveCallback=void 0)}};o(lt,"ID","door_buster"),o(lt,"DoorCounterProperty","xp_cd:door_counter");var Jt=lt;function jo(n){for(let e of n){let t;try{t=s.dimension.getBlock(e)}catch(i){Bn.warn("Failed to get block",i);continue}if(t===void 0)continue;let r=Uo.find(i=>i.id===t.typeId);if(r!==void 0)return{door:t,sound:r.sound}}}function Yo(n,e){let t=n.permutation.getState("upper_block_bit"),r=n;t&&(r=r.below()??r);let i=r.permutation.getState("open_bit"),a=r.permutation.getAllStates();a.open_bit=!i,r.setPermutation(R(r.typeId,a)),e&&n.dimension.playSound(e,n.location)}import{system as ut,world as Qt}from"@minecraft/server";import{system as na,world as Ur}from"@minecraft/server";import{Direction as $r,MinecraftDimensionTypes as Wo}from"@minecraft/server";var ct=x.getLogger("environment_scanner","environment_scanner"),Xo=["minecraft:stone","minecraft:gravel","minecraft:andesite","minecraft:diorite","minecraft:granite","minecraft:deepslate","minecraft:tuff","minecraft:deepslate_coal_ore","minecraft:coal_ore","minecraft:deepslate_copper_ore","minecraft:copper_ore","minecraft:deepslate_iron_ore","minecraft:iron_ore","minecraft:deepslate_gold_ore","minecraft:gold_ore","minecraft:deepslate_lapis_ore","minecraft:lapis_ore","minecraft:deepslate_redstone_ore","minecraft:redstone_ore","minecraft:lit_deepslate_redstone_ore","minecraft:lit_redstone_ore","minecraft:deepslate_diamond_ore","minecraft:diamond_ore","minecraft:deepslate_emerald_ore","minecraft:emerald_ore","minecraft:raw_copper_block","minecraft:raw_iron_block","minecraft:raw_gold_block","minecraft:obsidian","minecraft:cobblestone","minecraft:cobbled_deepslate"],Ko=["minecraft:leaves","minecraft:leaves2","minecraft:grass","minecraft:sand","minecraft:sandstone","minecraft:vine","minecraft:tallgrass","minecraft:double_plant"];function Jo(n){let e=l.from(n.location),t=n.dimension,r;try{r=t.getBlock(l.from(n.location).add(l.from(0,1.5,0)))}catch(d){return ct.debug(`${n.name} caused an error(1): ${d}`),"Unknown"}if(r?.isLiquid)return"Water";if(e.y<50)return"Cave";let i=[];for(let d=0;d<89;d+=15)for(let m=0;m<360;m+=22.5){let k=l.fromYawPitch(m,d),D;try{D=t.getBlockFromRay(e,k,{includeLiquidBlocks:!0,maxDistance:80})}catch(C){return ct.debug(`${n.name} caused an error(2): ${C}`),"Unknown"}if(D)try{D.block.isAir}catch{i.push({block:void 0,distanceSquared:-1,direction:k,rayHit:!1});continue}D&&!D.block.isAir?i.push({block:D.block,distanceSquared:e.distanceSquared(D.block.location),direction:k,rayHit:!0}):i.push({block:void 0,distanceSquared:-1,direction:k,rayHit:!1})}let a=l.from(0,1,0),c;try{c=t.getBlockFromRay(e,a,{includeLiquidBlocks:!0,maxDistance:16})}catch(d){return ct.debug(`${n.name} caused an error(3): ${d}`),"Unknown"}return c&&!c.block.isAir?i.push({block:c.block,distanceSquared:e.distanceSquared(c.block.location),direction:a,rayHit:!0}):i.push({block:void 0,distanceSquared:-1,direction:a,rayHit:!1}),Qo(e,i)}var Zo=64;function Qo(n,e){let t=n.y<60?35:0,r=n.y>=60?35:0,i=n.y>90?35:0;for(let a of e){let c=Math.abs(a.direction.y)>0&&Math.abs(a.direction.y)<.5;if(!a.rayHit){r+=2;continue}let d=a.distanceSquared<=Zo,m=a.block;m&&(Xo.includes(m.typeId)&&(t+=1),Ko.includes(m.typeId)&&(r+=1)),c?(t++,d&&(i++,t++)):(t++,d&&(i++,t--))}return ct.trace(`cavePoints: ${t}`),ct.trace(`roomPoints: ${i}`),ct.trace(`outsidePoints: ${r}`),t>i&&t>r?(ct.info("Cave"),"Cave"):i>t&&i>r?"Room":"Outside"}function Ae(n){return Jo(n)}function zn(n){let e=l.from(n.location);if(e.y>50)return{inStripMine:!1};let t=n.dimension,r;try{r=t.getBlock(l.from(n.location).add(l.from(0,2.5,0)))}catch{return{inStripMine:!1}}if(!r||r.isLiquid||r.isAir)return{inStripMine:!1};let i=1,a=1,c=1,d=1,m=n.getViewDirection();Math.abs(m.x)>Math.abs(m.z)?m.x>0?c=4:d=4:m.z>0?i=4:a=4;let k={North:t.getBlockFromRay(e,l.from($r.North),{maxDistance:2*i,includePassableBlocks:!1}),South:t.getBlockFromRay(e,l.from($r.South),{maxDistance:2*a,includePassableBlocks:!1}),East:t.getBlockFromRay(e,l.from($r.East),{maxDistance:2*c,includePassableBlocks:!1}),West:t.getBlockFromRay(e,l.from($r.West),{maxDistance:2*d,includePassableBlocks:!1})},D=0,C;for(let A in k)k[A]!==void 0?D++:C=A;return D===3?{inStripMine:!0,direction:l.from(C)}:{inStripMine:!1}}var ea=["minecraft:rail"],ta=["minecraft:web","minecraft:oak_planks","minecraft:oak_fence","minecraft:chain"],ra=["minecraft:torch","minecraft:chest"],ia=["minecraft:stone_bricks","minecraft:cracked_stone_bricks","minecraft:mossy_stone_bricks","minecraft:smooth_stone_double_slab","minecraft:iron_bars","minecraft:bookshelf"];function Nn(n,e){return{inMineshaft:!1,confidence:100}}var Zt=[],dt=[],Xe=class Xe{static init(){Ur.getPlayers().forEach(e=>Xe.load(e)),Ur.afterEvents.playerJoin.subscribe(e=>{na.runTimeout(()=>{Xe.load(Ur.getEntity(e.playerId))},1)}),this.playerUpdater=new qe(this.update.bind(this),20),this.playerUpdater.start()}static update(e){if(Ae(e)==="Room"){let r=l.from(e.location),i=dt.filter(c=>c.playerId===e.id&&c.location.distanceSquared(r)<100),a=Zt.filter(c=>c.playerId===e.id&&c.location.distanceSquared(r)<100);if(i.length===0&&a.length===0)Zt.push({playerId:e.id,location:r,seenCounter:0});else if(i.length===0&&a.length>0){let c=a[0];c.seenCounter++,c.seenCounter>=10&&(this.log.info(`Player ${e.name} has a base at ${r}`),dt.push(c),Zt.splice(Zt.indexOf(c),1),Xe.save(e))}}}static save(e){let r=dt.filter(i=>i.playerId===e.id).map(i=>i.location.x+","+i.location.y+","+i.location.z).join(";");e.setDynamicProperty("xp_cd:player_bases",r)}static saveAll(){for(let e of Ur.getPlayers())Xe.save(e)}static load(e){let t=e.getDynamicProperty("xp_cd:player_bases");if(!t)return;let r=t.split(";");for(let i of r){let a=l.from(i.split(",").map(parseFloat)),c={playerId:e.id,location:a,seenCounter:0};dt.push(c)}}static getNearestBase(e,t){let r,i=1/0;for(let a of dt){if(a.playerId!==e.id)continue;let c=a.location.distanceSquared(t);c<i&&(r=a,i=c)}return r?.location}static removeBase(e){let t=dt.findIndex(r=>r.location.almostEqual(e,1));t!==-1&&(dt.splice(t,1),Zt.splice(t,1))}};o(Xe,"log",x.getLogger("player_base_tracker","player_base_tracker")),o(Xe,"playerUpdater");var He=Xe;var b={wood:{duration:8,animationVisible:!0,sound:"wood"},fence:{duration:7,animationVisible:!1,sound:"wood"},iron:{duration:30,animationVisible:!1,sound:"stone"},glass:{duration:7,animationVisible:!0,sound:"stone"},glass_pane:{duration:5,animationVisible:!0,sound:"stone"},dirt:{duration:7,animationVisible:!0,sound:"dirt"},sand:{duration:7,animationVisible:!0,sound:"sand"},stone:{duration:10,animationVisible:!0,sound:"stone"}},oa={"minecraft:glass":b.glass,"minecraft:glass_pane":b.glass_pane,"minecraft:black_stained_glass":b.glass,"minecraft:black_stained_glass_pane":b.glass_pane,"minecraft:blue_stained_glass":b.glass,"minecraft:blue_stained_glass_pane":b.glass_pane,"minecraft:brown_stained_glass":b.glass,"minecraft:brown_stained_glass_pane":b.glass_pane,"minecraft:cyan_stained_glass":b.glass,"minecraft:cyan_stained_glass_pane":b.glass_pane,"minecraft:gray_stained_glass":b.glass,"minecraft:gray_stained_glass_pane":b.glass_pane,"minecraft:green_stained_glass":b.glass,"minecraft:green_stained_glass_pane":b.glass_pane,"minecraft:light_blue_stained_glass":b.glass,"minecraft:light_blue_stained_glass_pane":b.glass_pane,"minecraft:light_gray_stained_glass":b.glass,"minecraft:light_gray_stained_glass_pane":b.glass_pane,"minecraft:lime_stained_glass":b.glass,"minecraft:lime_stained_glass_pane":b.glass_pane,"minecraft:magenta_stained_glass":b.glass,"minecraft:magenta_stained_glass_pane":b.glass_pane,"minecraft:orange_stained_glass":b.glass,"minecraft:orange_stained_glass_pane":b.glass_pane,"minecraft:pink_stained_glass":b.glass,"minecraft:pink_stained_glass_pane":b.glass_pane,"minecraft:purple_stained_glass":b.glass,"minecraft:purple_stained_glass_pane":b.glass_pane,"minecraft:red_stained_glass":b.glass,"minecraft:red_stained_glass_pane":b.glass_pane,"minecraft:white_stained_glass":b.glass,"minecraft:white_stained_glass_pane":b.glass_pane,"minecraft:yellow_stained_glass":b.glass,"minecraft:yellow_stained_glass_pane":b.glass_pane,"minecraft:dirt":b.dirt,"minecraft:grass":b.dirt,"minecraft:sand":b.sand,"minecraft:acacia_log":b.wood,"minecraft:birch_log":b.wood,"minecraft:cherry_log":b.wood,"minecraft:dark_oak_log":b.wood,"minecraft:jungle_log":b.wood,"minecraft:mangrove_log":b.wood,"minecraft:oak_log":b.wood,"minecraft:spruce_log":b.wood,"minecraft:crimson_stem":b.wood,"minecraft:warped_stem":b.wood,"minecraft:stripped_acacia_log":b.wood,"minecraft:stripped_bamboo_block":b.wood,"minecraft:stripped_birch_log":b.wood,"minecraft:stripped_cherry_log":b.wood,"minecraft:stripped_cherry_wood":b.wood,"minecraft:stripped_crimson_hyphae":b.wood,"minecraft:stripped_crimson_stem":b.wood,"minecraft:stripped_dark_oak_log":b.wood,"minecraft:stripped_jungle_log":b.wood,"minecraft:stripped_mangrove_log":b.wood,"minecraft:stripped_mangrove_wood":b.wood,"minecraft:stripped_oak_log":b.wood,"minecraft:stripped_spruce_log":b.wood,"minecraft:stripped_warped_hyphae":b.wood,"minecraft:stripped_warped_stem":b.wood,"minecraft:planks":b.wood,"minecraft:bamboo_planks":b.wood,"minecraft:bamboo_mosaic":b.wood,"minecraft:cherry_planks":b.wood,"minecraft:crimson_planks":b.wood,"minecraft:mangrove_planks":b.wood,"minecraft:warped_planks":b.wood,"minecraft:cobblestone":b.stone,"minecraft:stonebrick":b.stone,"minecraft:stone":b.stone,"minecraft:smooth_stone":b.stone,"minecraft:mud_bricks":b.stone,"minecraft:granite":b.stone,"minecraft:polished_granite":b.stone,"minecraft:diorite":b.stone,"minecraft:polished_diorite":b.stone,"minecraft:andesite":b.stone,"minecraft:polished_andesite":b.stone,"minecraft:basalt":b.stone,"minecraft:polished_basalt":b.stone,"minecraft:deepslate":b.stone,"minecraft:polished_deepslate":b.stone,"minecraft:calcite":b.stone,"minecraft:tuff":b.stone},Me=x.getLogger("BlockBreaking"),me=class me extends U{constructor(){super(me.ID);o(this,"playerScheduler");o(this,"breakInProgress",!1);this.registerListener(s.dwellerEvents.stateChange,this.onStateChange.bind(this),U.SkillNotLearnedCondition),this.registerCounter(me.BlockBreakingCounterProperty),this.registerListener(ut.afterEvents.scriptEventReceive,this.onScriptEvent.bind(this),U.SkillLearnedCondition)}init(){this.isLearned()&&(this.playerScheduler=new qe(this.updatePlayer.bind(this),100),this.playerScheduler.start())}tryLearn(){if(this.isLearned())return;let t=Qt.getDynamicProperty(me.BlockBreakingCounterProperty)||0;t>=2&&Math.random()<.85?this.setLearnedOnNextSpawn(!0):Qt.setDynamicProperty(me.BlockBreakingCounterProperty,t+1)}setLearned(t){this.isLearned()!==t&&(super.setLearned(t),t?this.playerScheduler||(this.playerScheduler=new qe(this.updatePlayer.bind(this),100),this.playerScheduler.start()):t||(Qt.setDynamicProperty(me.BlockBreakingCounterProperty,0),this.playerScheduler&&(this.playerScheduler.stop(),this.playerScheduler=void 0)))}updatePlayer(t){if(this.breakInProgress||s.getDweller())return;let r=He.getNearestBase(t,l.from(t.location));r&&l.from(t.location).distanceSquared(r)<me.MinimumDistanceSquared&&(s.setDwellerTarget(t),this.startBreakingIntoBase())}onStateChange(t){if(t.previousState===2&&(t.newState===3||t.newState===4)){let r=Qt.getDynamicProperty(me.BlockBreakingCounterProperty)||0;r++,Qt.setDynamicProperty(me.BlockBreakingCounterProperty,r),r>=3&&Math.random()<.5&&this.setLearnedOnNextSpawn(!0)}}breakBlocks(t,r){if(!t||this.breakInProgress)return;let i=t.dimension,a=l.from(r.location),c=l.from(t.location),d=aa(c.subtract(a));a=a.setX(Math.floor(a.x)+.5).setY(Math.floor(a.y)+.5).setZ(Math.floor(a.z)+.5);let m=i.getBlockFromRay(a,d,{maxDistance:3});if(m){let k=m.block;if(i.getEntities({type:"xp_cd:block_breaker",location:k.location,maxDistance:1.2}).length>0){Me.trace("Block breaker already exists at",k.location);return}let C=oa[k.typeId];if(!C){Me.trace(`Cannot break block ${k.typeId}`);return}let A=i.spawnEntity(`xp_cd:block_breaker<xp_cd:duration_${C.duration}_ticks>`,l.from(k.center()).setY(Math.floor(k.y)));C.animationVisible&&A.triggerEvent("xp_cd:visible"),A.triggerEvent(`xp_cd:sound_${C.sound}`),this.breakInProgress=!0,r.addEffect("slowness",C.duration,{amplifier:4,showParticles:!1})}}startBreakingIntoBase(){let t=s.getDwellerTarget();if(!t)return;let r=He.getNearestBase(t,l.from(t.location));if(!r){Me.info("No base");return}this.breakInProgress=!0,Me.info(`Searching cave at ${r}`);let i=t.dimension,a=r,c=0,d=0,m=0,k=ut.runInterval(()=>{try{if(a.y<-63){He.removeBase(r);return}let D=i.getBlock(a);if(!D){Me.info(`Block is null at ${a}`),ut.clearRun(k),this.breakInProgress=!1;return}if(m==0)D.isAir||(Me.info(`Found floor at ${a}`),m=1,c=a.y);else if(m==1){if(D.isAir){if(this.breakInProgress=!1,Me.info(`Found air at ${a}`),ut.clearRun(k),d=a.y,c-d<4){Me.info("Not enough space to break in");return}i.runCommand(`/fill ${a.setY(c).toString("short"," ")} ${a.setY(d).toString("short"," ")} light_block_15`),s.setNextSpawnState(3),s.createDweller(a.setY(c-3).toBlockLocation().add(.5,0,.5),null,!1).applyImpulse(l.Up.multiply(1)),ut.runTimeout(()=>{i.getBlock(a.setY(c))?.setType("cobblestone")},5);return}}else{Me.error(`Invalid step: ${m}`),ut.clearRun(k),this.breakInProgress=!1;return}a=a.add(0,-1,0)}catch(D){Me.error(`Error while checking base: ${D}`),ut.clearRun(k),this.breakInProgress=!1;return}},1)}onScriptEvent(t){t.id=="xp_cd:break_finished"&&(this.breakInProgress=!1)}};o(me,"ID","block_breaking"),o(me,"BlockBreakingCounterProperty","xp_cd:block_breaking_counter"),o(me,"MinimumDistanceSquared",100);var pt=me;function aa(n){let{x:e,y:t,z:r}=n,i={x:Math.abs(e),y:Math.abs(t),z:Math.abs(r)},a="x";i.y>i.x&&i.y>i.z?a="y":i.z>i.x&&i.z>i.y&&(a="z");let c={x:0,y:0,z:0};switch(a){case"x":c.x=e/i.x;break;case"y":c.y=t/i.y;break;case"z":c.z=r/i.z;break}return c}import{Entity as jr,MolangVariableMap as la,system as Pt,GameMode as Zi}from"@minecraft/server";var tr=["acacia_boat","acacia_button","acacia_chest_boat","acacia_door","acacia_fence","acacia_fence_gate","acacia_hanging_sign","acacia_leaves","acacia_log","acacia_planks","acacia_pressure_plate","acacia_sapling","acacia_sign","acacia_slab","acacia_stairs","acacia_trapdoor","acacia_wood","activator_rail","allium","allow","amethyst_block","amethyst_cluster","amethyst_shard","ancient_debris","andesite","andesite_slab","andesite_stairs","angler_pottery_sherd","anvil","apple","archer_pottery_sherd","armadillo_scute","armor_stand","arms_up_pottery_sherd","arrow","axolotl_bucket","azalea","azalea_leaves","azalea_leaves_flowered","azure_bluet","baked_potato","bamboo","bamboo_block","bamboo_button","bamboo_chest_raft","bamboo_door","bamboo_fence","bamboo_fence_gate","bamboo_hanging_sign","bamboo_mosaic","bamboo_mosaic_slab","bamboo_mosaic_stairs","bamboo_planks","bamboo_pressure_plate","bamboo_raft","bamboo_sign","bamboo_slab","bamboo_stairs","bamboo_trapdoor","banner","barrel","barrier","basalt","beacon","bed","bedrock","bee_nest","beef","beehive","beetroot","beetroot_seeds","beetroot_soup","bell","big_dripleaf","birch_boat","birch_button","birch_chest_boat","birch_door","birch_fence","birch_fence_gate","birch_hanging_sign","birch_leaves","birch_log","birch_planks","birch_pressure_plate","birch_sapling","birch_sign","birch_slab","birch_stairs","birch_trapdoor","birch_wood","black_candle","black_carpet","black_concrete","black_concrete_powder","black_dye","black_glazed_terracotta","black_shulker_box","black_stained_glass","black_stained_glass_pane","black_terracotta","black_wool","blackstone","blackstone_slab","blackstone_stairs","blackstone_wall","blade_pottery_sherd","blast_furnace","blaze_powder","blaze_rod","blue_candle","blue_carpet","blue_concrete","blue_concrete_powder","blue_dye","blue_glazed_terracotta","blue_ice","blue_orchid","blue_shulker_box","blue_stained_glass","blue_stained_glass_pane","blue_terracotta","blue_wool","bolt_armor_trim_smithing_template","bone","bone_block","bone_meal","book","bookshelf","border_block","bordure_indented_banner_pattern","bow","bowl","brain_coral","brain_coral_block","brain_coral_fan","bread","breeze_rod","brewer_pottery_sherd","brewing_stand","brick","brick_block","brick_slab","brick_stairs","brown_candle","brown_carpet","brown_concrete","brown_concrete_powder","brown_dye","brown_glazed_terracotta","brown_mushroom","brown_mushroom_block","brown_shulker_box","brown_stained_glass","brown_stained_glass_pane","brown_terracotta","brown_wool","brush","bubble_coral","bubble_coral_block","bubble_coral_fan","bucket","budding_amethyst","burn_pottery_sherd","cactus","cake","calcite","calibrated_sculk_sensor","campfire","candle","carrot","carrot_on_a_stick","cartography_table","carved_pumpkin","cauldron","chain","chain_command_block","chainmail_boots","chainmail_chestplate","chainmail_helmet","chainmail_leggings","charcoal","cherry_boat","cherry_button","cherry_chest_boat","cherry_door","cherry_fence","cherry_fence_gate","cherry_hanging_sign","cherry_leaves","cherry_log","cherry_planks","cherry_pressure_plate","cherry_sapling","cherry_sign","cherry_slab","cherry_stairs","cherry_trapdoor","cherry_wood","chest","chest_minecart","chicken","chiseled_bookshelf","chiseled_copper","chiseled_deepslate","chiseled_nether_bricks","chiseled_polished_blackstone","chiseled_sandstone","chiseled_stone_bricks","chiseled_tuff","chiseled_tuff_bricks","chorus_flower","chorus_fruit","chorus_plant","clay","clay_ball","clock","coal","coal_block","coal_ore","coast_armor_trim_smithing_template","cobbled_deepslate","cobbled_deepslate_slab","cobbled_deepslate_stairs","cobbled_deepslate_wall","cobblestone","cobblestone_slab","cobblestone_wall","cocoa_beans","cod","cod_bucket","command_block","command_block_minecart","comparator","compass","composter","conduit","cooked_beef","cooked_chicken","cooked_cod","cooked_mutton","cooked_porkchop","cooked_rabbit","cooked_salmon","cookie","copper_block","copper_bulb","copper_door","copper_grate","copper_ingot","copper_ore","copper_trapdoor","cornflower","cracked_deepslate_bricks","cracked_deepslate_tiles","cracked_nether_bricks","cracked_polished_blackstone_bricks","cracked_stone_bricks","crafter","crafting_table","creeper_banner_pattern","crimson_button","crimson_door","crimson_fence","crimson_fence_gate","crimson_fungus","crimson_hanging_sign","crimson_hyphae","crimson_nylium","crimson_planks","crimson_pressure_plate","crimson_roots","crimson_sign","crimson_slab","crimson_stairs","crimson_stem","crimson_trapdoor","crossbow","crying_obsidian","cut_copper","cut_copper_slab","cut_copper_stairs","cut_red_sandstone_slab","cut_sandstone","cut_sandstone_slab","cyan_candle","cyan_carpet","cyan_concrete","cyan_concrete_powder","cyan_dye","cyan_glazed_terracotta","cyan_shulker_box","cyan_stained_glass","cyan_stained_glass_pane","cyan_terracotta","cyan_wool","dandelion","danger_pottery_sherd","dark_oak_boat","dark_oak_button","dark_oak_chest_boat","dark_oak_door","dark_oak_fence","dark_oak_fence_gate","dark_oak_hanging_sign","dark_oak_leaves","dark_oak_log","dark_oak_planks","dark_oak_pressure_plate","dark_oak_sapling","dark_oak_sign","dark_oak_slab","dark_oak_stairs","dark_oak_trapdoor","dark_oak_wood","dark_prismarine","dark_prismarine_slab","dark_prismarine_stairs","daylight_detector","dead_brain_coral","dead_brain_coral_block","dead_brain_coral_fan","dead_bubble_coral","dead_bubble_coral_block","dead_bubble_coral_fan","dead_fire_coral","dead_fire_coral_block","dead_fire_coral_fan","dead_horn_coral","dead_horn_coral_block","dead_horn_coral_fan","dead_tube_coral","dead_tube_coral_block","dead_tube_coral_fan","deadbush","debug_stick","decorated_pot","deepslate","deepslate_brick_slab","deepslate_brick_stairs","deepslate_brick_wall","deepslate_bricks","deepslate_coal_ore","deepslate_copper_ore","deepslate_diamond_ore","deepslate_emerald_ore","deepslate_gold_ore","deepslate_iron_ore","deepslate_lapis_ore","deepslate_redstone_ore","deepslate_tile_slab","deepslate_tile_stairs","deepslate_tile_wall","deepslate_tiles","deny","detector_rail","diamond","diamond_axe","diamond_block","diamond_boots","diamond_chestplate","diamond_helmet","diamond_hoe","diamond_horse_armor","diamond_leggings","diamond_ore","diamond_pickaxe","diamond_shovel","diamond_sword","diorite","diorite_slab","diorite_stairs","dirt","dirt_with_roots","disc_fragment_5","dispenser","dragon_breath","dragon_egg","dried_kelp","dried_kelp_block","dripstone_block","dropper","dune_armor_trim_smithing_template","echo_shard","egg","elytra","emerald","emerald_block","emerald_ore","empty_map","enchanted_book","enchanted_golden_apple","enchanting_table","end_brick_stairs","end_bricks","end_crystal","end_portal_frame","end_rod","end_stone","end_stone_brick_slab","ender_chest","ender_eye","ender_pearl","experience_bottle","explorer_pottery_sherd","exposed_chiseled_copper","exposed_copper","exposed_copper_bulb","exposed_copper_door","exposed_copper_grate","exposed_copper_trapdoor","exposed_cut_copper","exposed_cut_copper_slab","exposed_cut_copper_stairs","eye_armor_trim_smithing_template","farmland","feather","fence_gate","fermented_spider_eye","fern","field_masoned_banner_pattern","filled_map","fire_charge","fire_coral","fire_coral_block","fire_coral_fan","firework_rocket","firework_star","fishing_rod","fletching_table","flint","flint_and_steel","flow_armor_trim_smithing_template","flow_banner_pattern","flow_pottery_sherd","flower_banner_pattern","flower_pot","flowering_azalea","frame","friend_pottery_sherd","frog_spawn","frosted_ice","furnace","ghast_tear","gilded_blackstone","glass","glass_bottle","glass_pane","glistering_melon_slice","globe_banner_pattern","glow_berries","glow_frame","glow_ink_sac","glow_lichen","glowstone","glowstone_dust","goat_horn","gold_block","gold_ingot","gold_nugget","gold_ore","golden_apple","golden_axe","golden_boots","golden_carrot","golden_chestplate","golden_helmet","golden_hoe","golden_horse_armor","golden_leggings","golden_pickaxe","golden_rail","golden_shovel","golden_sword","granite","granite_slab","granite_stairs","grass_block","grass_path","gravel","gray_candle","gray_carpet","gray_concrete","gray_concrete_powder","gray_dye","gray_glazed_terracotta","gray_shulker_box","gray_stained_glass","gray_stained_glass_pane","gray_terracotta","gray_wool","green_candle","green_carpet","green_concrete","green_concrete_powder","green_dye","green_glazed_terracotta","green_shulker_box","green_stained_glass","green_stained_glass_pane","green_terracotta","green_wool","grindstone","gunpowder","guster_banner_pattern","guster_pottery_sherd","hanging_roots","hardened_clay","hay_block","heart_of_the_sea","heart_pottery_sherd","heartbreak_pottery_sherd","heavy_core","heavy_weighted_pressure_plate","honey_block","honey_bottle","honeycomb","honeycomb_block","hopper","hopper_minecart","horn_coral","horn_coral_block","horn_coral_fan","host_armor_trim_smithing_template","howl_pottery_sherd","ice","infested_chiseled_stone_bricks","infested_cobblestone","infested_cracked_stone_bricks","infested_deepslate","infested_mossy_stone_bricks","infested_stone","infested_stone_bricks","ink_sac","iron_axe","iron_bars","iron_block","iron_boots","iron_chestplate","iron_door","iron_helmet","iron_hoe","iron_horse_armor","iron_ingot","iron_leggings","iron_nugget","iron_ore","iron_pickaxe","iron_shovel","iron_sword","iron_trapdoor","jigsaw","jukebox","jungle_boat","jungle_button","jungle_chest_boat","jungle_door","jungle_fence","jungle_fence_gate","jungle_hanging_sign","jungle_leaves","jungle_log","jungle_planks","jungle_pressure_plate","jungle_sapling","jungle_sign","jungle_slab","jungle_stairs","jungle_trapdoor","jungle_wood","kelp","ladder","lantern","lapis_block","lapis_lazuli","lapis_ore","large_amethyst_bud","large_fern","lava_bucket","lead","leather","leather_boots","leather_chestplate","leather_helmet","leather_horse_armor","leather_leggings","lectern","lever","light_block_0","light_block_1","light_block_10","light_block_11","light_block_12","light_block_13","light_block_14","light_block_15","light_block_2","light_block_3","light_block_4","light_block_5","light_block_6","light_block_7","light_block_8","light_block_9","light_blue_candle","light_blue_carpet","light_blue_concrete","light_blue_concrete_powder","light_blue_dye","light_blue_glazed_terracotta","light_blue_shulker_box","light_blue_stained_glass","light_blue_stained_glass_pane","light_blue_terracotta","light_blue_wool","light_gray_candle","light_gray_carpet","light_gray_concrete","light_gray_concrete_powder","light_gray_dye","light_gray_shulker_box","light_gray_stained_glass","light_gray_stained_glass_pane","light_gray_terracotta","light_gray_wool","light_weighted_pressure_plate","lightning_rod","lilac","lily_of_the_valley","lime_candle","lime_carpet","lime_concrete","lime_concrete_powder","lime_dye","lime_glazed_terracotta","lime_shulker_box","lime_stained_glass","lime_stained_glass_pane","lime_terracotta","lime_wool","lingering_potion","lit_pumpkin","lodestone","lodestone_compass","loom","mace","magenta_candle","magenta_carpet","magenta_concrete","magenta_concrete_powder","magenta_dye","magenta_glazed_terracotta","magenta_shulker_box","magenta_stained_glass","magenta_stained_glass_pane","magenta_terracotta","magenta_wool","magma","magma_cream","mangrove_boat","mangrove_button","mangrove_chest_boat","mangrove_door","mangrove_fence","mangrove_fence_gate","mangrove_hanging_sign","mangrove_leaves","mangrove_log","mangrove_planks","mangrove_pressure_plate","mangrove_propagule","mangrove_roots","mangrove_sign","mangrove_slab","mangrove_stairs","mangrove_trapdoor","mangrove_wood","medium_amethyst_bud","melon_block","melon_seeds","melon_slice","milk_bucket","minecart","miner_pottery_sherd","mob_spawner","mojang_banner_pattern","moss_block","moss_carpet","mossy_cobblestone","mossy_cobblestone_slab","mossy_cobblestone_stairs","mossy_stone_brick_slab","mossy_stone_brick_stairs","mossy_stone_bricks","mourner_pottery_sherd","mud","mud_brick_slab","mud_brick_stairs","mud_brick_wall","mud_bricks","muddy_mangrove_roots","mushroom_stew","music_disc_11","music_disc_13","music_disc_5","music_disc_blocks","music_disc_cat","music_disc_chirp","music_disc_creator","music_disc_creator_music_box","music_disc_far","music_disc_mall","music_disc_mellohi","music_disc_otherside","music_disc_pigstep","music_disc_precipice","music_disc_relic","music_disc_stal","music_disc_strad","music_disc_wait","music_disc_ward","mutton","mycelium","name_tag","nautilus_shell","nether_brick","nether_brick_fence","nether_brick_slab","nether_brick_stairs","nether_gold_ore","nether_sprouts","nether_star","nether_wart","nether_wart_block","netherbrick","netherite_axe","netherite_block","netherite_boots","netherite_chestplate","netherite_helmet","netherite_hoe","netherite_ingot","netherite_leggings","netherite_pickaxe","netherite_scrap","netherite_shovel","netherite_sword","netherite_upgrade_smithing_template","netherrack","normal_stone_slab","normal_stone_stairs","noteblock","oak_boat","oak_chest_boat","oak_fence","oak_hanging_sign","oak_leaves","oak_log","oak_planks","oak_sapling","oak_sign","oak_slab","oak_stairs","oak_wood","observer","obsidian","ochre_froglight","ominous_bottle","ominous_trial_key","orange_candle","orange_carpet","orange_concrete","orange_concrete_powder","orange_dye","orange_glazed_terracotta","orange_shulker_box","orange_stained_glass","orange_stained_glass_pane","orange_terracotta","orange_tulip","orange_wool","oxeye_daisy","oxidized_chiseled_copper","oxidized_copper","oxidized_copper_bulb","oxidized_copper_door","oxidized_copper_grate","oxidized_copper_trapdoor","oxidized_cut_copper","oxidized_cut_copper_slab","oxidized_cut_copper_stairs","packed_ice","packed_mud","painting","paper","pearlescent_froglight","peony","petrified_oak_slab","phantom_membrane","piglin_banner_pattern","pink_candle","pink_carpet","pink_concrete","pink_concrete_powder","pink_dye","pink_glazed_terracotta","pink_petals","pink_shulker_box","pink_stained_glass","pink_stained_glass_pane","pink_terracotta","pink_tulip","pink_wool","piston","pitcher_plant","pitcher_pod","plenty_pottery_sherd","podzol","pointed_dripstone","poisonous_potato","polished_andesite","polished_andesite_slab","polished_andesite_stairs","polished_basalt","polished_blackstone","polished_blackstone_brick_slab","polished_blackstone_brick_stairs","polished_blackstone_brick_wall","polished_blackstone_bricks","polished_blackstone_button","polished_blackstone_pressure_plate","polished_blackstone_slab","polished_blackstone_stairs","polished_blackstone_wall","polished_deepslate","polished_deepslate_slab","polished_deepslate_stairs","polished_deepslate_wall","polished_diorite","polished_diorite_slab","polished_diorite_stairs","polished_granite","polished_granite_slab","polished_granite_stairs","polished_tuff","polished_tuff_slab","polished_tuff_stairs","polished_tuff_wall","popped_chorus_fruit","poppy","porkchop","potato","potion","powder_snow_bucket","prismarine","prismarine_brick_slab","prismarine_bricks","prismarine_bricks_stairs","prismarine_crystals","prismarine_shard","prismarine_slab","prismarine_stairs","prize_pottery_sherd","pufferfish","pufferfish_bucket","pumpkin","pumpkin_pie","pumpkin_seeds","purple_candle","purple_carpet","purple_concrete","purple_concrete_powder","purple_dye","purple_glazed_terracotta","purple_shulker_box","purple_stained_glass","purple_stained_glass_pane","purple_terracotta","purple_wool","purpur_block","purpur_slab","purpur_stairs","quartz","quartz_block","quartz_bricks","quartz_ore","quartz_slab","quartz_stairs","rabbit","rabbit_foot","rabbit_hide","rabbit_stew","rail","raiser_armor_trim_smithing_template","raw_copper","raw_copper_block","raw_gold","raw_gold_block","raw_iron","raw_iron_block","recovery_compass","red_candle","red_carpet","red_concrete","red_concrete_powder","red_dye","red_glazed_terracotta","red_mushroom","red_mushroom_block","red_nether_brick","red_nether_brick_slab","red_nether_brick_stairs","red_sandstone","red_sandstone_slab","red_sandstone_stairs","red_shulker_box","red_stained_glass","red_stained_glass_pane","red_terracotta","red_tulip","red_wool","redstone","redstone_block","redstone_lamp","redstone_ore","redstone_torch","reinforced_deepslate","repeater","repeating_command_block","respawn_anchor","rib_armor_trim_smithing_template","rose_bush","rotten_flesh","saddle","salmon","salmon_bucket","sand","sandstone","sandstone_slab","sandstone_stairs","scaffolding","scrape_pottery_sherd","sculk","sculk_catalyst","sculk_sensor","sculk_shrieker","sculk_vein","sea_lantern","sea_pickle","seagrass","sentry_armor_trim_smithing_template","shaper_armor_trim_smithing_template","sheaf_pottery_sherd","shears","shelter_pottery_sherd","shield","short_grass","shroomlight","shulker_shell","silence_armor_trim_smithing_template","silver_glazed_terracotta","skull","skull_banner_pattern","skull_pottery_sherd","slime","slime_ball","small_amethyst_bud","small_dripleaf_block","smithing_table","smoker","smooth_basalt","smooth_quartz_slab","smooth_quartz_stairs","smooth_red_sandstone_slab","smooth_red_sandstone_stairs","smooth_sandstone","smooth_sandstone_slab","smooth_sandstone_stairs","smooth_stone","smooth_stone_slab","sniffer_egg","snort_pottery_sherd","snout_armor_trim_smithing_template","snow","snow_layer","snowball","soul_campfire","soul_lantern","soul_sand","soul_soil","soul_torch","spider_eye","spire_armor_trim_smithing_template","splash_potion","sponge","spore_blossom","spruce_boat","spruce_button","spruce_chest_boat","spruce_door","spruce_fence","spruce_fence_gate","spruce_hanging_sign","spruce_leaves","spruce_log","spruce_planks","spruce_pressure_plate","spruce_sapling","spruce_sign","spruce_slab","spruce_stairs","spruce_trapdoor","spruce_wood","spyglass","stick","sticky_piston","stone","stone_axe","stone_brick_slab","stone_brick_stairs","stone_bricks","stone_button","stone_hoe","stone_pickaxe","stone_pressure_plate","stone_shovel","stone_stairs","stone_sword","stonecutter_block","string","stripped_acacia_log","stripped_acacia_wood","stripped_bamboo_block","stripped_birch_log","stripped_birch_wood","stripped_cherry_log","stripped_cherry_wood","stripped_crimson_hyphae","stripped_crimson_stem","stripped_dark_oak_log","stripped_dark_oak_wood","stripped_jungle_log","stripped_jungle_wood","stripped_mangrove_log","stripped_mangrove_wood","stripped_oak_log","stripped_oak_wood","stripped_spruce_log","stripped_spruce_wood","stripped_warped_hyphae","stripped_warped_stem","structure_block","structure_void","sugar","sugar_cane","sunflower","suspicious_gravel","suspicious_sand","suspicious_stew","sweet_berries","tadpole_bucket","tall_grass","target","tide_armor_trim_smithing_template","tinted_glass","tnt","tnt_minecart","torch","torchflower","torchflower_seeds","totem_of_undying","trapdoor","trapped_chest","trial_key","trial_spawner","trident","tripwire_hook","tropical_fish","tropical_fish_bucket","tube_coral","tube_coral_block","tube_coral_fan","tuff","tuff_brick_slab","tuff_brick_stairs","tuff_brick_wall","tuff_bricks","tuff_slab","tuff_stairs","tuff_wall","turtle_egg","turtle_helmet","turtle_scute","twisting_vines","undyed_shulker_box","vault","verdant_froglight","vex_armor_trim_smithing_template","vine","ward_armor_trim_smithing_template","warped_button","warped_door","warped_fence","warped_fence_gate","warped_fungus","warped_fungus_on_a_stick","warped_hanging_sign","warped_hyphae","warped_nylium","warped_planks","warped_pressure_plate","warped_roots","warped_sign","warped_slab","warped_stairs","warped_stem","warped_trapdoor","warped_wart_block","water_bucket","waterlily","waxed_chiseled_copper","waxed_copper","waxed_copper_bulb","waxed_copper_door","waxed_copper_grate","waxed_copper_trapdoor","waxed_cut_copper","waxed_cut_copper_slab","waxed_cut_copper_stairs","waxed_exposed_chiseled_copper","waxed_exposed_copper","waxed_exposed_copper_bulb","waxed_exposed_copper_door","waxed_exposed_copper_grate","waxed_exposed_copper_trapdoor","waxed_exposed_cut_copper","waxed_exposed_cut_copper_slab","waxed_exposed_cut_copper_stairs","waxed_oxidized_chiseled_copper","waxed_oxidized_copper","waxed_oxidized_copper_bulb","waxed_oxidized_copper_door","waxed_oxidized_copper_grate","waxed_oxidized_copper_trapdoor","waxed_oxidized_cut_copper","waxed_oxidized_cut_copper_slab","waxed_oxidized_cut_copper_stairs","waxed_weathered_chiseled_copper","waxed_weathered_copper","waxed_weathered_copper_bulb","waxed_weathered_copper_door","waxed_weathered_copper_grate","waxed_weathered_copper_trapdoor","waxed_weathered_cut_copper","waxed_weathered_cut_copper_slab","waxed_weathered_cut_copper_stairs","wayfinder_armor_trim_smithing_template","weathered_chiseled_copper","weathered_copper","weathered_copper_bulb","weathered_copper_door","weathered_copper_grate","weathered_copper_trapdoor","weathered_cut_copper","weathered_cut_copper_slab","weathered_cut_copper_stairs","web","weeping_vines","wheat","wheat_seeds","white_candle","white_carpet","white_concrete","white_concrete_powder","white_dye","white_glazed_terracotta","white_shulker_box","white_stained_glass","white_stained_glass_pane","white_terracotta","white_tulip","white_wool","wild_armor_trim_smithing_template","wind_charge","wither_rose","wolf_armor","wooden_axe","wooden_button","wooden_door","wooden_hoe","wooden_pickaxe","wooden_pressure_plate","wooden_shovel","wooden_sword","writable_book","yellow_candle","yellow_carpet","yellow_concrete","yellow_concrete_powder","yellow_dye","yellow_glazed_terracotta","yellow_shulker_box","yellow_stained_glass","yellow_stained_glass_pane","yellow_terracotta","yellow_wool"];var On=[10,8,6,4,2],Gn=[6,5,4,3,2];var Hn=x.getLogger("BrightLight"),Ke=class Ke extends U{constructor(){super(Ke.ID);o(this,"cooldown",0);o(this,"checkRunId");o(this,"scriptEventListener");o(this,"mDweller");this.registerListener(Pt.afterEvents.scriptEventReceive,this.onScriptEvent.bind(this),U.SkillNotLearnedCondition),this.registerCounter(Ke.FlashBangCounterProperty)}onScriptEvent(t){if(t.id==="xp_cd:flash_bang"){if(this.cooldown>0){this.cooldown--;return}this.cooldown=20,this.tryLearn(),Hn.debug("Disengage, cause: bright light"),s.setState(4)}}setLearned(t){this.isLearned()!==t&&(super.setLearned(t),t||this.checkRunId&&(Pt.clearRun(this.checkRunId),this.checkRunId=void 0))}setupEntity(t){this.mDweller=t,this.isLearned()&&this.checkRunId===void 0&&(this.checkRunId,Pt.runInterval(this.extinguishNearbyTorches.bind(this),10))}extinguishNearbyTorches(t){if(t===void 0&&(t=this.mDweller),t===void 0)return;let r,i;try{t instanceof jr?(i=l.from(t.location),r=t.dimension):(i=t,r=s.dimension)}catch{s.getState()===0&&this.checkRunId!==void 0&&Pt.clearRun(this.checkRunId);return}if(t instanceof jr&&t.typeId!=="xp_cd:cave_dweller"&&s.getStaringPlayers(i,60).length>0)return;let a=i.add(0,3,0),c=[...Qi(i,r),...Qi(a,r)],d=qn(c);d.length>0&&Vn(d)}flickerNearbyTorches(t){let r;if(t instanceof jr?r=l.from(t.location):r=t,t instanceof jr&&t.typeId!=="xp_cd:cave_dweller"&&s.getStaringPlayers(r,60).length>0)return;let i=qn(Qi(r,s.dimension));i.length>0&&Vn(i,!0)}tryLearn(t=!1){let r;t&&Math.random()<.75?r=this.getCounter(Ke.FlashBangCounterProperty):r=this.incrementCounter(Ke.FlashBangCounterProperty),r>=2&&Math.random()<.5&&this.setLearnedOnNextSpawn(t?Math.random()<.05:!0)}};o(Ke,"ID","bright_light"),o(Ke,"FlashBangCounterProperty","xp_cd:flash_bang_counter");var _e=Ke;function Vn(n,e=!1){n.forEach(t=>ca(t,e))}function ca(n,e=!1){let t=n?.typeId.includes("dl");if(n===void 0||n.typeId!=="minecraft:torch"&&n.typeId!=="minecraft:soul_torch"&&!t)return;let r;t?r=n.permutation.getAllStates():r=ua(n);let i;t?i="xp_cd:dl_torch_"+n.typeId.split(".")[1]+"_"+(n.typeId.includes("soul")?"8":"12"):i=`xp_cd:${n.typeId.includes("soul")?"soul_":""}torch_${n.typeId.includes("soul")?"8":"12"}`;let a=ma(n.typeId.includes("soul")?Gn:On);n.setPermutation(R(i,r)),Pt.runTimeout(()=>{Fn(n,r,0,a,e)},2)}function Fn(n,e,t,r,i){let a;if(t>4){if(a=0,i){let d;if(n.typeId.includes("dl")){d="xp_dl:torch."+n.typeId.split("_")[3]+".block",n.dimension.runCommand(`setblock ${l.from(n.location).toBlockLocation().toString("short"," ")} ${d} [${Object.entries(e).map(([m,k])=>`"${m}"="${k}"`).join(",")}]`),n.dimension.runCommand(`execute as @p run scriptevent xp_dl_block:add_light ${l.from(n.location).toBlockLocation().toString("short",",")}`);return}else d=`minecraft:${n.typeId.includes("soul")?"soul_":""}torch`;n.setPermutation(R(d,d.startsWith("minecraft:")?pa(n):e));return}}else a=r[t];let c;if(n.typeId.includes("dl")?c="xp_cd:dl_torch_"+n.typeId.split("_")[3]+"_"+a:c=`xp_cd:${n.typeId.includes("soul")?"soul_":""}torch_${a}`,n.setPermutation(R(c,e)),a===0){let d=new la;d.setFloat("xp_cd_pos",da(e)),n.dimension.playSound("random.fizz",n.location,{pitch:1.25,volume:.25}),n.dimension.playSound(n.typeId.includes("soul")?"particle.soul_escape":"",n.location,{pitch:Math.random()*.75+1,volume:2}),n.dimension.spawnParticle("xp_cd:torch.extinguish.smoke",l.from(n.location).add(.5,0,.5),d),n.dimension.spawnParticle(n.typeId.includes("soul")?"xp_cd:soul_torch.extinguish.embers":"xp_cd:torch.extinguish.embers",l.from(n.location).add(.5,0,.5),d),n.dimension.spawnParticle(n.typeId.includes("soul")?"xp_cd:soul_torch.extinguish.souls":"",l.from(n.location).add(.5,0,.5),d);return}Pt.runTimeout(()=>{Fn(n,e,t+1,r,i)},2)}function da(n){switch(n["minecraft:block_face"]){case"north":return 1;case"south":return 2;case"west":return 3;case"east":return 4;default:return 0}}function ua(n){let e=n.permutation,t={};return t={"minecraft:block_face":$n(e.getState("torch_facing_direction"))},t}function pa(n){let e=n.permutation,t={};return t={torch_facing_direction:$n(e.getState("minecraft:block_face"))},t}function $n(n){switch(n){case"north":return"south";case"south":return"north";case"west":return"east";case"east":return"west";case"up":return"top";default:return"up"}}function qn(n){let e=[];return n.forEach(t=>{(t?.typeId==="minecraft:torch"||t?.typeId==="minecraft:soul_torch"||t?.typeId.startsWith("xp_dl:torch"))&&e.push(t)}),e}function Qi(n,e){let t=[],r=l.from(n);for(let i=-4;i<=4;i++)for(let a=-2;a<=2;a++)for(let c=-4;c<=4;c++){let d;try{d=e.getBlock(r.add(i,a,c))}catch{continue}d&&t.push(d)}return t}function ma(n){let e=n.length,t=[...n];for(;e!=0;){let r=Math.floor(Math.random()*e);e--,[t[e],t[r]]=[t[r],t[e]]}return t}var Ct=class{constructor(){this.onPlayerInteract=this.onPlayerInteract.bind(this),this.onTick=this.onTick.bind(this)}onPlayerInteract(e){let t=e.block,r=e.player?.getGameMode()??Zi.creative;Hn.info(l.from(t.location).toString("short"," ")),r!==Zi.creative&&r!==Zi.spectator&&t.dimension.runCommand(`setblock ${l.from(t.location).toString("short"," ")} air destroy`)}onTick(e){let t=e.block,r=t.permutation.getState("minecraft:block_face"),i;switch(r){case"north":i=t.south();break;case"south":i=t.north();break;case"west":i=t.east();break;case"east":i=t.west();break;default:i=t.below();break}(i===void 0||i.isAir)&&e.dimension.runCommand(`setblock ${l.from(t.location).toString("short"," ")} air destroy`)}};o(Ct,"componentId","xp_cd:extinguished_torch");var Yr=class Yr extends U{constructor(){super(Yr.ID);o(this,"stateHistory",[]);this.registerListener(s.dwellerEvents.stateChange,this.onStateChange.bind(this),U.SkillNotLearnedCondition),this.registerListener(s.dwellerEvents.aggroMeterFull,this.onAggroMeterFull.bind(this),U.SkillNotLearnedCondition)}onAggroMeterFull(){Math.random()<.5&&this.setLearnedOnNextSpawn(!0)}onStateChange(t){this.stateHistory.length===0?(this.stateHistory.push(t.previousState),this.stateHistory.push(t.newState)):this.stateHistory.push(t.newState),this.stateHistory.length>3&&this.stateHistory.shift(),this.stateHistory.length===3&&this.stateHistory[0]===2&&this.stateHistory[1]===3&&this.stateHistory[2]===4&&Math.random()<.5&&this.setLearnedOnNextSpawn(!0)}};o(Yr,"ID","ambush_tactics");var rr=Yr;var mt=class mt extends U{constructor(){super(mt.ID),this.registerListener(s.dwellerEvents.consumeFood,this.onFoodConsume.bind(this),U.SkillNotLearnedCondition),this.registerCounter(mt.FoodConsumeCounterProperty)}onFoodConsume(){this.incrementCounter(mt.FoodConsumeCounterProperty)>=2&&Math.random()<.33&&this.setLearnedOnNextSpawn(!0)}};o(mt,"ID","ignore_food"),o(mt,"FoodConsumeCounterProperty","xp_cd:food_consume_counter");var ir=mt;var Lt=class Lt extends U{constructor(){super(Lt.ID),this.registerListener(s.dwellerEvents.stateChange,this.onStateChange.bind(this),U.SkillNotLearnedCondition)}onStateChange(e){if(Q.isLearned(_e.ID)&&e.previousState===3&&e.newState===4){let t=s.getDwellerTarget();if(!t)return;Ae(t)==="Outside"&&this.incrementCounter(Lt.SurfaceFreedomCounterProperty)>1&&this.setLearnedOnNextSpawn(!0)}}};o(Lt,"ID","surface_freedom"),o(Lt,"SurfaceFreedomCounterProperty","xp_cd:surface_freedom_counter");var Je=Lt;import{MinecraftDimensionTypes as Un,system as jn,world as Yn}from"@minecraft/server";var nr=x.getLogger("SoundBrave"),At=class At extends U{constructor(){super(At.ID);o(this,"exploDistanceThreshold",Math.pow(24,2));this.registerListener(Yn.beforeEvents.explosion,this.onExplode.bind(this),U.SkillNotLearnedCondition),this.registerListener(Yn.beforeEvents.entityRemove,this.onRocketRemove.bind(this),U.SkillNotLearnedCondition)}onExplode(t){if(t.dimension.id!==Un.overworld)return;let r;if(t.source!==void 0)r=s.getDistanceSquared(t.source);else{let i=t.source;if(i===void 0){nr.info("Explosion source is undefined");return}r=s.getDistanceSquared(i)}if(r===void 0){nr.info("Distance is undefined");return}r<this.exploDistanceThreshold&&(nr.info("Explosion is too close"),jn.run(()=>{nr.debug("Disengage, cause: sound brave"),s.setState(4),this.incrementCounter(At.SoundBraveCounterProperty)>=3&&Math.random()<.5&&this.setLearnedOnNextSpawn(!0)}))}onRocketRemove(t){let r=t.removedEntity;if(r.typeId!=="minecraft:fireworks_rocket"||r.dimension.id!==Un.overworld)return;let i=s.getDistanceSquared(r);i!==void 0&&i<this.exploDistanceThreshold&&jn.run(()=>{nr.debug("Disengage, cause: sound brave rocket"),s.setState(4)})}};o(At,"ID","sound_brave"),o(At,"SoundBraveCounterProperty","xp_cd:sound_brave_counter");var or=At;var Wn=x.getLogger("UnfoldSystem"),Mt=[],Q=class n{static init(){Mt=[new Jt,new pt,new _e,new rr,new ir,new Je,new or],s.dwellerEvents.die.subscribe(()=>{n.reset()});for(let e of Mt)e.init()}static setupEntity(e){for(let t of Mt)t.preSetupEntity(e),t.setupEntity(e)}static reset(){for(let e of Mt)e.setLearned(!1)}static learn(e){let t=Mt.find(r=>r.id===e);t?(t.setLearned(!0),Wn.info(`Learned skill with id ${e}`)):Wn.warn(`Could not find learnable with id ${e}`)}static getSkill(e){return Mt.find(t=>t.id===e)}static isLearned(e){let t=this.getSkill(e);return t?t.isLearned():!1}};import{Entity as Ea,EntityDamageCause as so,EntityInitializationCause as Sa,GameMode as Jr,MinecraftDimensionTypes as lo,StructureSaveMode as Ta,TicksPerSecond as tt,system as W,world as ne}from"@minecraft/server";import{GameMode as Xn,system as O,TicksPerSecond as re,world as Re}from"@minecraft/server";var Kn=x.getLogger("Sounds"),ke;(Io=>{let n;(h=>(h[h.LOW=0]="LOW",h[h.MEDIUM=1]="MEDIUM",h[h.CHASE=2]="CHASE"))(n||(n={}));let e=12,t=-1,i=7*60*re,a=120,c=[],d=[],m=[],k=[];class D{constructor(u,p=0){o(this,"currentRunId",-1);o(this,"nextHeartbeat",0);o(this,"player");o(this,"shouldStop",!1);o(this,"playerId");o(this,"lingerTicks",-1);o(this,"endTick");this.player=u,this.playerId=u.id,this.nextHeartbeat=p,u.playSound(pe(p)),this.currentRunId=O.runTimeout(this.playHeartbeat.bind(this),Ie(p)),this.endTick=O.currentTick+Ie(0)*5}playHeartbeat(){if(this.player.stopMusic(),this.player.playSound(pe(this.nextHeartbeat),{volume:this.lingerTicks>=1&&this.nextHeartbeat===0?Math.max(1-.15*this.lingerTicks,0):1}),Kn.trace(pe(this.nextHeartbeat),`
 Volume: `,this.lingerTicks>=1&&this.nextHeartbeat===0?Math.max(1-.15*this.lingerTicks,0):1),this.lingerTicks>=0&&(this.lingerTicks++,this.lingerTicks===2&&this.nextHeartbeat!==0&&(this.nextHeartbeat=0,this.lingerTicks=0,this.endTick=O.currentTick+Ie(0)*2),this.lingerTicks>=3&&(this.shouldStop=!0)),!this.shouldStop)this.currentRunId=O.runTimeout(this.playHeartbeat.bind(this),Ie(this.nextHeartbeat)),O.currentTick>this.endTick&&(this.player.dimension.getEntities({location:this.player.location,maxDistance:64,type:"xp_cd:cave_dweller"}).length===0?this.shouldStop=!0:this.endTick=O.currentTick+Ie(this.nextHeartbeat)*3);else{let u=m.findIndex(p=>p.playerId===this.playerId);m.splice(u,1)}}setHeartbeat(u){this.lingerTicks=-1,this.nextHeartbeat!==u&&(this.nextHeartbeat=u),this.shouldStop=!1}stop(){this.lingerTicks=0,this.nextHeartbeat===2?this.nextHeartbeat=1:this.nextHeartbeat=0}stopImmediate(){this.shouldStop=!0}}let $=class ${static init(){let u=Re.getDynamicProperty($.m_nextMusicPropertyId),p=75+Math.max(75,Math.random()*75*5);u===void 0&&Re.setDynamicProperty($.m_nextMusicPropertyId,O.currentTick+p),Re.getAllPlayers().filter(y=>(y.getDynamicProperty($.m_musicPropertyId)??0)===1).forEach(y=>y.setDynamicProperty($.m_musicPropertyId,2));let h=O.currentTick-p;O.runTimeout($.playMusic,Math.max(p,h)),$.m_muterRunId=O.runInterval($.mutePlayers,1.5*re),s.dwellerEvents.spawnAttempt.subscribe($.onSpawnAttempt)}static playMusic(){let u=Re.getAllPlayers().filter(h=>Ae(h)==="Cave"&&(h.getDynamicProperty($.m_musicPropertyId)??0)!==1),p=75+Math.max(75,Math.random()*75*5);Re.setDynamicProperty($.m_nextMusicPropertyId,O.currentTick+p*(u.length>0?1:.2)),u.forEach(h=>{h.runCommand("/music stop 5")}),O.runTimeout(()=>{u.forEach(h=>{h.playSound("xp_cd.music.cave"),h.setDynamicProperty($.m_musicPropertyId,1)}),$.m_muterRunId=O.runInterval(()=>{u.forEach(h=>h.stopMusic())},2.5*re),O.runTimeout(()=>{u.forEach(h=>h.setDynamicProperty($.m_musicPropertyId,2))},$.m_soundLength*60*re)},5*re)}static mutePlayers(){Re.getAllPlayers().filter(p=>(p.getDynamicProperty($.m_musicPropertyId)??0)===1).forEach(p=>p.stopMusic())}static onSpawnAttempt(u){let p=u.target;Ae(p)==="Cave"&&(p.getDynamicProperty($.m_musicPropertyId)??0)===0&&(p.runCommand("/music stop 5"),O.runTimeout(()=>{p.setDynamicProperty($.m_musicPropertyId,1),p.playSound("xp_cd.music.cave"),O.runTimeout(()=>{p.setDynamicProperty($.m_musicPropertyId,2)},$.m_soundLength*60*re)},5*re))}};o($,"m_musicPropertyId","xp_cd:init_music"),o($,"m_nextMusicPropertyId","xp_cd:next_music"),o($,"m_soundLength",1.26),o($,"m_muterRunId",-1);let C=$;class A{constructor(u){o(this,"m_player");o(this,"m_playerId");o(this,"m_definitiveEndTick");o(this,"m_soundLength",13.05);this.m_player=u,this.m_playerId=u.id,this.m_definitiveEndTick=O.currentTick+this.m_soundLength*3*re,this.tickAmbience()}tickAmbience(){if(s.getDweller()){let p=s.getState();(p===2||p===3)&&(this.m_definitiveEndTick+=this.m_soundLength*re)}this.m_player.playSound("xp_cd.dweller.idle.standoff_ambience"),O.currentTick>=this.m_definitiveEndTick?Dn(this.m_playerId):O.runTimeout(this.tickAmbience.bind(this),this.m_soundLength*re)}}function G(){Re.afterEvents.entityRemove.subscribe(j,{entityTypes:[s.DwellerTypeId]}),Re.afterEvents.playerBreakBlock.subscribe(Te),Re.afterEvents.playerSpawn.subscribe(we),s.dwellerEvents.stateChange.subscribe(oe),s.dwellerEvents.staredAt.subscribe(se),Wr(Dt,i-3*60*re,i+3*60*re),Wr(Ge,a,a*2.5),C.init()}Io.init=G;function j(){d=[],Ve()}function oe(v){let u=v.dweller,p=u.dimension.getPlayers({location:u.location,maxDistance:64,excludeGameModes:[Xn.spectator]});switch(v.newState){case 1:break;case 3:kr(p),de(p,2);break;case 0:yr(p);break;case 2:kr(p);break;default:de(p,0);break}}function se(v){let u=v.player;if(!d.includes(u.id)){u.runCommand("music stop 2.5"),l.from(v.dweller.location).distanceSquared(u.location)>Math.pow(12,2)?u.playSound("xp_cd.dweller.spotted_distant"):u.playSound("xp_cd.dweller.spotted"),d.push(u.id);let y=v.dweller;O.runTimeout(()=>{y.isValid()&&y.addTag("xp_cd:spotted")},2.5*re)}c.length>0&&(c.forEach(h=>O.clearRun(h)),c=[]),Pe(u)||O.runTimeout(()=>{m.push(new D(u,0))}),s.getState()===2&&($t(u,1),Dr(u)),O.runTimeout(()=>{c.push(O.runTimeout(()=>{let h=s.getState();h!==3&&h!==0&&h!==4&&$t(u,0)},17))},1)}function Te(v){v.player.location.y>45||Math.random()>.005||(Kn.debug("Playing dig sound"),Ge(v.player,!0))}function we(v){wr(v.player)}function Ge(v,u=!1){if(O.currentTick-t<a)return;let p;if(v===void 0){let h=Re.getAllPlayers();for(let y of h)if(y.location.y>60){h=h.filter(E=>E.id!==y.id);continue}p=h[Math.floor(Math.random()*h.length)]}else p=v;if(p){if(u)vr(p,Math.round(Math.random()*3)+1);else{if(p.location.y>60)return;let h=Math.random();h<.3?kn(p,Math.round(Math.random()*3)+3):h<.5?Ut(p):h<.75&&vr(p,Math.round(Math.random()*3)+1)}t=O.currentTick,a=(120+(s.getSpotted(p)>=10?s.getSpotted(p)*2:0))*re}}Io.playRandomSound=Ge;function pe(v){switch(v){case 1:return"xp_cd.dweller.heartbeat_1";case 2:return"xp_cd.dweller.heartbeat_2";default:return"xp_cd.dweller.heartbeat_0"}}function Ie(v){switch(v){case 1:return 2.1*re;case 2:return 1.65*re;default:return 3.1*re}}function Dt(){let u=s.dimension.getPlayers({excludeGameModes:[Xn.spectator]});for(let p of u)Ae(p)==="Cave"&&(Math.random()<.65?p.playSound("xp_cd.ambient.cave",{location:p.location}):p.playSound("ambient.cave",{location:p.location}))}Io.playAmbientSound=Dt;function de(v,u){v.forEach(p=>{Pe(p)?$t(p,u):m.push(new D(p,u))})}function Pe(v){return m.some(u=>u.playerId===v.id)}function Ft(v){return m.find(u=>u.playerId===v.id)}function yr(v){v.forEach(u=>{br(u)})}function wn(v){v.forEach(u=>{wr(u)})}function Ve(){m.forEach(v=>{v.stop()}),m=[]}function br(v){let u=m.findIndex(p=>p.playerId===v.id);u!==-1&&m[u].stop()}function wr(v){let u=m.findIndex(p=>p.playerId===v.id);u!==-1&&m[u].stopImmediate()}function $t(v,u){let p=Ft(v);p!==void 0&&p.setHeartbeat(u)}function vn(){return m.length>0}Io.isAnyHeartbeat=vn;function vr(v,u){let p=l.from(v.location),h=Math.random()<.2?"gravel":p.y>8?"stone":p.y<0?"deepslate":Math.random()<.5?"stone":"deepslate",y=v.dimension,E=p.subtract(l.from(v.getViewDirection()).normalize().scale(2));for(let f=0;f<u;f++)O.runTimeout(()=>{let w=0,S=O.runInterval(()=>{y.playSound(`step.${h}`,E,{pitch:.8}),w>=Math.floor(Math.random()*2)+2&&(O.clearRun(S),O.runTimeout(()=>{y.playSound(`dig.${h}`,E)},2)),w++},5)},f*25+1)}Io.playDigSound=vr;function kn(v,u){let p=l.from(v.location),h=l.from(v.getViewDirection()).normalize(),y=[];for(let w=0;w<u;w++)y.unshift(p.add(h.scale(2+w*1.7)));let E=0,f=O.runInterval(()=>{E>=y.length?O.clearRun(f):(v.dimension.playSound("xp_cd.dweller.step",y[E],{pitch:.8,volume:.5}),E++)},.75*re)}Io.playWalkSound=kn;function Ut(v){let u=l.from(v.location),p=l.from(v.getViewDirection()).normalize(),h=u.subtract(p.scale(4));v.dimension.playSound("xp_cd.dweller.idle.spy",h,{volume:.3})}Io.playBreathSound=Ut;function kr(v){v.forEach(u=>{Dr(u)})}function Dr(v){Z(v)||k.push(new A(v))}function Z(v){return k.some(u=>u.m_playerId===v.id)}function Dn(v){let u=k.findIndex(p=>p.m_playerId===v);u!==-1&&k.splice(u,1)}})(ke||(ke={}));import{Direction as ze,EntityInitializationCause as Da,GameMode as oo,LocationOutOfWorldBoundariesError as xa,StructureSaveMode as ao,system as Ne,TicksPerSecond as an,world as Se}from"@minecraft/server";import{system as Ze,TicksPerSecond as ur,world as ka}from"@minecraft/server";import{system as en}from"@minecraft/server";var Jn=5,_a=20,sr=0;function tn(){let n=x.getLogger("JumpGaps");en.runInterval(()=>{if(sr>0){sr-=Jn;return}let e=s.getDweller();if(!e)return;let t=l.from(e.location),r=e.dimension,i=s.getDwellerTarget();if(!i||s.getState()!==3)return;let a=l.from(i.location).subtract(t);if(a.isZero()||a.lengthSquared()<4)return;let c=!1,d=r.getBlockFromRay(t.add(l.from(e.getViewDirection()).setY(0).normalize().multiply(1.6)).add(0,1,0),l.Down,{maxDistance:10,includePassableBlocks:!1,includeLiquidBlocks:!0});if((!d||d&&(d.block&&d.block.location.y<t.y-4||!d.block)&&!e.isClimbing)&&(n.debug("Found a gap"),c=!0),c){let m=a.length(),k=r.getBlockFromRay(t,a.normalize(),{maxDistance:m<<0}),D=l.from(i.location);k&&k.block&&(n.info("Block in the way"),D=l.from(k.block.location).add(.5,.5,.5));let C=D.subtract(t).divide(10).multiply(1/.6).setY(.75);n.info("Jump vector length: ",C.length()),C&&e.isOnGround&&(e.setProperty("xp_cd:is_jumping",!0),en.runTimeout(()=>{sr=_a,e.isOnGround&&e.applyImpulse(C),e.setProperty("xp_cd:is_jumping",!1)},6))}},Jn),en.afterEvents.scriptEventReceive.subscribe(e=>{e.id==="xp_cd:jump"&&e.sourceEntity.applyImpulse(l.Up)})}function Xr(n){sr=n}function Zn(){return sr}import{GameMode as Qn,Player as ha,system as Rt,TicksPerSecond as ga,world as fa}from"@minecraft/server";var Bt=class extends ve{constructor(t){super(t);o(this,"stateId","disengage");o(this,"m_stateTimeLimit",10);o(this,"m_stateTimerRunId");o(this,"m_despawnRunId");this.registerListener(s.dwellerEvents.staredAtGroup,this.onPlayerStare.bind(this),{angleRange:80}),this.registerListener(fa.afterEvents.entityHurt,this.onHurt.bind(this),{entityTypes:[s.DwellerTypeId]}),this.registerListener(s.dwellerEvents.inRange,this.onInRange.bind(this),{customRange:s.attackRange+6})}onActivate(){s.setSpeed(0),s.setIsAttacking(!1),this.m_stateTimerRunId=Rt.runTimeout(this.onStateTimerEnd.bind(this),this.m_stateTimeLimit*ga),this.m_despawnRunId=Rt.runTimeout(this.onTimerEnd.bind(this),17)}onDeactivate(){this.m_stateTimerRunId!==void 0&&(Rt.clearRun(this.m_stateTimerRunId),this.m_stateTimerRunId=void 0),this.m_despawnRunId!==void 0&&(Rt.clearRun(this.m_despawnRunId),this.m_despawnRunId=void 0)}onPlayerStare(){this.m_despawnRunId!==void 0&&(Rt.clearRun(this.m_despawnRunId),this.m_despawnRunId=Rt.runTimeout(this.onTimerEnd.bind(this),7))}onTimerEnd(){let t=s.getDweller(),r=s.getDwellerTarget();if(r||(r=s.dimension.getPlayers({location:t?.location,closest:1})[0]),t){let i=t.getProperty("xp_cd:vertical_space");if(i!==void 0&&+i==1||s.isOnCeiling()){s.remove(),Y.resetDwellerTimer(r);return}}s.remove(),Y.resetDwellerTimer(r)}onStateTimerEnd(){let t=s.getDweller(),r=s.getDwellerTarget();r||(r=s.dimension.getPlayers({location:t?.location,closest:1})[0]),s.remove(),Y.resetDwellerTimer(r)}onHurt(t){let r=t.damageSource;if(r.damagingEntity&&r.damagingEntity instanceof ha){s.setFocusTarget(r.damagingEntity);let i=r.damagingEntity.getGameMode();i===Qn.creative||i===Qn.spectator?(s.remove(),Y.resetDwellerTimer(r.damagingEntity)):(s.isOnCeiling()&&(s.jumpAt(r.damagingEntity),s.setOnCeiling(!1)),s.setDwellerTarget(r.damagingEntity),s.setState(3))}}onInRange(t){s.getStaringPlayers(void 0,60).length>0&&(s.remove(),Y.resetDwellerTimer(t.players[0]))}};o(Bt,"log",x.getLogger("DisengageBehavior"));import{EntityComponentTypes as ya,EquipmentSlot as zt,GameMode as to,Player as ba,system as he,TicksPerSecond as rn,world as nn}from"@minecraft/server";import{world as eo}from"@minecraft/server";var De=class De{static init(){this.load(),s.dwellerEvents.die.subscribe(()=>{De.reset()})}static load(){let e=eo.getDynamicProperty(this.propertyId);if(e){this.seenItems.clear();let t=e.split(";");for(let r of t){let i=r.split(","),a;try{let d=parseInt(i[0]);!isNaN(d)&&d>=0&&d<tr.length&&(a=tr[d])}catch{}a||(a=i[0]);let c=parseInt(i[1]);isNaN(c)||this.seenItems.set(a,c)}this.log.debug("Loaded seen items: "+this.seenItems.size)}}static save(){let e="";for(let[t,r]of this.seenItems)r<=0||(tr.includes(t)?e+=`${tr.indexOf(t)},${r};`:e+=`${t},${r};`);this.log.debug("Seen items length: "+this.seenItems.size),this.log.debug("Serialized length: "+e.length),this.log.trace("Saving seen items: "+e),eo.setDynamicProperty(this.propertyId,e)}static isAggressiveItem(e){return e===""?!1:De.aggressiveItems.includes(e.replace("minecraft:",""))}static getAggresionMultiplier(e){return e===""?0:(e=e.replace("minecraft:",""),De.lethalItems.includes(e)?2:De.aggressiveItems.includes(e)?1:0)}static getSeenCounter(e,t){if(e==="")return 0;e=e.replace("minecraft:","");let r=this.seenItems.get(e)||0;return t&&(this.seenItems.set(e,r+1),this.save()),r}static registerSeenItem(e){if(e==="")return;e=e.replace("minecraft:","");let t=this.seenItems.get(e)||0;this.seenItems.set(e,t+1)}static reset(){this.seenItems.clear(),this.save()}};o(De,"log",x.getLogger("KnownItems")),o(De,"aggressiveItems",["wooden_sword","stone_sword","iron_sword","diamond_sword","golden_sword","netherite_sword","wooden_axe","stone_axe","iron_axe","diamond_axe","golden_axe","netherite_axe","wooden_hoe","stone_hoe","iron_hoe","diamond_hoe","golden_hoe","netherite_hoe","wooden_pickaxe","stone_pickaxe","iron_pickaxe","diamond_pickaxe","golden_pickaxe","netherite_pickaxe","wooden_shovel","stone_shovel","iron_shovel","diamond_shovel","golden_shovel","netherite_shovel","trident","fishing_rod","carrot_on_a_stick","warped_fungus_on_a_stick","stick","shears","blaze_rod","bone","flint_and_steel","flint","diamond","gold_ingot","iron_ingot","emerald","amethyst_shard","compass","clock","golden_boots","golden_chestplate","golden_helmet","golden_leggings","golden_apple","enchanted_golden_apple","golden_carrot","glistering_melon_slice","totem_of_undying","beef","cooked_beef","chicken","cooked_chicken","cod","cooked_cod","mutton","cooked_mutton","porkchop","cooked_porkchop","rabbit","cooked_rabbit","salmon","cooked_salmon","tropical_fish"]),o(De,"lethalItems",["wooden_sword","stone_sword","iron_sword","diamond_sword","golden_sword","netherite_sword","wooden_axe","stone_axe","iron_axe","diamond_axe","golden_axe","netherite_axe","trident","bow","crossbow"]),o(De,"propertyId","xp_cd:seen_items"),o(De,"seenItems",new Map);var Fe=De;var ye=class ye extends ve{constructor(t){super(t);o(this,"stateId","spy");o(this,"m_spottedWaitTime",35);o(this,"m_stareTime",0);o(this,"m_stateChangeTime",0);o(this,"m_peekingInAnimTime",1.8);o(this,"m_lastTargetLocation",l.Zero);o(this,"m_lastDwellerLocation",l.Zero);o(this,"m_initialDirection",l.Zero);o(this,"m_dweller");o(this,"m_nonStandoffEnc");o(this,"m_despawnTimeoutId");o(this,"m_peekDespawnTimeoutId");o(this,"m_runAwayDetectRunId");o(this,"m_stopTimeoutId");this.registerListener(s.dwellerEvents.staredAtGroup,this.onPlayerStare.bind(this)),this.registerListener(s.dwellerEvents.staredAtGroup,this.initialStare.bind(this),{angleRange:70}),this.registerListener(nn.afterEvents.entityHurt,this.onHurt.bind(this),{entityTypes:[s.DwellerTypeId]}),this.registerListener(s.dwellerEvents.inRange,this.onInRange.bind(this),{customRange:s.attackRange+4}),this.registerInterval(this.updateDwellerLocation.bind(this),10)}onActivate(){this.m_stareTime=0,this.m_stateChangeTime=10+s.getDifficulty()*5,this.m_despawnTimeoutId=he.runTimeout(this.forcedDespawn.bind(this),this.m_spottedWaitTime*rn),s.isPeeking()||s.isOnCeiling()?(s.setSpeed(0),s.setIsAttacking(!1)):(s.setSpeed(1),s.setIsAttacking(!0));let t=s.getDweller();if(t){this.m_dweller=t,this.m_lastDwellerLocation=l.from(t.location);let r=s.getDwellerTarget();r&&(this.m_initialDirection=l.from(r.location).subtract(t.location).setY(0).normalize())}this.m_nonStandoffEnc=nn.getDynamicProperty(s.nonStandoffEncounterTypeId)??0,this.m_stopTimeoutId=he.runTimeout(()=>{s.setSpeed(0),this.m_stopTimeoutId=void 0},60)}onDeactivate(){this.m_despawnTimeoutId!==void 0&&(he.clearRun(this.m_despawnTimeoutId),this.m_despawnTimeoutId=void 0),this.m_peekDespawnTimeoutId!==void 0&&(he.clearRun(this.m_peekDespawnTimeoutId),this.m_peekDespawnTimeoutId=void 0),this.m_runAwayDetectRunId!==void 0&&(he.clearRun(this.m_runAwayDetectRunId),this.m_runAwayDetectRunId=void 0),this.m_stopTimeoutId!==void 0&&(he.clearRun(this.m_stopTimeoutId),this.m_stopTimeoutId=void 0)}onPlayerStare(t){if(s.isPeeking()){this.m_peekDespawnTimeoutId===void 0&&this.despawnPeeking(t.dweller);return}if(this.m_despawnTimeoutId!==void 0&&(he.clearRun(this.m_despawnTimeoutId),this.m_despawnTimeoutId=void 0,t.players.forEach(r=>{s.incrementSpotted(r),s.incrementEncounterSpotted(r)})),this.m_runAwayDetectRunId===void 0){let r=s.getDwellerTarget();r&&(this.m_runAwayDetectRunId=he.runTimeout(this.detectRunAway.bind(this,r),7))}else{he.clearRun(this.m_runAwayDetectRunId);let r=s.getDwellerTarget();r&&(this.m_runAwayDetectRunId=he.runTimeout(this.detectRunAway.bind(this,r),7))}Y.stripMining&&(Math.random()<.25?s.runStripMineSequence():Y.stripMining=!1),s.canEngage(t.players[0],t.dweller)?this.m_stareTime>=this.m_stateChangeTime&&(ye.log.info("disengage in stare"),s.setState(Math.random()<this.getStandoffChance(t.dweller)?2:4)):(ye.log.debug("Disengage, cause: player left"),s.setState(4)),this.m_stareTime+=.25}initialStare(){s.setSpeed(0),s.setIsAttacking(!1)}onHurt(t){let r=t.damageSource;if(ye.log.info(`Dweller hurt by ${r}`,t),r.damagingEntity&&r.damagingEntity instanceof ba){s.setFocusTarget(r.damagingEntity);let i=r.damagingEntity.getGameMode();i===to.creative||i===to.spectator?(ye.log.debug("Disengage, cause: hurt by creative/spectator player"),s.setState(4)):(s.isOnCeiling()&&(s.jumpAt(r.damagingEntity),s.setOnCeiling(!1)),s.setDwellerTarget(r.damagingEntity),s.setState(3))}else r.damagingEntity&&r.damagingEntity.typeId!=="minecraft:player"&&s.setState(3)}onInRange(t){if(s.isPeeking()){if(this.m_peekDespawnTimeoutId===void 0){try{t.dweller.triggerEvent("xp_cd:spawn_peeking_no_peeking")}catch(a){ye.log.error("Failed to trigger peeking event",a)}this.m_peekDespawnTimeoutId=he.runTimeout(this.forcedDespawn.bind(this,t.players[0],Math.floor(Math.random()*10)+5),this.m_peekingInAnimTime*rn)}return}let r=t.players[0],i=s.getDistanceSquared(r);if(this.m_despawnTimeoutId!==void 0&&i&&i<=Math.pow(s.attackRange+4,2)&&!t.dweller.getProperty("xp_cd:from_egg")){ye.log.debug("Disengage, cause: jumpscare prevention"),s.setState(4);return}s.isOnCeiling()?i&&i<=Math.pow(s.attackRange+2,2)&&(s.setOnCeiling(!1),s.jumpAt(r)):s.isInAttackRange(r)?(s.setDwellerTarget(r),s.setState(3)):i&&i<=Math.pow(s.attackRange+4,2)&&(s.setDwellerTarget(r),s.setState(2))}updateDwellerLocation(){let t=s.getDweller();t&&(this.m_lastDwellerLocation=l.from(t.location));let r=s.getDwellerTarget();if(r&&(this.m_initialDirection.equals(l.Zero)&&(this.m_initialDirection=l.from(r.location).subtract(this.m_lastDwellerLocation).setY(0).normalize()),this.m_lastTargetLocation=l.from(r.location)),s.isPeeking()&&t&&r){let a=l.from(r.location).subtract(t.location).setY(0).normalize().angleBetween(this.m_initialDirection)*180/Math.PI;Math.abs(a)>25&&this.despawnPeeking(t)}}detectRunAway(t,r){let i;try{i=this.m_lastDwellerLocation.subtract(this.m_lastTargetLocation).setY(0).normalize()}catch(m){ye.log.error("Failed to calculate dweller direction",m);return}let a=l.from(t.getViewDirection()).setY(0).normalize(),c=i.angleBetween(a)*180/Math.PI;(c>120||c<-60)&&(this.m_dweller&&s.canEngage(t,this.m_dweller)&&Math.random()<.4?(s.setDwellerTarget(t),s.setState(3)):(ye.log.debug("Disengage, cause: runaway unable to engage"),s.setState(4)));let d=l.from(this.m_lastTargetLocation);r||he.runTimeout(this.detectRunAway.bind(this,t,d),7)}forcedDespawn(t,r){t||(t=s.getDwellerTarget()??void 0),s.remove(),Y.resetDwellerTimer(t,r??0)}getStandoffChance(t){let r=.45;this.m_nonStandoffEnc===void 0&&(this.m_nonStandoffEnc=nn.getDynamicProperty(s.nonStandoffEncounterTypeId)??0),r+=this.m_nonStandoffEnc*.05;let i=+(t.getProperty("xp_cd:light_level")??0);r+=Math.min(i/10*.05,.05);let a=s.getDwellerTarget();if(!a)return r;a.getEffects().length>0&&(r+=.05);let c=a.getComponent(ya.Equippable);if(c){let d=c.getEquipment(zt.Mainhand),m=c.getEquipment(zt.Offhand);d&&(r+=.05*Fe.getAggresionMultiplier(d.typeId),r+=Fe.getSeenCounter(d.typeId,!0)==0?.025:0),m&&(r+=m.typeId==="minecraft:shield"?.05:0,r+=Fe.getSeenCounter(m.typeId,!0)==0?.025:0),r+=c.getEquipment(zt.Head)?.0125:0,r+=c.getEquipment(zt.Chest)?.0125:0,r+=c.getEquipment(zt.Legs)?.0125:0,r+=c.getEquipment(zt.Feet)?.0125:0}return Math.min(r,.9)}despawnPeeking(t){if(this.m_peekDespawnTimeoutId===void 0){try{t.triggerEvent("xp_cd:spawn_peeking_no_peeking")}catch(r){ye.log.error("Failed to trigger peeking event",r)}this.m_peekDespawnTimeoutId=he.runTimeout(this.forcedDespawn.bind(this,void 0,Math.floor(Math.random()*10)+5),this.m_peekingInAnimTime*rn)}}};o(ye,"log",x.getLogger("SpyBehavior"));var lr=ye;import{GameMode as ro,Player as wa,system as xe,TicksPerSecond as va,world as io}from"@minecraft/server";var Ee=class Ee extends ve{constructor(t){super(t);o(this,"stateId","standoff");o(this,"m_stareTime",0);o(this,"m_stateChangeTime",60);o(this,"m_playerStareTime",[]);o(this,"m_lastDwellerLocation");o(this,"m_speedChangeTimeoutId");o(this,"m_stateChangeTimeoutId");this.registerListener(s.dwellerEvents.staredAt,this.onPlayerStare.bind(this),{angleRange:30}),this.registerListener(s.dwellerEvents.staredAtGroup,this.onGroupStare.bind(this)),this.registerListener(io.afterEvents.entityHurt,this.onHurt.bind(this),{entityTypes:[s.DwellerTypeId]}),this.registerListener(s.dwellerEvents.inRange,this.onInRange.bind(this)),this.registerInterval(this.updateDwellerLocation.bind(this),10)}onActivate(){this.m_stareTime=11-s.getDifficulty()*2;let t=s.getDweller();t&&(this.m_lastDwellerLocation=l.from(t.location)),this.m_stateChangeTimeoutId=xe.runTimeout(this.onStateChangeTime.bind(this),this.m_stateChangeTime*va),s.setSpeed(3),s.setIsAttacking(!0),s.hasStandoff=!0}onDeactivate(){this.m_playerStareTime.forEach(t=>{t.resetId!==void 0&&xe.clearRun(t.resetId)}),this.m_playerStareTime=[],this.m_speedChangeTimeoutId!==void 0&&(xe.clearRun(this.m_speedChangeTimeoutId),this.m_speedChangeTimeoutId=void 0),this.m_lastDwellerLocation=void 0,this.m_stateChangeTimeoutId!==void 0&&(xe.clearRun(this.m_stateChangeTimeoutId),this.m_stateChangeTimeoutId=void 0)}onPlayerStare(t){let r=this.m_playerStareTime.find(i=>i.playerId===t.player.id);if(r){if(r.stareTime>=this.m_stareTime){s.setDwellerTarget(t.player),s.setState(3);return}r.resetId!==void 0&&xe.clearRun(r.resetId),r.resetId=xe.runTimeout(this.resetPlayerStare.bind(this,t.player.id),7),r.lastLocation=l.from(t.player.location),r.stareTime+=.25}else{let i=t.player.id,a=xe.runTimeout(this.resetPlayerStare.bind(this,i),7);this.m_playerStareTime.push({playerId:i,stareTime:0,lastLocation:l.from(t.player.location),resetId:a})}}onGroupStare(){s.setSpeed(0),s.setIsAttacking(!1),Ee.log.info("Setting speed to 0"),this.m_speedChangeTimeoutId!==void 0&&xe.clearRun(this.m_speedChangeTimeoutId),this.m_speedChangeTimeoutId=xe.runTimeout(()=>{Ee.log.info("Setting speed to 3"),s.setSpeed(3),s.setIsAttacking(!0)},12)}updateDwellerLocation(){let t=s.getDweller();t&&(this.m_lastDwellerLocation=l.from(t.location))}onHurt(t){let r=t.damageSource;if(Ee.log.info(`Dweller hurt by ${r}`,t),r.damagingEntity&&r.damagingEntity instanceof wa){s.setFocusTarget(r.damagingEntity);let i=r.damagingEntity.getGameMode();i===ro.creative||i===ro.spectator?(Ee.log.debug("Disengage, cause: hurt by creative/spectator player"),s.setState(4)):(s.setDwellerTarget(r.damagingEntity),s.setState(3))}}onStateChangeTime(){Math.random()<.25?(Ee.log.debug("Disengage, cause: random state change"),s.setState(4)):s.setState(3)}resetPlayerStare(t){let r=this.m_playerStareTime.find(i=>i.playerId===t);r&&(r.stareTime=0,r.resetId!==void 0&&(xe.clearRun(r.resetId),r.resetId=void 0),this.m_lastDwellerLocation&&this.detectRunAway(r))}detectRunAway(t,r=!0){let i;try{i=this.m_lastDwellerLocation.subtract(t.lastLocation).setY(0).normalize()}catch(m){Ee.log.warn("Failed to detect run away",m);return}let a=io.getEntity(t.playerId);if(!a)return;let c=l.from(a.getViewDirection()).setY(0).normalize(),d=i.angleBetween(c)*180/Math.PI;Ee.log.info(`Angle between dweller and player: ${d}`),(d>120||d<-60)&&(s.canEngage(a)?(s.setDwellerTarget(a),s.setState(3)):(Ee.log.debug("Disengage, cause: runaway unable to engage"),s.setState(4))),r&&xe.runTimeout(this.detectRunAway.bind(this,t,!1),7)}onInRange(t){let r=t.players[0];s.setDwellerTarget(r),s.setState(3)}};o(Ee,"log",x.getLogger("StandoffBehavior"));var cr=Ee;var dr={};function no(){Yt(1,new lr(dr)),Yt(2,new cr(dr)),Yt(4,new Bt(dr)),Yt(3,new _t(dr))}function on(n){Object.assign(dr,n)}var Qe=class Qe extends ve{constructor(t){super(t);o(this,"stateId","engage");o(this,"m_delays",[80,160,320]);o(this,"m_minimumDisengageTime",[40,60,80]);o(this,"m_maximumDisengageDistanceSquared",Math.pow(40,2));o(this,"m_minimumDisengageDistanceSquared",Math.pow(15,2));o(this,"m_animOffset",.4);o(this,"m_closeRangeSquared",Math.pow(5,2));o(this,"m_closeRangePropertyId","xp_cd:is_target_nearby");o(this,"m_currentSpeed",7);o(this,"m_stateTime",0);o(this,"m_lastLocation");o(this,"m_stationaryTime",0);o(this,"m_kiteTime",0);o(this,"m_currentlyInCloseRange",!1);o(this,"m_triedLerningBreak",!1);o(this,"m_dwellerAttackListenerKite");o(this,"m_slowDownId");this.registerInterval(this.onDistanceCheck.bind(this),10),this.registerInterval(this.onStationaryCheck.bind(this),10),this.registerListener(ka.beforeEvents.itemUseOn,this.beforeUseOn.bind(this))}onActivate(){Xr(5*ur),this.m_currentSpeed=7,this.context[fe.IgnoreSpeedChanges]||(s.setSpeed(0),s.setIsAttacking(!1),Ze.runTimeout(()=>{s.setSpeed(this.m_currentSpeed),s.setIsAttacking(!0)},this.m_animOffset*ur)),s.setIsAttacking(!0);let t=s.getDweller();t&&(t.runCommand("playsound xp_cd.dweller.transition @a[r=48] ~ ~ ~ 1 1 0.2"),this.m_lastLocation=l.from(t.location)),this.m_slowDownId=Ze.runTimeout(this.onSlowDown.bind(this),this.m_delays[7-this.m_currentSpeed]+this.m_animOffset*ur),this.m_stateTime=Ze.currentTick,this.m_kiteTime=0,this.m_stationaryTime=0,this.m_triedLerningBreak=!1,s.hasEngaged=!0}onDeactivate(){this.m_dwellerAttackListenerKite&&(s.dwellerEvents.attack.unsubscribe(this.m_dwellerAttackListenerKite),this.m_dwellerAttackListenerKite=void 0),this.m_slowDownId!==void 0&&(Ze.clearRun(this.m_slowDownId),this.m_slowDownId=void 0);let t=s.getDwellerTarget();t&&s.resetEncounterSpotted(t),s.removeFocusTarget()}onDistanceCheck(){let t=s.getDwellerTarget();if(!t)return;let r=s.getDweller();if(!r)return;let i=s.getStaringPlayers(r,80),a=l.from(r.location).distanceSquared(t.location);if(a<this.m_closeRangeSquared?this.m_currentlyInCloseRange||(this.m_currentlyInCloseRange=!0):this.m_currentlyInCloseRange&&(this.m_currentlyInCloseRange=!1),this.m_stateTime+this.m_minimumDisengageTime[Math.max(1,s.getDifficulty())-1]*ur<Ze.currentTick&&i.length===0&&a>this.m_minimumDisengageDistanceSquared&&!r.isClimbing){s.remove(!0),Y.resetDwellerTimer(t);return}if(a>this.m_maximumDisengageDistanceSquared&&i.length===0&&!r.isClimbing){s.remove(!0),Y.resetDwellerTimer(t);return}}onStationaryCheck(){let t=s.getDweller();if(t){if(this.m_lastLocation&&l.from(t.location).distanceSquared(this.m_lastLocation)<Math.pow(3.2,2)?this.m_kiteTime++:this.m_kiteTime=0,this.m_lastLocation&&l.from(t.location).distanceSquared(this.m_lastLocation)<2?this.m_stationaryTime++:this.m_stationaryTime=0,this.m_lastLocation=l.from(t.location),this.m_stationaryTime>4){let r=s.getDwellerTarget();if(r){Qe.log.info("Stationary dweller, breaking blocks until hitting the player");let i=Q.getSkill(pt.ID);if(i.isLearned())i.breakBlocks(r,t);else if(!this.m_triedLerningBreak){this.m_triedLerningBreak=!0,i.tryLearn();let a=s.getStaringPlayers(t,80).filter(c=>c.id!==r.id);a.length>0?s.setDwellerTarget(a[0]):(Qe.log.debug("Disengage, cause: stationary dweller"),s.setState(4))}}}this.m_kiteTime>6&&this.m_dwellerAttackListenerKite===void 0&&(Qe.log.info("Kiting dweller, increasing movement speed"),this.context[fe.IgnoreSpeedChanges]||s.setSpeed(8),this.m_dwellerAttackListenerKite=s.dwellerEvents.attack.subscribe(()=>{s.dwellerEvents.attack.unsubscribe(this.m_dwellerAttackListenerKite),this.m_dwellerAttackListenerKite=void 0,this.m_stationaryTime=0,this.m_kiteTime=0,this.context[fe.IgnoreSpeedChanges]||s.setSpeed(this.m_currentSpeed)}))}}onSlowDown(){this.m_slowDownId=void 0,this.m_currentSpeed>5&&(this.m_currentSpeed--,this.context[fe.IgnoreSpeedChanges]||s.setSpeed(this.m_currentSpeed),this.m_currentSpeed>6&&(this.m_slowDownId=Ze.runTimeout(this.onSlowDown.bind(this),this.m_delays[7-this.m_currentSpeed])))}beforeUseOn(t){Qe.log.info("Before use on event",t.itemStack.typeId),t.itemStack.typeId.includes("minecraft:")&&t.itemStack.typeId.includes("bucket")&&Ze.runTimeout(()=>{if(t.source.dimension.id!==s.dimension.id)return;let r=l.from(t.block.location).add(t.blockFace),i=s.dimension.getBlock(r);i&&(i.typeId==="minecraft:water"||i.typeId==="minecraft:flowing_water")&&(i.setPermutation(R("minecraft:air")),s.dimension.spawnParticle("minecraft:water_evaporation_bucket_emitter",i.location),s.dimension.playSound("random.fizz",i.location,{volume:.4}))},1)}static forbidDespawn(){on({[fe.IgnoreStateChanges]:!0}),Ze.runTimeout(()=>{try{on({[fe.IgnoreStateChanges]:!1})}catch(t){Qe.log.error("Failed to reset context",t)}},60*ur)}};o(Qe,"log",x.getLogger("EngageBehavior"));var _t=Qe;var et=x.getLogger("Dwelling","dwelling"),ge={distance:600,createInterval:10,minY:-49,maxY:40},ht=class n{constructor(e,t){o(this,"xMultiplier");o(this,"zMultiplier");o(this,"xLoc");o(this,"zLoc");if(e instanceof l){this.xMultiplier=Math.floor(e.x/ge.distance),this.zMultiplier=Math.floor(e.z/ge.distance),this.xLoc=this.xMultiplier*600+300,this.zLoc=this.zMultiplier*600+300;return}if(t!==void 0){this.xMultiplier=e,this.zMultiplier=t,this.xLoc=e*ge.distance+300,this.zLoc=t*ge.distance+300;return}throw new Error(`Invalid dwelling chunk constructor arguments: ${e}, ${t}`)}static fromString(e){let t=e.split(",");if(t.length!==2)throw new Error(`Invalid dwelling chunk string: ${t}`);let r=parseInt(t[0]),i=parseInt(t[1]);return new n(r,i)}toString(){return`${this.xMultiplier},${this.zMultiplier}`}isMatching(e,t){return e instanceof n?this.xMultiplier===e.xMultiplier&&this.zMultiplier===e.zMultiplier:t?this.xMultiplier===Math.floor(e/ge.distance)&&this.zMultiplier===Math.floor(t/ge.distance):!1}distanceSquared(e){return Math.pow(this.xLoc-e.x,2)+Math.pow(this.zLoc-e.z,2)}},gt=class gt{constructor(){o(this,"m_activeDwellingChunksPropertyId","xp_cd:active_d");o(this,"m_activeDwellingChunks",[]);o(this,"m_activeDwellingsPropertyId","xp_cd:active_d_loc");o(this,"m_activeDwellings",[]);o(this,"m_destroyedDwellingsPropertyId","xp_cd:destro_d");o(this,"m_destroyedDwellings",[]);o(this,"m_screamTag","xp_cd_dwelling_sound");o(this,"m_brokenDwellingTagPrefix","xp_cd_dwelling_spawn");o(this,"m_eradicationThreshold",.25);o(this,"m_screamThreshold",.999);o(this,"m_spawnThresholdStep",.125);o(this,"playerPulse");o(this,"forbiddenBlockIds",["minecraft:bedrock","minecraft:barrier","minecraft:end_portal_frame","minecraft:spawner","minecraft:water","minecraft:lava","minecraft:flowing_water","minecraft:flowing_lava"]);o(this,"m_dwellingBlockIds",["xp_cd:bone_pile","xp_cd:clotted_tissue","xp_cd:dweller_pellet","xp_cd:hanging_tissue.block","xp_cd:popped_abscess","xp_cd:tangled_tissue","xp_cd:writhing_mass"]);o(this,"m_dwellingId",["xp_cd:dwelling1","xp_cd:dwelling2","xp_cd:dwelling3","xp_cd:dwelling4","xp_cd:dwelling5","xp_cd:dwelling6"]);o(this,"tryCreatingDwelling",e=>{let t=new ht(l.from(e.location));this.hasDwelling(t)||(Ne.runJob(this.createDwelling(t)),this.createDwelling(t))});this.load()}static getInstance(){return gt._instance||(gt._instance=new gt),gt._instance}save(){Se.setDynamicProperty(this.m_activeDwellingChunksPropertyId,this.m_activeDwellingChunks.map(e=>e.toString()).join(";")),Se.setDynamicProperty(this.m_destroyedDwellingsPropertyId,this.m_destroyedDwellings.map(e=>e.toString()).join(";")),Se.setDynamicProperty(this.m_activeDwellingsPropertyId,JSON.stringify(this.m_activeDwellings))}load(){let e=Se.getDynamicProperty(this.m_activeDwellingChunksPropertyId);e&&(this.m_activeDwellingChunks=e.split(";").map(ht.fromString));let t=Se.getDynamicProperty(this.m_destroyedDwellingsPropertyId);t&&(this.m_destroyedDwellings=t.split(";").map(ht.fromString));let r=Se.getDynamicProperty(this.m_activeDwellingsPropertyId);if(r){this.m_activeDwellings=[];let i=JSON.parse(r);for(let a=0;a<i.length;a++)this.m_activeDwellings.push(l.from(i[a]))}}hasDwelling(e){return[...this.m_activeDwellingChunks,...this.m_destroyedDwellings].some(t=>t.isMatching(e))}hasDestroyedDwelling(e){return this.m_destroyedDwellings.some(t=>t.isMatching(e))}getClosesActiveOrFreeLocation(e,t){let r=t.getGameMode();if(this.m_activeDwellings.length===0){r===oo.creative&&t.sendMessage({translate:"hint.xp_cd.no_dwelling"});let i=Math.floor(e.x/ge.distance),a=Math.floor(e.z/ge.distance);return l.from((i+2)*ge.distance+300,e.y,(a+2)*ge.distance+300)}else{let i=l.from(e),a=this.m_activeDwellings.reduce((c,d)=>c.distanceSquared(i)<d.distanceSquared(i)?c:d);if(r===oo.creative){let c=[{translate:"hint.xp_cd.dwelling_found"},{text:` ${a.x} ${a.y} ${a.z}`}];t.sendMessage(c)}return l.from(a.x,e.y,a.z)}}*createDwelling(e){let t=e.xLoc+Math.floor(Math.random()*120-60),r=e.zLoc+Math.floor(Math.random()*120-60),i=ge.minY;try{s.dimension.getBlock(l.from(t,i,r))}catch(c){if(c instanceof xa)return;et.fatal(c)}let a=Se.structureManager;for(;i<=ge.maxY;){let c=a.get(this.getStructureId());if(!c){et.fatal("Structure to place not found");break}let d=`xp_cd:dwelling_${t.toFixed()}_${i.toFixed()}_${r.toFixed()}_${Math.random()*100}`;a.get(d)&&a.delete(d);let m=a.createFromWorld(d,s.dimension,l.from(t,i,r),l.from(t,i,r).add(c.size),{saveMode:ao.Memory});if(!m)break;let k=c.size.x*c.size.y*c.size.z,D=0,C=!1;for(let A=0;A<c.size.x;A++){for(let G=0;G<c.size.y;G++){for(let j=0;j<c.size.z;j++){let oe=m.getBlockPermutation(l.from(A,G,j));if(oe){if(this.forbiddenBlockIds.includes(oe.type.id)||D>k*.5){C=!0;break}oe.type.id==="minecraft:air"&&D++,j%3===0&&(yield)}}if(C)break}if(C)break}if(D<k*.05&&(C=!0),!C){a.place(c,s.dimension,l.from(t,i,r)),this.m_activeDwellingChunks.push(e),this.m_activeDwellings.push(l.from(t+c.size.x/2,i+c.size.y/2,r+c.size.z/2)),this.save(),et.info(`Dwelling created at ${t}, ${i}, ${r}`);break}a.delete(d),yield,i+=5}}getStructureId(){return this.m_dwellingId[Math.floor(Math.random()*this.m_dwellingId.length)]}*checkDwelling(e){let t=e.getDynamicProperty("xp_cd:base_blocks"),r=e.getDynamicProperty("xp_cd:dwelling_x"),i=e.getDynamicProperty("xp_cd:dwelling_y"),a=e.getDynamicProperty("xp_cd:dwelling_z");if(!r||!i||!a||!t){et.error("Invalid dwelling size",e);return}let c=Se.structureManager,d=`xp_cd:dwelling_${e.id}`;c.get(d)&&c.delete(d);let m=c.createFromWorld(d,e.dimension,e.location,l.from(e.location).add(l.from(r,i,a)),{saveMode:ao.Memory}),k=0,D=!1,C=!1;for(let A=0;A<m.size.x;A++){for(let G=0;G<m.size.y;G++){for(let j=0;j<m.size.z;j++){let oe=m.getBlockPermutation(l.from(A,G,j));if(oe){if(this.m_dwellingBlockIds.includes(oe.type.id)&&k++,k>t*this.m_eradicationThreshold&&(D=!0),k>t*this.m_screamThreshold){C=!0;break}j%3===0&&(yield)}}if(C)break}if(C)break}if(et.info(`Dwelling blocks: ${k}`),D){let A=e.getDynamicProperty("xp_cd:dwelling_x")??0,G=e.getDynamicProperty("xp_cd:dwelling_y")??0,j=e.getDynamicProperty("xp_cd:dwelling_z")??0,oe=l.from(e.location).add(A/2,G/2,j/2);if(k<=Math.floor(t*this.m_screamThreshold)&&!e.hasTag(this.m_screamTag)){e.addTag(this.m_screamTag),e.dimension.getPlayers({location:e.location,maxDistance:120}).forEach(se=>{se.playSound("xp_cd.dwelling.scream",{location:l.from(se.location).add(l.from(oe).subtract(se.location).normalize().scale(3)),volume:.6})});return}for(let se=1;se<=5;se++){if(ke.isAnyHeartbeat())return;if(!e.hasTag(this.m_brokenDwellingTagPrefix+se)&&k<=Math.floor(t*(1-this.m_spawnThresholdStep*se))){let Te=e.dimension.getPlayers({location:e.location,maxDistance:120,closest:1});if(Te.length===0)return;let we=Te[0],Ge=l.from(we.getHeadLocation()),pe=l.from(we.getViewDirection()).normalize().multiply(-1),Ie=[pe,pe.rotate(l.Up,90),pe.rotate(l.Up,-90)],Dt=[we.dimension.getBlockFromRay(Ge,pe,{maxDistance:15,includeLiquidBlocks:!1,includePassableBlocks:!1}),we.dimension.getBlockFromRay(Ge,pe.rotate(l.Up,90),{maxDistance:15,includeLiquidBlocks:!1,includePassableBlocks:!1}),we.dimension.getBlockFromRay(Ge,pe.rotate(l.Up,-90),{maxDistance:15,includeLiquidBlocks:!1,includePassableBlocks:!1})];for(let de=0;de<Ie.length;de++){let Pe=Dt[de];if(Pe){if(this.shootRayDown(l.from(l.from(Pe.block.center()).add(Pe.faceLocation)),we)){e.addTag(this.m_brokenDwellingTagPrefix+se);return}}else if(this.shootRayDown(Ge.add(Ie[de].multiply(15)),we)){e.addTag(this.m_brokenDwellingTagPrefix+se);return}}if(this.shootRayDown(oe,we)){e.addTag(this.m_brokenDwellingTagPrefix+se);return}if(Math.random()<.85)return;e.dimension.getPlayers({location:e.location,maxDistance:120}).forEach(de=>{de.playSound("xp_cd.dwelling.scream",{location:l.from(de.location).add(l.from(oe).subtract(de.location).normalize().scale(3))})})}}}else{let A=l.from(e.location);Se.getAllPlayers().forEach(G=>{G.playSound("xp_cd.dwelling.eradicated",{location:l.from(G.location).add(A.subtract(G.location).normalize().scale(3)),volume:.6})}),this.dwellingDestroyed(A),e.triggerEvent("xp_cd:despawn")}}shootRayDown(e,t){let r=s.getDistanceSquared(e);if(r)return r>=Math.pow(60,2)&&(et.debug("Disengage, cause: from dwelling"),s.setState(4)),!1;let i=t.dimension.getBlockFromRay(e,l.Down,{maxDistance:5,includeLiquidBlocks:!1,includePassableBlocks:!1});if(i){_t.forbidDespawn();let a=l.from(i.block.center()).add(0,1,0);if(a.distanceSquared(t.location)>=Math.pow(5,2)){for(let c=0;c<s.minEncounterCount;c++)s.incrementSpotted(t);return t.dimension.runCommand(`fill ${a.subtract(1,1,1).toString("short"," ")} ${a.add(1,1,1).toString("short"," ")} air`),s.createDweller(a),s.setDwellerTarget(t),s.setState(3),!0}}return!1}dwellingDestroyed(e){let t=new ht(e);this.m_activeDwellingChunks=this.m_activeDwellingChunks.filter(i=>!i.isMatching(t));let r=this.m_activeDwellings.reduce((i,a)=>i.distanceSquared(e)<a.distanceSquared(e)?i:a);r.distanceSquared(e)<=Math.pow(100,2)&&(this.m_activeDwellings=this.m_activeDwellings.filter(i=>!i.equals(r))),this.m_destroyedDwellings.push(t),this.save()}isChunkSpawnable(e){let t=new ht(e);return!this.hasDestroyedDwelling(t)}scriptEvent(e){if(e.id==="xp_cd:dwelling_check"){let t=e.sourceEntity;if(!t||t.typeId!=="xp_cd:cd_dwelling"){et.error("Invalid entity",t);return}Ne.runJob(this.checkDwelling(t));return}}init(){this.load(),this.playerPulse||(this.playerPulse=new qe(this.tryCreatingDwelling.bind(this),ge.createInterval*an),this.playerPulse.start()),Ne.afterEvents.scriptEventReceive.subscribe(this.scriptEvent.bind(this),{namespaces:["xp_cd"]})}};o(gt,"_instance");var ft=gt,F=class F{constructor(){}static init(){Ne.afterEvents.scriptEventReceive.subscribe(F.scriptEvent.bind(this),{namespaces:["xp_cd"]}),Se.afterEvents.entitySpawn.subscribe(F.spawned.bind(this)),Se.afterEvents.playerInteractWithEntity.subscribe(F.interact.bind(this))}static scriptEvent(e){e.id==="xp_cd:check_moth"&&this.checkStare(e.sourceEntity)}static spawned(e){if(e.entity.typeId!=="xp_cd:moth")return;if(e.cause===Da.Event){e.entity.addTag(F.m_soundTag);return}s.getStaringPlayers(e.entity,70).length>0?e.entity.triggerEvent("xp_cd:fly_default"):F.becomeStationary(e.entity)}static interact(e){e.target.typeId==="xp_cd:moth"&&e.target.remove()}static checkStare(e){if(e===void 0||e.typeId!=="xp_cd:moth")return;let t=l.from(e.location),r=s.getStaringPlayers(t,30),i=0,a=0;r.length>0?(e.hasTag(F.m_soundTag)||(e.addTag(F.m_soundTag),r.forEach(k=>{k.playSound("xp_cd.dweller.spotted_distant")})),a=e.getDynamicProperty(F.m_starePropId),a===void 0?e.setDynamicProperty(F.m_starePropId,1):e.setDynamicProperty(F.m_starePropId,a+1),e.setDynamicProperty(F.m_hidePropId,0)):(i=e.getDynamicProperty(F.m_hidePropId),i===void 0||i===0?e.setDynamicProperty(F.m_hidePropId,1):e.setDynamicProperty(F.m_hidePropId,i+1),e.setDynamicProperty(F.m_starePropId,0));let c=e.getProperty("xp_cd:is_thrown"),d=e.getProperty("xp_cd:is_stationary"),m=e.dimension.getPlayers({location:t,maxDistance:45,closest:1});if(m.length>0&&t.distanceSquared(m[0].location)<=Math.pow(F.minDistance,2)&&d&&!c){e.triggerEvent("xp_cd:fly_default");return}(a>=3&&!c||a>=6&&c)&&d&&e.triggerEvent("xp_cd:fly_default"),i>=17&&F.becomeStationary(e)}static becomeStationary(e){let t=l.from(e.location),r=e.dimension.getPlayers({location:t,maxDistance:45,closest:1});if(r.length===0)return;if(t.distanceSquared(r[0].location)<=Math.pow(F.minDistance,2)){e.triggerEvent("xp_cd:fly_default"),e.addTag(F.m_soundTag);return}let i=l.from(r[0].location).subtract(t).toDirection(),a=F.faceDirections.filter(d=>d!==i),c=[];for(let d of a)c.push(e.dimension.getBlockFromRay(t,l.from(d),{maxDistance:25,includeLiquidBlocks:!1,includePassableBlocks:!1}));if(c=c.filter(d=>d!==void 0),c.length===0){e.triggerEvent("xp_cd:fly_default"),e.addTag(F.m_soundTag);return}else{let d=c[Math.floor(Math.random()*c.length)],m;d.face===ze.North||d.face===ze.South?m=l.from(d.block.center()).subtract(l.from(d.face)):m=l.from(d.block.center()).add(l.from(d.face)),e.teleport(m,{facingLocation:m.add(l.from(ze.North))}),e.triggerEvent("xp_cd:fly_stop"),e.triggerEvent(`xp_cd:facing_${d.face.toLowerCase()}`)}}};o(F,"faceDirections",[ze.North,ze.East,ze.South,ze.West]),o(F,"minDistance",7),o(F,"m_starePropId","xp_cd:stare_time"),o(F,"m_hidePropId","xp_cd:hide_time"),o(F,"m_soundTag","xp_cd_moth_sound");var Kr=F,Be=class Be{constructor(){o(this,"m_animationLength",2);this.onUse=this.onUse.bind(this)}onUse(e){let r=ft.getInstance().getClosesActiveOrFreeLocation(e.source.location,e.source),i=r.subtract(e.source.location).normalize(),a=l.from(e.source.getHeadLocation()).add(l.from(e.source.getViewDirection()).normalize().multiply(1.7)),c=e.source.dimension.getBlock(a);c&&!c.isAir&&(a=l.from(e.source.getHeadLocation()));let d=e.source.dimension.spawnEntity("xp_cd:moth"+"<xp_cd:throw>",a);Ne.waitTicks(this.m_animationLength*an).then(()=>{let m=Ne.runInterval(()=>{let D;try{D=d.dimension.getPlayers({location:d.location,maxDistance:18})}catch{D=[]}let C=Ne.currentTick,A=Be.m_activeMoths.find(j=>j.moth.id===d.id);if(A&&(C>=A.initTick+6*an||r.distanceSquared(d.location)<=1)||D.length===0){Ne.clearRun(m),d.triggerEvent("xp_cd:fly_default"),Be.m_activeMoths=Be.m_activeMoths.filter(j=>j.moth.id!==d.id);return}let G=d.dimension.getBlockFromRay(d.location,i,{maxDistance:1,includeLiquidBlocks:!1,includePassableBlocks:!1});if(G){let j;G.face===ze.North||G.face===ze.South?j=l.from(G.block.center()).subtract(l.from(G.face)):j=l.from(G.block.center()).add(l.from(G.face)),d.teleport(j,{facingLocation:j.add(l.from(ze.North))}),d.triggerEvent("xp_cd:fly_stop"),d.triggerEvent(`xp_cd:facing_${G.face.toLowerCase()}`),A?(Ne.clearRun(A.runId),Be.m_activeMoths=Be.m_activeMoths.filter(oe=>oe.moth.id!==d.id)):et.fatal("Lost run for moth:",d)}else d.clearVelocity(),d.applyImpulse(i.scale(.7))},2),k=Ne.currentTick;Be.m_activeMoths.push({moth:d,direction:i,runId:m,initTick:k,closestDwelling:r})}),e.source.runCommand("clear @s xp_cd:moth_item 0 1")}};o(Be,"componentId","xp_cd:moth_item"),o(Be,"m_activeMoths",[]);var pr=Be;var M=x.getLogger("DwellerSpawn"),Zr=!1,Y;(v=>{v.dwellerSpawnTime=-1,v.killDay=-1;let t=-1,r=5*tt,i=["minecraft:deepslate_lapis_ore","minecraft:deepslate_emerald_ore","minecraft:deepslate_diamond_ore","minecraft:deepslate_gold_ore","minecraft:lapis_ore","minecraft:emerald_ore","minecraft:diamond_ore","minecraft:gold_ore","minecraft:budding_amethyst","minecraft:amethyst_block","minecraft:amethyst_cluster"],a=["minecraft:stone","minecraft:deepslate","minecraft:andesite","minecraft:diorite","minecraft:granite","minecraft:dirt","minecraft:gravel","minecraft:tuff","minecraft:calcite","minecraft:dripstone_block","minecraft:grass_block","minecraft:sand","minecraft:sandstone","minecraft:oak_log","minecraft:spruce_log","minecraft:birch_log","minecraft:jungle_log","minecraft:acacia_log","minecraft:dark_oak_log","minecraft:crimson_stem","minecraft:warped_stem",...i],c=17,d=32,m="xp_cd:cd_spawner";v.stripMining=!1;let D="<xp_cd:peeking>",C="xp_cd:light_level",A="xp_cd:is_peeking",G=new Map,j=30,oe=new qe(Ge,20),se=["minecraft:zombie","minecraft:skeleton","minecraft:creeper","minecraft:spider","minecraft:enderman","minecraft:witch","minecraft:husk","minecraft:stray","minecraft:zombie_villager"],Te;function we(){oe.start(),t=W.currentTick,ne.afterEvents.entitySpawn.subscribe(u=>{let p=u.entity;p.typeId===m&&W.runTimeout(()=>{let h=p.getProperty(C);if(h>5){let X=Q.getSkill(_e.ID);if(Q.isLearned(_e.ID)||v.stripMining)M.info("Spawner has too much light, extinguishing torches"),X.extinguishNearbyTorches(p);else{M.info(`Spawner has too much light, removing (${h} > 5)`),Math.random()<.6&&(X.extinguishNearbyTorches(p),X.tryLearn(!0)),W.runTimeout(()=>p.remove(),5);return}}let y=p.getProperty(A);if(!yr(p,!1,y)){M.info("Dweller failed to spawn"),W.runTimeout(()=>p.remove(),5);return}M.info("**Dweller can spawn**");let E=l.from(p.location),f=p.dimension.getBlock(E);(!f||!f.isAir)&&(E=E.add(0,1,0));let w=vn(p.dimension,E),S=!1;w&&!v.stripMining&&(S=Zr?!0:Math.random()<.1,E=S?w:E);let q=null;if(y&&!S){let X=Ut(l.from(p.location));q=X.event,E=X.location}s.createDweller(E,q,S),W.runTimeout(()=>p.remove(),5)},5)}),ne.afterEvents.playerBreakBlock.subscribe(u=>{let p=u.brokenBlockPermutation.type.id;if(!i.some(y=>y===p))return;let h=Math.random();M.trace("Block broken, random: ",h,", chance: ",.03),h<.03&&(Ve(u.player,0),M.debug("Dweller spawnable"))}),ne.afterEvents.entityHurt.subscribe(u=>{if(!(u.hurtEntity.typeId!=="minecraft:player"||u.damageSource.cause!==so.entityAttack&&u.damageSource.cause!==so.projectile)&&W.currentTick-t>r){t=W.currentTick;let p=Math.random();M.trace("Entity hurt, random: ",p,", chance: ",.03),p<.03&&(Ve(u.hurtEntity,0),M.debug("Dweller spawnable"))}}),W.afterEvents.scriptEventReceive.subscribe(u=>{switch(u.id){case"xp_cd_spawn:dweller_spawn":vr(u.sourceEntity,u.message),ne.getPlayers().forEach(p=>{p.setDynamicProperty("xp_cd:death_time",-1)});break;case"xp_cd_spawn:current":ne.sendMessage(`Current dweller spawn cooldown: ${Math.max((v.dwellerSpawnTime-W.currentTick)/tt,0)<<0} seconds`);break;case"xp_cd_spawn:toggle_forced_ceiling":M.info("Forced ceiling spawn:",!Zr),Zr=!Zr;break;case"xp_cd_spawn:force":M.info("Forced spawn"),pe();break}},{namespaces:["xp_cd_spawn"]}),s.dwellerEvents.die.subscribe(u=>{u.isNaturalDeath||(v.killDay=ne.getDay(),ne.setDynamicProperty("xp_cd:kill_day",v.killDay))}),Wr(pe,100,1e3),W.runTimeout(()=>{v.dwellerSpawnTime===-1&&ne.getAllPlayers().forEach(u=>Ve(u))},1*tt)}v.init=we;function Ge(u){let p=G.get(u.id);if(!p||p.length===0){G.set(u.id,[l.from(u.location)]);return}if(p.length>0&&p[p.length-1].distanceSquared(l.from(u.location))<5)return;for(p.push(l.from(u.location));p.length>j;)p.shift();let h=u.getGameMode();if(!(h!==Jr.survival&&h!==Jr.adventure||(Ae(u)==="Cave"&&s.getSpotted(u)===0&&(ke.playAmbientSound(),s.incrementSpotted(u),Ve(u,2.5*60)),wn())||s.getDweller())&&p.length>5){let f=p[p.length-1],w=p[p.length-2],S=p[p.length-3],q=p[p.length-4];if(f.distanceSquared(q)<10&&w.distanceSquared(S)<10){M.info(`Player ${u.name} is backtracking`);let X=l.from(u.location);for(let te=0;te<p.length;te++)if(p[te].distanceSquared(u.location)>Math.pow(c,2)&&p[te].distanceSquared(u.location)<Math.pow(d,2)){X=p[te];break}if(X.equals(u.location)){M.info("No suitable location found");return}s.setDwellerTarget(u),u.dimension.spawnEntity(m+D,X.add(0,1,0))}}}function pe(){if(v.killDay!==-1){if(v.killDay+7>=ne.getDay())return;v.killDay=-1,ne.setDynamicProperty("xp_cd:kill_day",v.killDay),ne.getAllPlayers().forEach(w=>Ve(w))}if(s.getDweller()){M.info("Dweller already exists, skipping spawn");return}let p=Q.isLearned(Je.ID),h=ne.getTimeOfDay(),y=$(ne.getPlayers({excludeGameModes:[Jr.spectator,Jr.creative]}).filter(w=>(p&&h>13e3&&h<23e3||w.location.y<63)&&w.dimension.id===lo.overworld),h,p);if(y.length===0){M.info("No player candidates for dweller spawn");return}y.forEach(w=>{s.dwellerEvents.spawnAttempt.spawnAttempt(w.player)});let E=4,f=ft.getInstance();for(let w of y){let S=zn(w.player),q=l.from(w.player.getHeadLocation());if(f.isChunkSpawnable(q)){if(S.inStripMine){if(Ie(w.player,q,S.direction))return;let X=Q.getSkill(_e.ID),te=Math.random(),B=l.from(w.player.location).add(S.direction.scale(2.5));te<.03?(W.runTimeout(()=>{let K=Math.floor(Math.random()*4)+4,z=0,xr=W.runInterval(()=>{if(z>=K){W.clearRun(xr);return}X.extinguishNearbyTorches(B),B=B.add(S.direction.scale(5)),z++})},10),w.player.playSound("xp_cd.dweller.wind")):te<.1&&(W.runTimeout(()=>{let K=Math.floor(Math.random()*4)+4,z=0,xr=W.runInterval(()=>{if(z>=K){W.clearRun(xr);return}X.flickerNearbyTorches(B),B=B.add(S.direction.scale(5)),z++})},10),w.player.playSound("xp_cd.dweller.wind"))}else if(Math.random()<.65){if(Dt(w.player,q,E)||de(w.player,q,Math.ceil(E/2)))return}else if(de(w.player,q,Math.ceil(E/2))||Dt(w.player,q,E))return}}}function Ie(u,p,h){M.info("Strip mine spawn attempt");let y=l.from(u.getViewDirection()).normalize();if(Math.abs(y.x)>Math.abs(y.z)){if(y.x>0&&h.x===1||y.x<0&&h.x===-1)return!1}else if(y.z>0&&h.z===1||y.z<0&&h.z===-1)return!1;let E=u.dimension,f=E.getBlockFromRay(p,h,{includePassableBlocks:!1,maxDistance:35,excludeTypes:[]}),w=u.location;if(f){let S=l.from(f.block.location).add(l.from(f.faceLocation).scale(2)).setY(w.y);return h.x===0?S.setX(w.x):S.setZ(w.z),p.distanceSquared(S)<Math.pow(c,2)?!1:(M.debug("Strip mine spawn location:",S,u.location,S),s.setDwellerTarget(u),E.spawnEntity(m,S),!0)}else return s.setDwellerTarget(u),v.stripMining=!0,E.spawnEntity(m,l.from(u.location).add(h.scale(35))),!0}function Dt(u,p,h){let y=u.dimension,E=l.from(u.getViewDirection()).setY(0).normalize().scale(-1);for(let f=0;f<h;f++){let w=E.rotate(l.Up,-60+Math.random()*120).setY(l.fromYawPitch({x:0,y:Math.random()*45}).y).normalize(),S=y.getBlockFromRay(p,w,{includePassableBlocks:!1,maxDistance:30});if(S){if(Pe(S,w,p,u))return!0;continue}else{if(Ft(w,p,u))return!0;continue}}return!1}function de(u,p,h){let y=u.dimension,E=l.from(u.getViewDirection()).setY(0).normalize();for(let f=0;f<h;f++){let w=E.rotate(l.Up,-10+Math.random()*20).setY(l.fromYawPitch({x:0,y:-10+Math.random()*20}).y).normalize(),S=y.getBlockFromRay(p,w,{includePassableBlocks:!1,maxDistance:20});if(S){let q=l.from(S.block.location).add(S.faceLocation).subtract(w.scale(2)),X=[w.rotate(l.Up,90),w.rotate(l.Up,-90)];for(let te of X){let B=y.getBlockFromRay(q,te,{includePassableBlocks:!1,maxDistance:15});if(B){if(Pe(B,te,p,u,q))return!0;continue}else{if(Ft(te,p,u,q))return!0;continue}}}else{let q=p.add(w.scale(Math.floor(Math.random()*(20-c+1)+c))),X=[w.rotate(l.Up,90),w.rotate(l.Up,-90)];for(let te of X){let B=y.getBlockFromRay(q,te,{includePassableBlocks:!1,maxDistance:15});if(B){if(Pe(B,te,p,u,q))return!0;continue}else{if(Ft(w,p,u,q))return!0;continue}}}}return!1}function Pe(u,p,h,y,E){let f=y.dimension,w=f.getBlockFromRay(l.from(u.block.location).add(u.faceLocation).add(p.scale(-.5)),l.Down,{includePassableBlocks:!1,maxDistance:5});if(!w)return!1;if(h.distanceSquared(l.from(w.block.location).add(0,1,0))<Math.pow(c,2)&&!(E&&E.distanceSquared(l.from(w.block.location).add(0,1,0))>s.attackRangeSquared))return M.info("Potential location is too close to player, skipping"),Math.random()<.05&&ke.playRandomSound(y),!1;if(s.setDwellerTarget(y),v.stripMining=!1,E){let S=Ut(l.from(w.block.location).add(0,1,0));if(S.event)f.spawnEntity(m+D,S.location);else if(Math.random()<.15)return f.spawnEntity(m,l.from(w.block.bottomCenter()).add(0,1,0)),!0;return!1}else return f.spawnEntity(m,l.from(w.block.bottomCenter()).add(0,1,0)),!0}function Ft(u,p,h,y){let E=h.dimension,f=p.add(u.scale(Math.floor(Math.random()*(30-c+1)+c))),w=E.getBlockFromRay(l.from(f),l.Down,{includePassableBlocks:!1,maxDistance:5});if(!w)return!1;if(p.distanceSquared(l.from(w.block.location).add(0,1,0))<Math.pow(c,2)&&!(y&&y.distanceSquared(l.from(w.block.location).add(0,1,0))>s.attackRangeSquared))return M.info("Potential location is too close to player, skipping"),Math.random()<.05&&ke.playRandomSound(h),!1;if(s.setDwellerTarget(h),v.stripMining=!1,y){let S=Ut(l.from(w.block.location).add(0,1,0));return S.event?(E.spawnEntity(m+D,S.location),!0):Math.random()<.1?(E.spawnEntity(m,l.from(l.from(w.block.bottomCenter()).add(0,1,0))),!0):!1}else return E.spawnEntity(m,l.from(w.block.bottomCenter()).add(0,1,0)),!0}function yr(u,p,h=!1){if(ke.isAnyHeartbeat())return M.debug("Heartbeat sound playing, aborting spawn"),!1;let y;if(u instanceof Ea?y=u.location:y=u,l.from(y).setY(0).distanceSquared(l.from(s.dimension.getPlayers({closest:1})[0].location).setY(0))<Math.pow(c,2))return M.debug(`Player too close (${l.from(y).setY(0).distanceSquared(l.from(s.dimension.getPlayers({closest:1})[0].location).setY(0)).toFixed(1)}) to spawner, aborting spawn`),!1;if(y.y>63&&!Q.isLearned(Je.ID))return M.debug("Spawner above y 63 and Surface Freedom not learned, aborting spawn"),!1;if(s.getDweller()!=null)return M.debug("Dweller already exists, removing"),!1;if(s.getStaringPlayers(u,h?15:45).length>0)return M.debug("Spawner detected, aborting spawn"),!1;let E=s.dimension.getBlock(y);return E&&!E.isAir?(M.debug("Spawner is inside a block, aborting spawn"),!1):!0}v.canDwellerSpawn=yr;function wn(){return v.dwellerSpawnTime===-1?!0:W.currentTick<v.dwellerSpawnTime}v.isOnCooldown=wn;function Ve(u,p){if(u){let h=s.getSpotted(u),y;p!==void 0?y=W.currentTick+p*tt:y=W.currentTick+br(h)*tt,u.setDynamicProperty("xp_cd:spawn_tick",y)}else ne.getAllPlayers().forEach(h=>{let y=s.getSpotted(h),E;p!==void 0?E=W.currentTick+p*tt:E=W.currentTick+br(y)*tt,h.setDynamicProperty("xp_cd:spawn_tick",E)});s.hasEngaged=!1}v.resetDwellerTimer=Ve;function br(u){return s.hasEngaged?$t(u):wr(u)}function wr(u){return 60}function $t(u){let p=120;u>=0&&u<=20&&(p=120),u>20&&u<=60&&(p=2.25*(u-20)+120),u>60&&(p=.5*(u-60)+210);let h=Math.random();return h<.1?p:h<.9?p*5:p*15}function vn(u,p){let h=u.getBlockFromRay(p,l.Up,{includePassableBlocks:!1,maxDistance:25});if(h)return l.from(h.block.location).subtract(0,1.8,0)}function vr(u,p){if(u===void 0){M.warn("Missing player source, make sure this command is triggered by player");return}let h=parseInt(p);if(isNaN(h)){M.debug("Setting dweller spawn cooldown to default"),Ve(u);return}M.debug("Setting dweller spawn cooldown to",h,"seconds"),Ve(u,h)}function kn(u,p=!1){return yr(u,!0)?(s.createDweller(u,null,p),!0):!1}v.forcedSpawn=kn;function Ut(u){let p=s.dimension,h=s.getDwellerTarget();if(!h)return{event:null,location:u};let y=l.from(u).subtract(h.location).rotate(l.Up,90).normalize(),E=[u,u.add(y),u.subtract(y),u.add(y.scale(2)),u.subtract(y.scale(2)),u,u.add(y).add(0,1,0),u.subtract(y).add(0,1,0),u.add(y.scale(2)).add(0,1,0),u.subtract(y.scale(2)).add(0,1,0),u,u.add(y).subtract(0,1,0),u.subtract(y).subtract(0,1,0),u.add(y.scale(2)).subtract(0,1,0),u.subtract(y.scale(2)).subtract(0,1,0)],f=Ia(E);for(let w of f){w=w.toBlockLocation().add(.5,0,.5);let S=kr(w,p,l.from(u).subtract(h.location));if(S!==null)return{event:S,location:w}}return{event:null,location:u}}function kr(u,p,h){let y=l.from(u).toBlockLocation().add(.5,0,.5),E=p.getBlock(y);if(E&&(!E.isAir||E.isLiquid))return M.debug("Base block is not air, skipping peek event"),null;let f={left_3b:!0,right_3b:!0,top_3b:!0,bottom_3b:!0,left_1b:!0,right_1b:!0,top_1b:!0,bottom_1b:!0,corner_bottom_left:!0,corner_bottom_right:!0,corner_top_left:!0,corner_top_right:!0},w;Math.abs(h.x)>Math.abs(h.z)?w=h.x>0?l.from(1,0,0):l.from(-1,0,0):w=h.z>0?l.from(0,0,1):l.from(0,0,-1);let S=w.rotate(l.Up,90).normalize(),q=w.rotate(l.Up,-90).normalize(),X=`xp_cd:temp_peek_${Math.floor(Math.random()*1e3)}`,te=ne.structureManager,B;try{B=te.createFromWorld(X,s.dimension,y.add(S).add(l.Up),y.add(q).add(l.Down).add(w),{includeEntities:!1,saveMode:Ta.Memory})}catch(Ue){return M.debug("Error creating structure",Ue),null}if(!B)return M.debug("Error creating structure"),null;let K=Dr(w),z=[[[Z(B,K.add(S.add(l.Up))),Z(B,K.add(l.Up)),Z(B,K.add(q.add(l.Up)))],[Z(B,K.add(S)),Z(B,K.add(l.Zero)),Z(B,K.add(q))],[Z(B,K.add(S.add(l.Down))),Z(B,K.add(l.Down)),Z(B,K.add(q.add(l.Down)))]],[[Z(B,K.add(S.add(l.Up).add(w))),Z(B,K.add(l.Up.add(w))),Z(B,K.add(q.add(l.Up).add(w)))],[Z(B,K.add(S.add(w))),Z(B,K.add(l.Zero.add(w))),Z(B,K.add(q.add(w)))],[Z(B,K.add(S.add(l.Down).add(w))),Z(B,K.add(l.Down.add(w))),Z(B,K.add(q.add(l.Down).add(w)))]]];if(te.delete(X),z.some(Ue=>Ue.some(jt=>jt.some(oi=>oi===-1))))return M.debug("Peek near water, skipping"),null;if(z[1].reduce((Ue,jt)=>Ue+jt.reduce((oi,Po)=>oi+Po,0),0)>=8||z[1][1][1]===1)return M.debug("Back side is blocked, skipping peek event"),null;if(M.debug("Detecting peek event"),z[0][0][0]===0&&(f.left_3b=!1,f.top_3b=!1,f.corner_top_left=!1),z[0][0][2]===0&&(f.right_3b=!1,f.top_3b=!1,f.corner_top_right=!1),z[0][2][0]===0&&(f.left_3b=!1,f.bottom_3b=!1,f.corner_bottom_left=!1),z[0][2][2]===0&&(f.right_3b=!1,f.bottom_3b=!1,f.corner_bottom_right=!1),z[0][1][0]===0&&(f.left_1b=!1,f.left_3b=!1,f.corner_bottom_left=!1,f.corner_top_left=!1,f.top_1b=!1,f.bottom_1b=!1),z[0][1][2]===0&&(f.right_1b=!1,f.right_3b=!1,f.corner_top_right=!1,f.corner_bottom_right=!1,f.top_1b=!1,f.bottom_1b=!1),z[0][0][1]===0&&(f.top_1b=!1,f.top_3b=!1,f.corner_top_left=!1,f.corner_top_right=!1,f.left_1b=!1,f.right_1b=!1),z[0][2][1]===0&&(f.bottom_1b=!1,f.bottom_3b=!1,f.corner_bottom_left=!1,f.corner_bottom_right=!1,f.left_1b=!1,f.right_1b=!1),!Object.values(f).some(Ue=>Ue===!0))return M.debug("No peek possibilities 1, no front row possibilities"),null;(f.left_3b||f.left_1b)&&z[1][1][0]===1&&(f.left_3b=!1,f.left_1b=!1),(f.right_3b||f.right_1b)&&z[1][1][2]===1&&(f.right_3b=!1,f.right_1b=!1),(f.top_3b||f.top_1b)&&z[1][0][1]===1&&(f.top_3b=!1,f.top_1b=!1),(f.bottom_3b||f.bottom_1b)&&z[1][2][1]===1&&(f.bottom_3b=!1,f.bottom_1b=!1),f.corner_bottom_left&&(z[1][2][0]===1||z[1][1][0]===1&&z[1][2][1]===1)&&(f.corner_bottom_left=!1),f.corner_bottom_right&&(z[1][2][2]===1||z[1][1][2]===1&&z[1][2][1]===1)&&(f.corner_bottom_right=!1),f.corner_top_left&&(z[1][0][0]===1||z[1][2][0]===1&&z[1][0][1]===1)&&(f.corner_top_left=!1),f.corner_top_right&&(z[1][0][2]===1||z[1][2][2]===1&&z[1][0][1]===1)&&(f.corner_top_right=!1);let ni=Object.entries(f).filter(([Ue,jt])=>jt);return ni.length===0?(M.debug("No peek possibilities 2, no back row possibilities"),null):`xp_cd:spawn_peeking_${ni[Math.floor(Math.random()*ni.length)][0]}`}function Dr(u){switch(u.toString()){case l.from(1,0,0).toString():return l.from(0,1,1);case l.from(-1,0,0).toString():return l.from(1,1,1);case l.from(0,0,1).toString():return l.from(1,1,0);case l.from(0,0,-1).toString():return l.from(1,1,1);default:return l.from(1,1,1)}}function Z(u,p){let h=u.getBlockPermutation(p);if(!h)return 0;let y=h.type.id;return y==="minecraft:water"||y==="minecraft:lava"?-1:a.includes(y)?1:0}function Dn(){Te===void 0&&(Te=ne.afterEvents.entitySpawn.subscribe(u=>{if(M.info("Decreasing spawn chance"),u.cause===Sa.Spawned&&se.includes(u.entity.typeId)&&Math.random()<.4){M.debug("removed entity",u.entity.typeId);try{u.entity.remove()}catch{}}}))}function Io(){Te!==void 0&&(ne.afterEvents.entitySpawn.unsubscribe(Te),Te=void 0)}function $(u,p,h=!1){let y=[],E=[],f=s.getFocusTarget(),w="-1";if(f){let S=f.location;(h&&p>13e3&&p<23e3||f.location.y<63)&&f.dimension.id===lo.overworld&&(y.push({player:f,depth:S.y,isDwellersFocus:!0}),w=f.id)}for(let S of u){if(S.id===w||(S.getDynamicProperty("xp_cd:spawn_tick")??0)>W.currentTick)continue;let X=S.getDynamicProperty("xp_cd:death_time")??-1;(X===-1||W.currentTick-X>20*60*tt)&&E.push({player:S,depth:S.location.y,isDwellersFocus:!1})}return[...y,...E.sort((S,q)=>S.depth-q.depth)]}})(Y||(Y={}));function Ia(n){return n.map(e=>({random:Math.random(),item:e})).sort((e,t)=>e.random-t.random).map(e=>e.item)}function Wr(n,e,t){let r=()=>{try{n()}catch(i){M.error("Error while running random interval",i)}W.runTimeout(r,Math.random()*(t-e)+e)};W.runTimeout(r,Math.random()*(t-e)+e)}import{EntityComponentTypes as co,EntityDamageCause as Pa,EntityEquippableComponent as Ca,EquipmentSlot as Qr,HudElement as La,ItemDurabilityComponent as Aa,ItemEnchantableComponent as Ma,Player as Ra,system as $e,TicksPerSecond as sn}from"@minecraft/server";var uo="xp_cd_dragged_player",Ba="xp_cd:dragging",za="xp_cd:not_dragging",Na=3,po=2.43,Oa=2.56,mo=1.9;function ln(){s.dwellerEvents.attack.subscribe(n=>{if(!(n.entity instanceof Ra))return;let e=n.entity,t=n.dweller,r=e.getComponent(co.Health),i=s.getDamageValue(e);if(r&&i>=r.currentValue){let c=e.getComponent(co.Equippable);if(c){let d=c.getEquipment(Qr.Offhand);if(d&&d.typeId==="minecraft:totem_of_undying")return}n.damage=0,s.dwellerEvents.killedPlayer.kill(t,e),s.clearDwellerTarget(),s.setSpeed(0),e.addTag(uo),t.triggerEvent(Ba),$e.runTimeout(()=>{let d=t.getProperty("xp_cd:kill_anim");d&&+d==1?e.playAnimation("animation.xp_cd.player.dragged",{controller:"__xp_cd_dragging"}):e.playAnimation("animation.xp_cd.player.held",{controller:"__xp_cd_dragging"}),ci.setInputPermission(e,Sr.Movement,!1),e.onScreenDisplay.hideAllExcept([La.ItemText]),e.runCommand(`/ride @s start_riding @e[type=${s.DwellerTypeId}] teleport_ride`),$e.runTimeout(()=>{Va(t,d?+d!=1:!0)},2),$e.runTimeout(()=>{e.camera.fade({fadeColor:{blue:0,green:0,red:0},fadeTime:{fadeInTime:.1,holdTime:2,fadeOutTime:3}}),$e.runTimeout(()=>{if(e.removeTag(uo),t.triggerEvent(za),ci.setInputPermission(e,Sr.Movement,!0),e.onScreenDisplay.resetHudElements(),c){let m=c.getEquipment(Qr.Offhand);m&&m.typeId==="minecraft:totem_of_undying"&&(e.dimension.spawnItem(m,l.from(e.location).add(0,1,0)),c.setEquipment(Qr.Offhand))}e.runCommand("/ride @s stop_riding"),$e.runTimeout(()=>{e.setDynamicProperty("xp_cd:death_time",$e.currentTick),e.applyDamage(1e3,{cause:Pa.entityAttack,damagingEntity:t})},1),Ha(t,e.id)},d&&+d==1?Na-po:(Oa-mo)*sn)},(d&&+d==1?po:mo)*sn)},2)}})}var Ga=["minecraft:grass","minecraft:dirt","minecraft:gravel","minecraft:sand","minecraft:andesite","minecraft:diorite","minecraft:granite","minecraft:tuff","minecraft:deepslate","minecraft:stone","minecraft:cobblestone","minecraft:web"];function Va(n,e){for(let t of Ga)n.runCommand(`fill ${e?"~-1 ~ ~-1 ~1 ~2 ~1":"~-1 ~ ~-1 ~1 ~1 ~1"} air replace ${t}`)}function yt(n){if(n){let e=0,t=.75,r=0,i=n.getComponent(Aa.componentId);i&&(t=(i.maxDurability-i.damage)/i.maxDurability);let a=n.getComponent(Ma.componentId);if(a){let c=a.getEnchantment("protection")?.level;c&&(r=c)}return e=Math.ceil(qa(n.typeId)*t),{armour:e,epf:r}}return{armour:0,epf:0}}function qa(n){switch(n.replace("minecraft:","")){case"leather_helmet":case"leather_boots":case"golden_boots":case"chainmail_boots":return 1;case"diamond_helmet":case"netherite_helmet":case"leather_chestplate":case"golden_leggings":case"diamond_boots":return 3;case"chainmail_leggings":return 4;case"golden_chestplate":case"chainmail_chestplate":case"iron_leggings":return 5;case"iron_chestplace":case"diamond_leggings":case"netherite_leggings":return 6;case"diamond_chestplate":case"netherite_chestplate":return 8;default:return 2}}function Ha(n,e){let t=s.getStaringPlayers(n,70).filter(r=>r.id!==e);if(t.length===0)log.debug("Disengage, cause: finish death scene"),s.setState(4);else{let r=t.sort((a,c)=>l.from(n.location).distanceSquared(a.location)-l.from(n.location).distanceSquared(c.location))[0];s.setDwellerTarget(r);let i=s.getDistanceSquared(r);n.runCommand("playsound xp_cd.dweller.breathing @a[r=48] ~ ~ ~ 1 1 0.3"),$e.runTimeout(()=>{s.setState(2),$e.runTimeout(()=>s.setState(3),1)},(i&&i>Math.pow(12,2)?4:2)*sn)}}$e.afterEvents.scriptEventReceive.subscribe(n=>{let e=x.getLogger("main");if(n.id==="xp_cd:item"){let r=n.sourceEntity.getComponent(Ca.componentId).getEquipment(Qr.Chest);e.info(yt(r))}});var N=(a=>(a[a.NONE=0]="NONE",a[a.SPY=1]="SPY",a[a.STAND_OFF=2]="STAND_OFF",a[a.ENGAGE=3]="ENGAGE",a[a.DISENGAGE=4]="DISENGAGE",a))(N||{});var ae,Nt=go.overworld,Ot=1,ho=0;var ti=-1,L=x.getLogger("Dweller","dweller"),Oe=!1,I={state:0,isOnCeiling:!1,targetType:0,spotted:{}},T=class T{static init(){let e=this.getDweller(!0);if(this.loadData(),e){let r=e.getProperty("xp_cd:state");I.state=N[r];let i=this.getDwellerTarget(),a=this.dimension.getPlayers({location:e.location,maxDistance:64,closest:1});a.length>0?(!i||J.getEntity(i.id)===void 0)&&this.setDwellerTarget(a[0]):this.remove(),this.setState(r===0?0:r===1?1:r===4?2:r===5?3:4,!0)}this.dwellerEvents.die.subscribe(()=>{this.setState(0)}),this.dwellerEvents.hurt.subscribe(r=>{let i=r.dweller.getComponent($a.Health);i&&i.currentValue/i.effectiveMax<.15&&this.setState(4)}),J.afterEvents.entityRemove.subscribe(r=>{r.typeId===T.DwellerTypeId&&this.setState(0)}),J.afterEvents.entityLoad.subscribe(r=>{if(r.entity.typeId===T.DwellerTypeId){r.entity.remove();let i=this.getDweller(!0);(!i||i.id!==r.entity.id)&&this.setState(0)}}),J.afterEvents.playerLeave.subscribe(r=>{let i=this.getDwellerTarget();if(i&&i.id!==r.playerId)return;let a=this.getDweller();if(!a)return;let c=this.dimension.getPlayers({location:a.location,maxDistance:64,closest:1});c.length>0?this.setDwellerTarget(c[0]):(L.debug("Disengage, cause: player left"),T.setState(4))}),J.afterEvents.playerGameModeChange.subscribe(r=>{let i=T.getDwellerTarget();if(!(i&&r.player.id!==i.id)&&(!i||r.toGameMode===rt.spectator||r.toGameMode===rt.creative)){let a=this.dimension.getPlayers({location:r.player.location,maxDistance:64,closest:1,excludeGameModes:[rt.spectator,rt.creative]})[0];a?this.setDwellerTarget(a):(L.debug("Disengage, cause: player change gamemode"),T.setState(4))}}),J.afterEvents.dataDrivenEntityTrigger.subscribe(r=>{T.setState(3),ee.runTimeout(()=>{r.entity.dimension.getEntities({location:r.entity.location,maxDistance:5,excludeGameModes:[rt.spectator,rt.creative]}).forEach(i=>{let a=l.from(i.location).subtract(r.entity.location).setY(0).normalize().multiply(2).setY(.5);i.applyImpulse(a),i.addEffect("slowness",2*ei,{amplifier:2,showParticles:!0})})},2)},{eventTypes:["xp_cd:reenter_engage"],entityTypes:["xp_cd:cave_dweller"]});let t=ee.currentTick;J.beforeEvents.itemUseOn.subscribe(r=>{if(r.itemStack.typeId==="xp_cd:cave_dweller_spawn_egg"){if(ee.currentTick-t<5){r.cancel=!0;return}if(r.source.dimension.id!==go.overworld){r.source.sendMessage({translate:"xp_cd:cave_dweller.spawn_egg.fail_dimension",with:[`
`]}),r.cancel=!0;return}if(t=ee.currentTick,r.cancel=!0,r.source.dimension.getEntities({type:"xp_cd:cave_dweller"}).length>0){r.source.sendMessage({translate:"xp_cd:cave_dweller.spawn_egg.fail",with:[`
`]});return}let a=r.blockFace===Fa.Down,c=l.from(r.block.location).add(a?l.Down.scale(2):r.faceLocation);ee.run(()=>{T.createDweller(c,"xp_cd:from_egg",a),r.source.getGameMode()!==rt.creative&&r.source.runCommand("/clear @s xp_cd:cave_dweller_spawn_egg 0 1")})}}),ee.afterEvents.scriptEventReceive.subscribe(r=>{switch(r.id){case"xp_cd_event:remove_dweller":T.remove(r.message!==void 0?+r.message>0:!1);break}},{namespaces:["xp_cd_event"]})}static getState(){return I.state}static setState(e,t=!1){if(T.isDespawning()){L.info("Aborting state change due to despawning");return}let r=I.state;if(Oe&&!t){L.debug(`State is locked, tried to change state from ${r} to ${e}`);return}let i=di(I.state),a=di(e),c;t?c={deactivateStates:[],activationStates:a}:c=Pn(i,a),c.deactivateStates.forEach(m=>{m.deactivate()}),I.state=e,c.activationStates.forEach(m=>{L.info(`Activating state ${m.stateId}`),m.activate()});let d=this.getDweller();d?(r!==e&&this.dwellerEvents.stateChange.onStateChange(d,r,e),d.setProperty("xp_cd:state",Object.keys(N).indexOf(N[e].toString())%(Object.keys(N).length/2<<0))):L.warn('Dweller entity "xp_cd:state" property has not been set, due to Dweller entity not existing')}static isAttacking(){return!!I.isAttacking}static setIsAttacking(e){let t=this.getDweller();t&&e!==I.isAttacking&&(e?(I.range===void 0&&(I.range=1),t.triggerEvent("xp_cd:attack_"+(I.range-1))):t.triggerEvent("xp_cd:disable_attack"),I.isAttacking=e)}static setAttackRange(e){if(e=e<<0,e<1||e>8){L.warn(`Invalid speed ${e}. Valid speeds are 1-8.`);return}let t=this.getDweller();t&&e!==I.range&&(I.range=e,I.isAttacking&&t.triggerEvent("xp_cd:attack_"+(I.range-1)))}static getDamageValue(e){let r=T.getDifficulty(),i=T.damage[r];if(!(e instanceof Ya))return i;let a=i,c=e.getComponent(ja.componentId);if(c){let m=[yt(c.getEquipment(mr.Offhand)),yt(c.getEquipment(mr.Chest)),yt(c.getEquipment(mr.Head)),yt(c.getEquipment(mr.Legs)),yt(c.getEquipment(mr.Feet))].reduce((k,D)=>k+D.armour,0);a=i*(1-Math.min(20,Math.max(Math.min(15,m)/5,Math.min(15,m)-4*i/8))/25)}return a}static getDweller(e){if((!ae||!ae.isValid())&&(ae=void 0,I.isAttacking=void 0,e)){let t=Tt(Nt).getEntities({type:this.DwellerTypeId});if(t.length===0)return;if(t.length>1){L.warn("Found more than one dweller, removing all but one");for(let r=0;r<t.length;r++)t[r].remove()}ae=t[0]}return ae}static setDwellerTarget(e){if(this.clearDwellerTarget(),e.addTag(this.TargetTag),I.targetType!==0){I.targetType=0;let t=this.getDweller();if(!t)return;t.triggerEvent(this.PlayerTargetEvent)}}static setDwellerItemTarget(e){if(e.addTag(this.ItemTargetTag),I.targetType===1)return;I.targetType=1;let t=this.getDweller();t&&t.triggerEvent(this.ItemTargetEvent)}static setDwellerAnimalTarget(e){if(e.addTag(this.AnimalTargetEvent),I.targetType===2)return;I.targetType=2;let t=this.getDweller();t&&t.triggerEvent(this.AnimalTargetEvent)}static clearDwellerTarget(){Tt(Nt).runCommand(`execute as @e[tag=${this.TargetTag}] run tag @s remove ${this.TargetTag}`)}static getDwellerTarget(){let e=Tt(Nt).getEntities({tags:[this.TargetTag],type:"minecraft:player"});return e.length>0?e[0]:null}static isVisibleByDweller(e,t=45){let r=this.getDweller();if(!r)return!1;let i=l.from(r.location).add(0,1,0),a=l.from(e.getHeadLocation());if(i.almostEqual(a,2))return!0;let c=l.from(r.getViewDirection()),d=a.subtract(i).normalize(),m=Math.PI/180*t;return c.angleBetween(d)<m}static getStaringPlayers(e,t=11.25){let r;if(!e&&(e=T.getDweller(),!e))return[];if(e instanceof _o)try{r=l.from(e.location).add(0,1,0)}catch{return[]}else{if(e===null)return[];r=l.from(e)}let i=Tt(Nt);return i.getPlayers({maxDistance:48,location:r,excludeGameModes:[rt.spectator]}).filter(c=>{let d=l.from(c.getHeadLocation());if(r.almostEqual(d,1))return!0;let m=l.from(c.getViewDirection()),k=r.subtract(d).normalize(),D=Math.PI/180*t;if(m.angleBetween(k)<D){let A=d.distance(r),G=i.getBlockFromRay(d,k,{maxDistance:(A<<0)+2,includePassableBlocks:!1,includeLiquidBlocks:!1});return G===void 0||l.from(G.block.location).add(G.faceLocation).distance(r)>A+1}return!1})}static setSpeed(e){if(e<0||e>8){L.warn(`Invalid speed ${e}. Valid speeds are 1-7.`);return}if(I.speed===e)return;let t=this.getDweller();t&&(L.debug("Setting dweller speed to "+e),t.triggerEvent("xp_cd:speed_"+(e-1<<0)),I.speed=e)}static createDweller(e,t=null,r=!1){L.info(`Dweller is ${r?"on ceiling":"on ground"}`),T.getDwellerTarget()||L.error("Creating dweller without target!");let a=Tt(Nt);t?I.isPeeking=t.includes("peek"):(t="minecraft:entity_spawned",I.isPeeking=!1);let c=`${this.DwellerTypeId}<${t}>`,d=a.spawnEntity(c,e);return ae=d,I.speed=void 0,I.range=void 0,I.isAttacking=void 0,I.isOnCeiling=void 0,I.targetType=0,I.fromEgg=t.includes("egg"),T.setOnCeiling(r),Q.setupEntity(d),this.setState(1),this.dwellerEvents.spawn.spawn(d,r),d}static setTargetType(e){if(I.targetType===e)return;I.targetType=e;let t=this.getDweller();t&&(e===1?t.triggerEvent(this.ItemTargetEvent):e===2?t.triggerEvent(this.AnimalTargetEvent):t.triggerEvent(this.PlayerTargetEvent))}static isOnCeiling(){return I.isOnCeiling??!1}static setOnCeiling(e){if(L.info(`Setting dweller on ceiling to ${e}`),I.isOnCeiling===e){L.info(`Dweller is already ${e?"on ceiling":"on ground"}`);return}let t=this.getDweller();if(!t){L.info("Dweller is not spawned");return}e?(L.info("Setting dweller to be on ceiling"),t.triggerEvent("xp_cd:disable_gravity")):(L.info("Setting dweller to be on ground"),t.triggerEvent("xp_cd:enable_gravity")),I.isOnCeiling=e}static jumpAt(e){if(!I.isOnCeiling)return;I.isOnCeiling=!1;let t=this.getDweller();if(!t)return;t.triggerEvent("xp_cd:enable_gravity"),t.applyImpulse(l.from(e.location).subtract(l.from(t.location)).divide(4));let r=30,i=0,a=ee.runInterval(()=>{if(!t.isValid()||!e.isValid())return;let c=l.from(e.location);if(l.from(t.location).distanceSquared(c)<2&&(e.applyDamage(0,{cause:Ua.magic,damagingEntity:t}),ee.clearRun(a)),i++,i>r){ee.clearRun(a);return}},1)}static remove(e=!1){if(L.info("Removing dweller"),ae)try{this.setState(0);let t=J.getDynamicProperty(T.nonStandoffEncounterTypeId)??0;if(T.hasStandoff?(J.setDynamicProperty(T.nonStandoffEncounterTypeId,0),T.hasStandoff=!1):J.setDynamicProperty(T.nonStandoffEncounterTypeId,t+1),e)ae.remove();else{ae.triggerEvent("xp_cd:start_despawning"),ae.runCommand("playsound xp_cd.dweller.disappear @a[r=48] ~ ~ ~ 0.8 1 0.2");let r=T.dwellerEvents.hurt.subscribe(i=>{i.damager&&(T.setFocusTarget(i.damager),L.info("Refocusing dweller to hurt player"),r&&(T.dwellerEvents.hurt.unsubscribe(r),r=void 0))});ee.runTimeout(()=>{r&&(T.dwellerEvents.hurt.unsubscribe(r),r=void 0)},3*ei)}}catch(t){L.error("Failed to remove dweller",t)}}static getDistanceSquared(e){if(ae)return l.from(ae.location).distanceSquared(l.from(e instanceof _o?e.location:e))}static isInAttackRange(e){let t=this.getDistanceSquared(e);return t===void 0?!1:t<=T.attackRangeSquared}static getDifficulty(){if(I.difficulty!==void 0)return I.difficulty;if(!ae)return 2;let e=ae.getProperty("xp_cd:game_d");if(e===void 0)return 2;let t=+e;return isNaN(t)?2:(I.difficulty=t,t)}static getLightLevel(){if(!ae)return 0;let e=ae.getProperty("xp_cd:light_level");if(e===void 0)return 0;let t=+e;return isNaN(t)?0:t}static loadData(){let e=J.getDynamicProperty("xp_cd:dweller_ns");e?Ot=N[e]:Ot=1;let t=J.getDynamicProperty("xp_cd:next_dweller_spawn");t&&(Y.dwellerSpawnTime=+t);let r=J.getDynamicProperty("xp_cd:addon_init_time");r?ti=+r:(ti=ee.currentTick,J.setDynamicProperty("xp_cd:addon_init_time",ti));let i=J.getDynamicProperty("xp_cd:kill_day");i&&(Y.killDay=+i)}static saveData(){J.setDynamicProperty("xp_cd:dweller_ns",N[Ot]),J.setDynamicProperty("xp_cd:next_dweller_spawn",Y.dwellerSpawnTime)}static setNextSpawnState(e){Ot=e,this.saveData()}static incrementSpotted(e){let t=e.getDynamicProperty("xp_cd:encounters")??0;return e.setDynamicProperty("xp_cd:encounters",t+1),t+1}static getSpotted(e){return e.getDynamicProperty("xp_cd:encounters")??0}static incrementEncounterSpotted(e){let t=e.getDynamicProperty("xp_cd:encounter_spot")??0;e.setDynamicProperty("xp_cd:encounter_spot",t+1)}static getEncounterSpotted(e){return e.getDynamicProperty("xp_cd:encounter_spot")??0}static resetEncounterSpotted(e){e?e.setDynamicProperty("xp_cd:encounter_spot",0):J.getAllPlayers().forEach(t=>{t.setDynamicProperty("xp_cd:encounter_spot",0)})}static isPeeking(){return I.isPeeking??!1}static isDespawning(){return I.isDespawning??!1}static canEngage(e,t){if(t&&(t.getProperty("xp_cd:from_egg")??!1))return L.debug("Dweller is from spawn egg, can engage"),!0;let r=T.getEncounterSpotted(e),i=T.getSpotted(e);return r>=T.minEncounterSpottedCount&&i>=T.minEncounterCount}static getAddonTime(){return(ee.currentTick-ti)/ei}static getFocusTarget(){return I.focus}static setFocusTarget(e){I.focus=e}static removeFocusTarget(){I.focus=void 0}static isSpawnedFromEgg(){return I.fromEgg}static runStripMineSequence(){let e=this.getDweller();if(!e)return;let t=this.getDwellerTarget();if(!t)return;let r=l.from(t.location).subtract(l.from(e.location)).normalize().scale(5),i=l.from(e.location),a=l.from(e.location).subtract(r),c=Q.getSkill(_e.ID),d=e.dimension.getPlayers({location:e.location,maxDistance:45});d.forEach(m=>{m.playSound("xp_cd.dweller.idle.spy")}),ee.runTimeout(()=>{d.forEach(k=>{k.playSound("xp_cd.dweller.secret")}),ee.runTimeout(()=>{T.setState(3)},4.5*ei),T.setSpeed(3);let m=ee.runInterval(()=>{let k=T.getDwellerTarget();if(!k){ee.clearRun(m);return}let D=l.from(k.location);if(i.distanceSquared(D)<Math.pow(2,2)){c.extinguishNearbyTorches(D),ee.clearRun(m),Y.stripMining=!1;return}i=i.add(r),c.extinguishNearbyTorches(i),c.extinguishNearbyTorches(a),a=i.subtract(r)},10)},50)}};o(T,"DwellerTypeId","xp_cd:cave_dweller"),o(T,"TargetTag","xp_cd_dweller_target"),o(T,"ItemTargetTag","xp_cd_dweller_target_item"),o(T,"AnimalTargetTag","xp_cd_dweller_target_animal"),o(T,"ItemTargetEvent","xp_cd:target_items"),o(T,"PlayerTargetEvent","xp_cd:target_player"),o(T,"AnimalTargetEvent","xp_cd:target_animal"),o(T,"nonStandoffEncounterTypeId","xp_cd:non_standoff"),o(T,"attackRange",5),o(T,"attackRangeSquared",Math.pow(T.attackRange,2)),o(T,"damage",[4,5,8,12]),o(T,"dimension",J.getDimension(Nt)),o(T,"hasEngaged",!1),o(T,"hasStandoff",!1),o(T,"StareCheckRate",5),o(T,"minEncounterCount",5),o(T,"minEncounterSpottedCount",3),o(T,"dwellerEvents",Ir.instance);var s=T;ee.afterEvents.scriptEventReceive.subscribe(n=>{if(n.id==="xp_cd:state"){n.message||L.warn("Received xp_cd:state event with no state");let e=null;if(isNaN(+n.message)?e=N[n.message.toUpperCase()]:e=N[+n.message],!e){L.warn(`Received xp_cd:state event with invalid state ${n.message}`);return}L.info(`Setting dweller state to ${e}`);let t=Oe;Oe=!1,s.setState(e),Oe=t}else if(n.id==="xp_cd:target")L.info("Setting target for dweller"),s.setDwellerTarget(n.sourceEntity);else if(n.id==="xp_cd:get_target"){let e=s.getDwellerTarget();e?L.info(`Dweller is targeting ${e.name}`):L.info("Dweller is not targeting anything")}else if(n.id==="xp_cd:create"){if(s.getDweller(!0)){L.warn("Dweller already exists");return}if(!n.sourceEntity){L.warn("This needs to be called by an entity");return}let t=n.message.split(";"),r=null,i=n.sourceEntity.location,a=null,c=!1;if(n.message){if(isNaN(+t[0])?r=N[t[0].toUpperCase()]:r=N[+t[0]],!r){L.warn(`Received xp_cd:state event with invalid state ${t[0]}`);return}let d=t[1].replace(/[^\d. -]+/g,"").split(" ");d.length===3?i=l.from(+d[0],+d[1],+d[2]):L.warn(`Received xp_cd:create event with invalid location ${t[1]}`),t[2]&&(t[2].startsWith("minecraft:")||t[2].startsWith("xp_cd:"))&&(a=t[2]),(t[3]==="true"||t[3]==="1")&&(c=!0)}else r=1;L.info(`Creating dweller with state ${r}`),s.setNextSpawnState(r),s.createDweller(i,a,c)}else if(n.id==="xp_cd:set_next_state"){let e;if(isNaN(+n.message)?e=N[n.message.toUpperCase()]:e=N[+n.message],!e){L.warn(`Received xp_cd:set_next_state event with invalid state ${n.message}`);return}L.info(`Setting next state to be ${e}`),s.setNextSpawnState(e)}else if(n.id==="xp_cd:get_next_state")L.info(`Next state is ${N[J.getDynamicProperty("xp_cd:dweller_ns")]}`);else if(n.id==="xp_cd:reset")ho=0,Ot=1,J.getPlayers().forEach(e=>Y.resetDwellerTimer(e)),s.remove(),Q.reset(),s.saveData();else if(n.id==="xp_cd:lock_state")Oe=!Oe,L.info(`State lock is now ${Oe}`);else if(n.id==="xp_cd:reenter_state"){let e=Oe;Oe=!1;let t=s.getState();s.setState(0),s.setState(t),Oe=e}else if(n.id==="xp_cd:speed"){let e=+n.message;if(isNaN(e)||e<0||e>7){L.warn(`Received xp_cd:speed event with invalid speed ${n.message}`);return}s.setSpeed(e)}else if(n.id==="xp_cd:set_despawning"){let e=n.message==="1";I.isDespawning=e,L.info(`Setting despawning to ${e}`)}else n.id==="xp_cd:test_mine"?L.info(Nn(n.sourceEntity.location,n.sourceEntity.dimension)):n.id==="xp_cd:current_tick"?L.info("Current tick is ",ee.currentTick):n.id==="xp_cd:get_data"&&(L.info("Encounter count: ",ho),L.info("Next state: ",N[Ot]),L.info("Addon time: ",s.getAddonTime()),L.info("DwellerData: ",I))},{namespaces:["xp_cd"]});var Ka=x.getLogger("PeekThroughHole"),Ja={[ie.Down]:ie.Up,[ie.Up]:ie.Down,[ie.North]:ie.South,[ie.South]:ie.North,[ie.West]:ie.East,[ie.East]:ie.West};be.prototype[ie.Down]=be.prototype.below;be.prototype[ie.Up]=be.prototype.above;be.prototype[ie.North]=be.prototype.north;be.prototype[ie.South]=be.prototype.south;be.prototype[ie.West]=be.prototype.west;be.prototype[ie.East]=be.prototype.east;function cn(){Xa.afterEvents.playerBreakBlock.subscribe(n=>{let e=n.player.getGameMode();if(!(e===fo.creative||e===fo.spectator)&&!(s.getDweller()||n.block.y>64)&&!(Y.isOnCooldown()||!s.canEngage(n.player))&&!n.block.above()?.isAir&&!n.block.below()?.isAir&&Math.floor(n.block.location.y)===Math.floor(n.player.location.y+1)){let t=l.from(n.player.location).subtract(n.block.location).setY(0).normalize().rotate(l.Up,90).toDirection(),r=Ja[t];if(!n.block[t]().isAir&&!n.block[r]().isAir){let i=l.from(l.from(n.block.location).subtract(l.from(n.player.location).toBlockLocation()).setY(0).normalize().toDirection()).multiply(1.5).add(n.block.location).setY(n.player.location.y).add(.5,0,.5);if(!n.block.dimension.getBlock(i)?.isAir||!n.block.dimension.getBlock(i.add(0,1,0))?.isAir||!n.block.dimension.getBlock(i.add(0,2,0))?.isAir)return;let a=n.block.dimension.getBlockFromRay(i,l.Down,{maxDistance:3,includeLiquidBlocks:!0});if(Ka.info("Ray hole",a),!a||a.block.isLiquid)return;s.setDwellerTarget(n.player);let c=s.createDweller(i,"xp_cd:peek_through_hole",!1),d=l.from(n.player.location).subtract(i).setY(0).normalize().rotate(l.Up,90);c.setRotation({x:0,y:Math.atan2(d.z,d.x)*180/Math.PI}),c.addEffect("slowness",20,{amplifier:100,showParticles:!1}),yo.runTimeout(()=>{c.runCommand("playanimation @s animation.xp_cd.cave_dweller.scream_full_body")},1),yo.runTimeout(()=>{n.player.applyDamage(1,{damagingEntity:c,cause:Wa.magic});try{c.setProperty("xp_cd:hole_peeking",!1)}catch{}s.setState(3)},20)}}})}import{system as Za}from"@minecraft/server";function dn(){Za.runInterval(()=>{let n=s.getDwellerTarget();if(!n)return;let e=s.getDweller();e&&(l.from(n.location).distanceSquared(e.location)>100||n.startItemCooldown("shield",100))},20)}import{BlockInventoryComponent as wo,EntityItemComponent as Qa,StructureSaveMode as es,system as bo,world as ts}from"@minecraft/server";var un=x.getLogger("StealItems"),bt=ts.structureManager,hr="xp_cd:dweller_chest";function pn(){s.dwellerEvents.killedPlayer.subscribe(n=>{if(!n.isDead)return;let e=l.from(n.player.location),t=n.player.dimension,r=vo(e,t);if(r===void 0){un.debug("No chest found");return}let i=r.getComponent(wo.componentId).container;if(!i){_r(r);return}bo.runTimeout(()=>{let a=t.getEntities({location:e,maxDistance:6,type:"minecraft:item"});if(a.length===0){_r(r);return}for(let c of a){if(Math.random()>=.25)continue;if(i.emptySlotsCount===0)break;let d=c.getComponent(Qa.componentId).itemStack;i.addItem(d),c.remove()}ko(r),_r(r)},2)}),s.dwellerEvents.die.subscribe(n=>{if(n.isNaturalDeath||bt.get(hr)===void 0)return;let t=n.dweller.dimension,r=l.from(n.dweller.location),i=r.add(0,1.5,0),a=ri(t,r,Math.floor(Math.random()*3)+1);bo.runTimeout(()=>{for(let c of a)t.spawnItem(c,i)},1)})}function vo(n,e){let t=0,r=!0,i=l.from(n).setY(e.heightRange.max-t*5-1);for(;r;){let a;try{a=e.getBlock(i)}catch(c){un.warn("Failed to get block",c);continue}if(a!==void 0&&a.isAir){let c=bt.get(hr);return c?bt.place(c,e,i):a.setPermutation(R("minecraft:chest")),a}t<=5?(t++,i=i.setY(e.heightRange.max-t*5)):r=!1}}function ko(n){let e=bt.get(hr);e&&bt.delete(e),bt.createFromWorld(hr,n.dimension,n.location,n.location,{includeBlocks:!0,includeEntities:!1,saveMode:es.World})}function _r(n){n.dimension.runCommandAsync(`setblock ${n.location.x} ${n.location.y} ${n.location.z} air replace`)}function ri(n,e,t){if(bt.get(hr)===void 0)return[];let i=vo(e,n);if(i===void 0)return un.debug("No chest found"),[];let a=i.getComponent(wo.componentId).container;if(!a)return _r(i),[];t===void 0?t=(a.size-a.emptySlotsCount)/2:t=Math.min(t,a.size-a.emptySlotsCount);let c=[];for(let d=0;d<a.size&&!(a.emptySlotsCount===a.size||c.length>=t);d++){let m=a.getItem(d);m!==void 0&&(c.push(m),a.setItem(d))}return ko(i),_r(i),c}import{EntityComponentTypes as rs,EquipmentSlot as it,Player as is}from"@minecraft/server";var mn=!1,ns=x.getLogger("FakeAttack");function _n(){s.dwellerEvents.spawn.subscribe(()=>{let n=Math.random();ns.trace("Dweller spawned, random: ",n,", chance: ",.5),mn=n<.5}),s.dwellerEvents.attack.subscribe(n=>{if(!(n.entity instanceof is))return;let e=n.entity;s.getState()!==3||!mn||os(e)&&(n.cancel=!0,mn=!1)})}function wt(n,e,t){let r=e.getEquipment(t);if(r&&r.typeId.length>0&&r.typeId!=="minecraft:air"){let i=l.from(n.getHeadLocation()),a=l.from(n.getViewDirection()).normalize(),c=n.dimension.getBlockFromRay(i,a,{maxDistance:5,includePassableBlocks:!1,includeLiquidBlocks:!1}),d;return c?d=l.from(c.block.location).add(c.faceLocation).subtract(a.multiply(.5)):d=i.add(a.multiply(5)),n.dimension.spawnItem(r,d),n.playSound("random.break",{location:d}),e.setEquipment(t),!0}return!1}function os(n){let e=n.getComponent(rs.Equippable);if(e){let t=e.getEquipment(it.Offhand);if(t&&t.typeId.length>0&&t.typeId==="minecraft:totem_of_undying"&&wt(n,e,it.Offhand)||wt(n,e,it.Mainhand)||wt(n,e,it.Offhand)||wt(n,e,it.Head)||wt(n,e,it.Chest)||wt(n,e,it.Legs)||wt(n,e,it.Feet))return!0}return!1}import{system as as}from"@minecraft/server";var ss="xp_cd:vertical_space",ls="xp_cd:tight_space_axis",cs="xp_cd:target_distance_squared",hn=3,gr=0,ds=0;function gn(){s.dwellerEvents.spawn.subscribe(()=>{hn=3,gr=0}),as.runInterval(()=>{let n=s.getDweller();if(!n)return;let e=n.dimension,t=l.from(n.location),r=e.getBlockFromRay(t.add(0,.1,0),l.Up,{includePassableBlocks:!1,includeLiquidBlocks:!1,maxDistance:4}),i=3;r&&r.block&&(i=Math.min(3,Math.max(1,Math.round(r.block.y-n.location.y)))),hn!==i&&(hn=i,n.setProperty(ss,i));let a=0,c=[[!1,!1,!1],[!1,!1,!1],[!1,!1,!1]];for(let D=-1;D<=1;D++)for(let C=-1;C<=1;C++){if(D===0&&C===0)continue;let A;try{A=e.getBlock(t.add(D,.1,C))}catch{continue}A&&!A.isAir&&!A.isLiquid&&(c[D+1][C+1]=!0,a++)}a>4?!c[0][1]&&!c[2][1]?a=1:!c[1][0]&&!c[1][2]?a=2:gr!==0?a=gr:a=1:a=0,gr!==a&&(n.setProperty(ls,a),gr=a);let d=s.getDwellerTarget();if(!d)return;let m=l.from(d.location),k=l.from(n.location).setY(0).distanceSquared(m.setY(0));if(ds!==k){if(k>4096)return;n.setProperty(cs,k)}},1)}import{EntityDamageCause as us}from"@minecraft/server";function fn(){s.dwellerEvents.hurt.subscribe(n=>{let e=n.damager;if(!e)return;let t=n.dweller;if(!t)return;let r=t.dimension,i=l.from(t.location);for(let c=-1;c<=1;c++)for(let d=-1;d<=1;d++){let m=r.getBlockFromRay(i.add(c*.5,.5,d*.5),l.Up,{includePassableBlocks:!1,includeLiquidBlocks:!1,maxDistance:4});if(!m)continue;if(l.from(m.block.location).distanceSquared(i)>12)return;if(m.block.north()?.isAir){nt(e,l.South);return}if(m.block.south()?.isAir){nt(e,l.North);return}if(m.block.east()?.isAir){nt(e,l.East);return}if(m.block.west()?.isAir){nt(e,l.West);return}}let a=r.getBlock(e.location);if(a&&a.typeId==="minecraft:ladder")switch(a.permutation.getState("facing_direction")){case 2:nt(e,l.South);break;case 3:nt(e,l.North);break;case 4:nt(e,l.West);break;case 5:nt(e,l.East);break}})}function nt(n,e){n.applyImpulse(e.multiply(1.5).setY(.5)),n.applyDamage(3,{cause:us.magic,damagingEntity:n})}import{world as To}from"@minecraft/server";import{system as ps}from"@minecraft/server";var ms=10,_s=20*45;function yn(){let n=x.getLogger("JumpDown");ps.runInterval(()=>{if(Zn()>0||s.getState()!==3)return;let e=s.getDweller();if(!e||s.isOnCeiling()||!s.isAttacking())return;let t=s.getDwellerTarget();if(!t)return;let r=l.from(t.location),i=l.from(e.location);if(i.y-1<=r.y||i.distanceSquared(r)<25)return;let a=r.subtract(i).divide(10).multiply(1/.4).setY(.25);a&&(Xr(_s),e.isOnGround&&e.applyImpulse(a),n.info("Jump down"))},ms)}import{system as hs}from"@minecraft/server";function Do(){hs.runInterval(()=>{let n=s.getDweller();if(n)for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)for(let r=0;r<=2;r++)n.runCommandAsync(`/execute positioned ~${e} ~${r} ~${t} if block ~ ~ ~ web run setblock ~ ~ ~ air destroy`)},20)}import{system as gs}from"@minecraft/server";function xo(){gs.runInterval(()=>{let n=s.getDweller();if(!n)return;let e=[...n.dimension.getEntities({type:"minecraft:boat",location:n.location,maxDistance:2}),...n.dimension.getEntities({type:"minecraft:minecart",location:n.location,maxDistance:2})];for(let t of e)t.kill()},20)}import{ItemStack as fs,system as ys,world as bs}from"@minecraft/server";var Eo=[...Array.from({length:14},(n,e)=>({from:`xp_cd:torch_${e}`,to:"minecraft:torch"})),...Array.from({length:11},(n,e)=>({from:`xp_cd:soul_torch_${e}`,to:"minecraft:soul_torch"})),{from:"xp_cd:dweller_skull.block",to:"xp_cd:cave_dweller_skull"},{from:"xp_cd:hanging_tissue.block",to:"xp_cd:hanging_tissue"}],ws=x.getLogger("ItemAssociation",["Item Association"]);function vs(n,e="all"){let t=[],r=n.getComponent("inventory");if(!r)return!1;let i=r.container;for(let a=0;a<i.size;a++){let c=i.getItem(a);e==="all"?t.push({item:c,slot:a}):c?.typeId.includes(e)&&t.push({item:c,slot:a})}return t}function ks(n){let e=vs(n);if(e.length===0)return;let t=e.filter(i=>Eo.some(a=>i?.item?.typeId===a.from));if(t.length===0)return;let r=n.getComponent("inventory").container;t.forEach(i=>{let a=Eo.find(c=>i?.item?.typeId===c.from);a&&r.setItem(i.slot,new fs(a.to,i?.item?.amount))}),ws.info(`${n.name} - found ${t.length} items: ${t.map(i=>i?.item?.typeId).join(", ")}`)}function So(){ys.runInterval(()=>{bs.getAllPlayers().forEach(n=>{ks(n)})},4)}import{Direction as ot,MolangVariableMap as xs,system as ii,world as fr}from"@minecraft/server";var bn=x.getLogger("Blocks");var vt=class{constructor(){this.onTick=this.onTick.bind(this),this.onPlace=this.onPlace.bind(this)}onTick(e){this.spawnParticles(e.block)}onPlace(e){this.spawnParticles(e.block)}spawnParticles(e){let t=e.permutation.getAllStates(),r=this.getVariables(t),i=e.dimension;t["minecraft:block_face"]==="up"?(r.setFloat("xp_cd_is_on_wall",0),i.spawnParticle("xp_cd:skull_eyes",e.center(),r),i.spawnParticle("xp_cd:skull_eyes.glow",e.center(),r)):(r.setFloat("xp_cd_is_on_wall",1),i.spawnParticle("xp_cd:skull_eyes.wall",e.center(),r),i.spawnParticle("xp_cd:skull_eyes.wall.glow",e.center(),r))}getVariables(e){let t=new xs;switch(e["minecraft:cardinal_direction"]){case"west":t.setFloat("xp_cd_facing",1);break;case"south":t.setFloat("xp_cd_facing",2);break;case"east":t.setFloat("xp_cd_facing",3);break;default:t.setFloat("xp_cd_facing",0);break}return t}};o(vt,"log",x.getLogger("SkullBlockComponent")),o(vt,"componentId","xp_cd:dweller_skull_block");var Gt=class{constructor(){o(this,"blockId","xp_cd:bone_pile");this.beforeOnPlayerPlace=this.beforeOnPlayerPlace.bind(this),this.onPlayerDestroy=this.onPlayerDestroy.bind(this)}beforeOnPlayerPlace(e){e.permutationToPlace=R(this.blockId,{"xp_cd:geo":Math.floor(Math.random()*3),"xp_cd:rotation":Math.floor(Math.random()*4)})}onPlayerDestroy(e){bn.info("Bone pile destroyed")}};o(Gt,"componentId","xp_cd:bone_pile");var Vt=class{constructor(){o(this,"blockId","xp_cd:dweller_pellet");o(this,"pelletTag","xp_cd_pellet");o(this,"destroyPropertyId","xp_cd:pellet_destroyed");this.beforeOnPlayerPlace=this.beforeOnPlayerPlace.bind(this),this.onPlayerDestroy=this.onPlayerDestroy.bind(this)}beforeOnPlayerPlace(e){e.permutationToPlace=R(this.blockId,{"xp_cd:geo":Math.floor(Math.random()*2),"xp_cd:rotation":Math.floor(Math.random()*4),"xp_cd:has_items":e.player&&e.player.hasTag(this.pelletTag)?1:0})}onPlayerDestroy(e){if(bn.info("Dweller pellet destroyed"),e.destroyedBlockPermutation.getState("xp_cd:has_items")===0||!e.player)return;let r,i=fr.getDynamicProperty(this.destroyPropertyId)??!1;i?r=ri(e.dimension,l.from(e.block.location),9999):r=ri(e.dimension,l.from(e.block.location)),fr.setDynamicProperty(this.destroyPropertyId,!i);let a=l.from(e.block.center()).add(0,.5,0);r.forEach(c=>{e.dimension.spawnItem(c,a)})}};o(Vt,"componentId","xp_cd:dweller_pellet");var kt=class{constructor(){o(this,"blockId","xp_cd:hanging_tissue.block");o(this,"placeableBlocks",["xp_cd:clotted_tissue","xp_cd:popped_abscess","xp_cd:tangled_tissue","xp_cd:writhing_mass","xp_cd:hanging_tissue.block"]);this.beforeOnPlayerPlace=this.beforeOnPlayerPlace.bind(this),this.onPlayerDestroy=this.onPlayerDestroy.bind(this),ii.run(()=>{fr.afterEvents.playerBreakBlock.subscribe(this.neighbourBreakTranslate.bind(this),{blockTypes:this.placeableBlocks.filter(e=>e!==this.blockId)})})}beforeOnPlayerPlace(e){let t=e.block.above(),r=e.block.below();if(e.face===ot.Up&&(!r||!this.placeableBlocks.includes(r.typeId))||e.face===ot.Down&&(!t||!this.placeableBlocks.includes(t.typeId))){e.cancel=!0;return}if(e.face===ot.Up){if(t&&t.typeId===this.blockId){let i=t.permutation.getState("xp_cd:hanging_part");i&&i===2&&t.setPermutation(R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":0})),r&&r.typeId===this.blockId?e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":1}):e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":0})}else!t||!this.placeableBlocks.includes(t.typeId)?e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":1}):e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":1});if(r&&r.typeId===this.blockId){let i=r.permutation.getState("xp_cd:hanging_part");if(i&&i===2){let a=r.below();a&&a.typeId===this.blockId?r.setPermutation(R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":0})):r.setPermutation(R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":1}))}}return}else{if(r&&r.typeId===this.blockId){let i=r.permutation.getState("xp_cd:hanging_part");i&&i===2&&r.setPermutation(R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":0})),t&&t.typeId===this.blockId?e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":1}):e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":0})}else!r||!this.placeableBlocks.includes(r.typeId)?e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":0}):e.permutationToPlace=R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":0});if(t&&t.typeId===this.blockId){let i=t.permutation.getState("xp_cd:hanging_part");if(i&&i===2){let a=t.above();a&&a.typeId===this.blockId?t.setPermutation(R(this.blockId,{"xp_cd:hanging_part":1,"xp_cd:is_reversed":0})):t.setPermutation(R(this.blockId,{"xp_cd:hanging_part":0,"xp_cd:is_reversed":1}))}}}}onPlayerDestroy(e){bn.info("Hanging tissue destroyed");let t=e.block,r=t.above(),i=t.below();r&&r.typeId===this.blockId&&(this.destroy(r,ot.Up)||r.setPermutation(R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":0}))),i&&i.typeId===this.blockId&&(this.destroy(i,ot.Down)||i.setPermutation(R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":1})))}neighbourBreakTranslate(e){let t=e.block.above(),r=e.block.below();t&&t.typeId===this.blockId&&(this.destroy(t,ot.Up)||t.setPermutation(R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":0}))),r&&r.typeId===this.blockId&&(this.destroy(r,ot.Down)||r.setPermutation(R(this.blockId,{"xp_cd:hanging_part":2,"xp_cd:is_reversed":1})))}destroy(e,t,r=0){if(r>80)return!1;let i;return t===ot.Up?i=e.above():i=e.below(),!i||!this.placeableBlocks.includes(i.typeId)?(ii.runTimeout(()=>{e.dimension.runCommand(`/setblock ${l.from(e.location).toString("short"," ")} air destroy`)},r*1),!0):i.typeId===this.blockId&&this.destroy(i,t,r+1)?(ii.runTimeout(()=>{e.dimension.runCommand(`/setblock ${l.from(e.location).toString("short"," ")} air destroy`)},r+1),!0):!1}};o(kt,"componentId","xp_cd:hanging_tissue"),o(kt,"log",x.getLogger("HangingTissueComponent"));var qt=class{constructor(){o(this,"blockId","xp_cd:writhing_mass");o(this,"placeableBlocks",["xp_cd:clotted_tissue","xp_cd:tangled_tissue","xp_cd:hanging_tissue.block"]);this.beforeOnPlayerPlace=this.beforeOnPlayerPlace.bind(this),this.onRandomTick=this.onRandomTick.bind(this),ii.run(()=>{fr.afterEvents.playerBreakBlock.subscribe(this.updateNeighbourBlock.bind(this),{blockTypes:this.placeableBlocks}),fr.afterEvents.playerPlaceBlock.subscribe(this.updateNeighbourBlock.bind(this),{blockTypes:this.placeableBlocks})})}beforeOnPlayerPlace(e){e.permutationToPlace=this.getAdjPermutation(e.block,e.permutationToPlace)}onRandomTick(e){let t=e.block.below();(!t||t.isAir)&&e.block.dimension.spawnParticle(Math.random()>.5?"xp_cd:dweller.block.drip":"xp_cd:dweller.block.droplet",e.block.bottomCenter())}getAdjPermutation(e,t){return[e.north(),e.east(),e.south(),e.west(),e.above(),e.below()].some(i=>i&&this.placeableBlocks.includes(i.typeId))?R(this.blockId,{"xp_cd:is_adjacent":1,"xp_cd:x_rot":Math.floor(Math.random()*2),"xp_cd:y_rot":Math.floor(Math.random()*4)}):R(this.blockId,{"xp_cd:is_adjacent":0,"xp_cd:x_rot":Math.floor(Math.random()*2),"xp_cd:y_rot":Math.floor(Math.random()*4)})}updateNeighbourBlock(e){let t=e.block;[t.north(),t.east(),t.south(),t.west(),t.above(),t.below()].forEach(i=>{if(i&&i.typeId===this.blockId){i.setPermutation(this.getAdjPermutation(i,i.permutation));return}})}};o(qt,"componentId","xp_cd:writhing_mass");var Ht=class{constructor(){this.beforeOnPlayerPlace=this.beforeOnPlayerPlace.bind(this),this.onRandomTick=this.onRandomTick.bind(this)}beforeOnPlayerPlace(e){e.permutationToPlace=this.getAdjPermutation(e.permutationToPlace)}getAdjPermutation(e){return R(e.type.id,{"xp_cd:x_rot":Math.floor(Math.random()*2),"xp_cd:y_rot":Math.floor(Math.random()*4)})}onRandomTick(e){let t=e.block.below();(!t||t.isAir)&&e.block.dimension.spawnParticle(Math.random()>.5?"xp_cd:dweller.block.drip":"xp_cd:dweller.block.droplet",e.block.bottomCenter())}};o(Ht,"componentId","xp_cd:randomized_rotation");var Es=ft.getInstance();Tn.installPlayer();x.setLevel(Ce.Debug);cn();tn();yn();ln();dn();He.init();Q.init();no();Fe.init();pn();_n();gn();ke.init();s.init();Y.init();fn();Do();xo();So();Es.init();Kr.init();To.afterEvents.playerSpawn.subscribe(n=>{n.player.hasTag("xp_cd:guidebook")||(n.player.runCommand("/structure load xp_cd:guidebook ~ ~ ~"),n.player.addTag("xp_cd:guidebook"))});To.beforeEvents.worldInitialize.subscribe(n=>{n.blockComponentRegistry.registerCustomComponent(Ct.componentId,new Ct),n.blockComponentRegistry.registerCustomComponent(vt.componentId,new vt),n.blockComponentRegistry.registerCustomComponent(Gt.componentId,new Gt),n.blockComponentRegistry.registerCustomComponent(kt.componentId,new kt),n.blockComponentRegistry.registerCustomComponent(Vt.componentId,new Vt),n.blockComponentRegistry.registerCustomComponent(qt.componentId,new qt),n.blockComponentRegistry.registerCustomComponent(Ht.componentId,new Ht),n.itemComponentRegistry.registerCustomComponent(pr.componentId,new pr)});x.setLevel(Ce.Off);
